<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó•ÊúàÊΩ≠ÊóÖË°åÊâãÂÜä | 8/8-8/10</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: #5d4e37;
            background: linear-gradient(135deg, #faf6f0 0%, #f5ede1 50%, #f0e6d6 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(252, 248, 240, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(139, 115, 85, 0.15);
            border: 1px solid rgba(222, 184, 135, 0.3);
        }

        .header h1 {
            color: #8b7355;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .date {
            color: #a0956b;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4b896 0%, #c9a876 100%);
            color: #5d4e37;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #c9a876 0%, #be9d66 100%);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #b8c5a6 0%, #a8b596 100%);
            color: #4a5d3a;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #a8b596 0%, #98a586 100%);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #e6c2a6 0%, #dbb896 100%);
            color: #6b4423;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #dbb896 0%, #d0ad86 100%);
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #c8b5a6 0%, #bda896 100%);
            color: #5d4e37;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #bda896 0%, #b29d86 100%);
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        /* È†ÅÈù¢ÂàáÊèõ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* ÊâìÂåÖÊ∏ÖÂñÆÈ†ÅÈù¢Ê®£Âºè */
        .packing-page {
            background: rgba(252, 248, 240, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(139, 115, 85, 0.15);
            border: 1px solid rgba(222, 184, 135, 0.3);
        }
        
        .packing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(212, 184, 150, 0.4);
        }
        
        .packing-header h2 {
            font-size: 1.8em;
            color: #8b7355;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .packing-header h2:before {
            content: 'üéí';
            font-size: 1.2em;
            margin-right: 5px;
        }
        
        .packing-actions {
            display: flex;
            gap: 12px;
        }
        
        .packing-actions .btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .packing-actions .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .packing-progress {
            margin-bottom: 30px;
        }
        
        .progress-bar-container {
            height: 24px;
            background-color: #f5ede1;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(139, 115, 85, 0.15), 0 1px 2px rgba(252, 248, 240, 0.8);
            position: relative;
            border: 1px solid rgba(222, 184, 135, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease, background-color 0.5s ease;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
            animation: progress-bar-stripes 2s linear infinite;
        }
        
        @keyframes progress-bar-stripes {
            from { background-position: 40px 0; }
            to { background-position: 0 0; }
        }
        
        .progress-text {
            text-align: center;
            font-size: 15px;
            color: #8b7355;
            font-weight: 600;
            margin-top: 8px;
            text-shadow: 0 1px 1px rgba(252, 248, 240, 0.8);
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .progress-text::before {
            content: 'üìã';
            font-size: 16px;
            margin-right: 2px;
        }
        
        .category-container {

            margin-bottom: 20px;
            border: 1px solid rgba(222, 184, 135, 0.4);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(139, 115, 85, 0.08);
            transition: all 0.3s ease;
        }
        
        .category-container:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f5ede1;
            background-image: linear-gradient(to right, #f5ede1, #f0e6d6);
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(222, 184, 135, 0.4);
            box-shadow: 0 1px 2px rgba(139, 115, 85, 0.05);
        }
        
        .category-header:hover {
            background-color: #f0e6d6;
            background-image: linear-gradient(to right, #f0e6d6, #ebe1d1);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(139, 115, 85, 0.08);
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: bold;
            font-size: 16px;
            color: #8b7355;
            text-shadow: 0 1px 0 rgba(252, 248, 240, 0.8);
        }
        
        .category-status {
            font-size: 14px;
            color: #a0956b;
            background-color: rgba(240, 230, 214, 0.8);
            padding: 4px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(139, 115, 85, 0.08);
        }
        
        .category-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .category-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 50% 50% 0 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
        }
        
        .category-items {
            padding: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .category-items.expanded {
            max-height: 1000px;
        }
        
        .packing-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: #faf8f4;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(139, 115, 85, 0.12), 0 1px 2px rgba(139, 115, 85, 0.06);
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .packing-item:hover {
            box-shadow: 0 3px 8px rgba(139, 115, 85, 0.18), 0 2px 4px rgba(139, 115, 85, 0.12);
            transform: translateY(-2px);
            border-left: 3px solid #d4b896;
        }
        
        .packing-item input[type="checkbox"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            border-radius: 4px;
            border: 2px solid #d4b896;
            position: relative;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #faf8f4;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .packing-item input[type="checkbox"]:checked {
            background-color: #d4b896;
            border-color: #d4b896;
        }
        
        .packing-item input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .packing-item label {
            flex: 1;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            padding: 2px 0;
            color: #8b7355;
            font-weight: 500;
        }
        
        .packing-item input[type="checkbox"]:checked + label {
            text-decoration: line-through;
            color: #a0956b;
            font-weight: 400;
            opacity: 0.8;
            transform: translateX(3px);
        }
        
        .delete-item {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.5;
            transition: all 0.3s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: #e74c3c;
            margin-left: 5px;
        }
        
        .delete-item:hover {
            opacity: 1;
            background-color: rgba(231, 76, 60, 0.1);
            transform: scale(1.1);
        }
        
        .delete-item:active {
            transform: scale(0.95);
        }
        
        .add-item-form {
            margin-top: 20px;
            padding: 25px;
            background-color: rgba(250, 245, 235, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(139, 115, 85, 0.12), 0 2px 5px rgba(139, 115, 85, 0.08);
            border: 1px solid rgba(212, 184, 150, 0.3);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .add-item-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #d4b896, #b8c5a6);
        }
        
        .add-item-form .btn {
            background-image: linear-gradient(to right, #d4b896, #c9a876);
            color: #5d4e37;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(212, 184, 150, 0.3);
        }
        
        .add-item-form .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,0.3), rgba(255,255,255,0));
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .add-item-form .btn:hover {
            background-image: linear-gradient(to right, #c9a876, #be9d66);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(212, 184, 150, 0.4);
        }
        
        .add-item-form .btn:hover::after {
            transform: translateX(100%);
        }
        
        .add-item-form .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(212, 184, 150, 0.3);
        }
        
        .add-item-form .btn-cancel {
            background-image: linear-gradient(to right, #d4a574, #c99964);
            color: #6b4423;
            box-shadow: 0 4px 10px rgba(212, 165, 116, 0.3);
        }
        
        .add-item-form .btn-cancel:hover {
            background-image: linear-gradient(to right, #c99964, #be8e54);
            box-shadow: 0 6px 15px rgba(212, 165, 116, 0.4);
        }
        
        .add-item-form .btn-cancel:active {
            box-shadow: 0 3px 8px rgba(212, 165, 116, 0.3);
        }
        
        .add-item-form.visible {
            animation: fadeInDown 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
        
        @keyframes fadeInDown {
            0% {
                opacity: 0;
                transform: translateY(-30px) scale(0.97);
                box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), 0 2px 5px rgba(0, 0, 0, 0.05);
            }
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 18px;
            align-items: center;
            position: relative;
        }
        
        .form-row label {
            font-weight: 500;
            color: #8b7355;
            min-width: 80px;
            letter-spacing: 0.3px;
        }
        
        .form-row input, .form-row select {
            padding: 12px 16px;
            border: 1px solid rgba(222, 184, 135, 0.3);
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(139, 115, 85, 0.05), 0 1px 2px rgba(252, 248, 240, 0.8);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 15px;
            background-color: rgba(250, 248, 244, 0.9);
            color: #8b7355;
        }
        
        .form-row input::placeholder, .form-row select::placeholder {
            color: #a0956b;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .form-row input:focus::placeholder, .form-row select:focus::placeholder {
            opacity: 0.5;
        }
        
        .form-row input:focus, .form-row select:focus {
            border-color: #d4b896;
            box-shadow: inset 0 1px 3px rgba(212, 184, 150, 0.15), 0 0 0 3px rgba(212, 184, 150, 0.2);
            outline: none;
            background-color: #faf8f4;
            transform: translateY(-1px);
        }
        
        .form-row input {
            flex: 1;
        }
        
        .form-row select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24'%3E%3Cpath fill='%23d4b896' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }
        
        .form-row select:hover {
            border-color: #c9a876;
        }
        
        .back-to-main {
            margin-top: 20px;
            text-align: center;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à - Âπ≥ÊùøÂíåÊâãÊ©ü */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .quick-actions {
                gap: 10px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 13px;
            }
            
            .activity {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .activity-links {
                gap: 8px;
            }
            
            .link-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            /* ÁâπÊñØÊãâÊåâÈàïÈüøÊáâÂºèÂÑ™Âåñ */
            .tesla-btn {
                width: 36px !important;
                height: 28px !important;
                min-width: 36px;
            }
            
            .tesla-btn img {
                width: 16px !important;
                height: 16px !important;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .header .date {
                font-size: 1em;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 250px;
            }
            
            .activity-time {
                font-size: 1em;
            }
            
            .activity-title {
                font-size: 1.1em;
            }
            
            .activity-links {
                justify-content: flex-start;
            }
            
            /* Â∞èËû¢ÂπïÁâπÊñØÊãâÊåâÈàïÂÑ™Âåñ */
            .tesla-btn {
                width: 32px !important;
                height: 26px !important;
                min-width: 32px;
            }
            
            .tesla-btn img {
                width: 14px !important;
                height: 14px !important;
            }
            
            .link-btn {
                 padding: 5px 10px;
                 font-size: 10px;
             }
             
             /* Ëß∏ÊéßÂÑ™Âåñ */
             .activity-links {
                 margin-top: 10px;
             }
             
             .btn {
                 min-height: 44px; /* iOS Âª∫Ë≠∞ÁöÑÊúÄÂ∞èËß∏ÊéßÁõÆÊ®ô */
             }
         }
         
         /* ÈÄöÁî®ÁâπÊñØÊãâÊåâÈàïÊ®£Âºè */
         .tesla-btn {
             transition: all 0.3s ease;
             border-radius: 6px;
         }
         
         .tesla-btn:hover {
             background: #c0392b !important;
             transform: translateY(-1px);
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
         }
         
         .tesla-btn:active {
             transform: translateY(0);
         }
         
         /* È´òËß£ÊûêÂ∫¶Ëû¢ÂπïÂÑ™Âåñ */
         @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
             .tesla-btn img {
                 image-rendering: -webkit-optimize-contrast;
                 image-rendering: crisp-edges;
             }
         }

        .itinerary-section {
            background: rgba(252, 248, 240, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(139, 115, 85, 0.15);
            border: 1px solid rgba(222, 184, 135, 0.3);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background: rgba(252, 248, 240, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(139, 115, 85, 0.15);
            border: 1px solid rgba(222, 184, 135, 0.3);
        }

        .day-tab {
            display: flex;
            margin-bottom: 30px;
            background: #f0e6d6;
            border-radius: 10px;
            padding: 5px;
        }

        .day-tab button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .day-tab button.active {
            background: #d4b896;
            color: #5d4e37;
        }

        .day-content {
            display: none;
        }

        .day-content.active {
            display: block;
        }

        .activity {
            background: #faf8f4;
            border-left: 4px solid #d4b896;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
            position: relative;
        }

        .activity-time {
            font-weight: bold;
            color: #5d4e37;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .activity-title {
            font-size: 1.2em;
            color: #6b5b47;
            margin-bottom: 10px;
        }

        .activity-details {
            color: #8b7355;
            margin-bottom: 15px;
        }

        .activity-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .link-btn {
            padding: 8px 16px;
            background: #d4b896;
            color: #5d4e37;
            text-decoration: none;
            border-radius: 20px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .link-btn:hover {
            background: #c9a876;
            transform: translateY(-1px);
        }

        .discussion-section {
            margin-top: 30px;
        }

        .comment-form {
            background: #faf8f4;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }

        .comment-form input,
        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #deb887;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: inherit;
            background: #fcf8f0;
            color: #5d4e37;
        }

        .comment-form textarea {
            height: 100px;
            resize: vertical;
        }

        .comments-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .comment {
            background: #fcf8f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 3px solid #d4b896;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: bold;
            color: #5d4e37;
        }

        .comment-time {
            color: #8b7355;
            font-size: 0.9em;
        }

        .update-form {
            background: #faf8f4;
            border: 1px solid #deb887;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .update-form h3 {
            color: #5d4e37;
            margin-bottom: 15px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #f5e6d3, #e8d5b7);
            color: #5d4e37;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(212, 165, 116, 0.3), 0 0 0 1px rgba(222, 184, 135, 0.2) inset;
            transform: translateX(400px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            font-weight: 500;
            display: flex;
            align-items: center;
            max-width: 350px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(222, 184, 135, 0.3);
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        .notification:before {
            content: '‚úì';
            margin-right: 12px;
            font-size: 1.2em;
            background: rgba(212, 165, 116, 0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(212, 165, 116, 0.2);
        }

        .notification.error {
            background: linear-gradient(135deg, #f4e4d6, #e8d5b7);
            border-left: 4px solid #d4a574;
            color: #8b4513;
        }

        .notification.error:before {
            content: '‚úï';
            background: rgba(212, 165, 116, 0.3);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f5e6d3, #e8d5b7);
            border-left: 4px solid #deb887;
            color: #8b7355;
        }

        .notification.warning:before {
            content: '‚ö†';
            background: rgba(222, 184, 135, 0.3);
        }

        .notification.show {
            transform: translateX(0);
            animation: notification-pulse 0.5s ease;
        }

        @keyframes notification-pulse {
            0% { transform: translateX(0) scale(0.95); opacity: 0.7; }
            50% { transform: translateX(0) scale(1.05); opacity: 1; }
            100% { transform: translateX(0) scale(1); }
        }
        
        @media (max-width: 768px) {
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
                padding: 12px 20px;
                font-size: 14px;
            }
        }

        .weather-widget {
            text-align: center;
            padding: 20px;
        }
        
        .weather-header {
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .weather-header:hover {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }
        
        .weather-toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .weather-details-container {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .weather-summary {
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .weather-summary.show {
            opacity: 1;
            animation: fadeInUp 0.3s ease forwards;
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .weather-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .weather-content {
            text-align: left;
        }
        
        .weather-location {
            font-size: 1.1em;
            font-weight: bold;
            color: #5d4e37;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .weather-temp {
            font-size: 1.3em;
            font-weight: bold;
            color: #d4b896;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .weather-condition {
            font-size: 1em;
            color: #8b7355;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .weather-details {
            background: #faf8f4;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }
        
        .weather-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .weather-detail-item:last-child {
            margin-bottom: 0;
        }
        
        .forecast-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #faf8f4;
            border-radius: 6px;
            font-size: 0.85em;
            border: 1px solid rgba(222, 184, 135, 0.2);
        }
        
        .forecast-date {
            font-weight: bold;
            color: #5d4e37;
            min-width: 60px;
        }
        
        .forecast-icon {
            font-size: 1.2em;
            margin: 0 8px;
        }
        
        .forecast-temp {
            color: #d4b896;
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }
        
        .weather-loading {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .checklist {
            list-style: none;
        }

        .checklist li {
            padding: 10px 0;
            border-bottom: 1px solid #f0e6d6;
            display: flex;
            align-items: center;
        }

        .checklist input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .emergency-contact {
            background: #faf8f4;
            border: 1px solid #deb887;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .emergency-contact h4 {
            color: #8b4513;
            margin-bottom: 10px;
        }

        .activity-discussion {
            margin-top: 15px;
            padding: 15px;
            background: #faf8f4;
            border-radius: 8px;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }

        .activity-comment-form {
            margin-bottom: 15px;
        }

        .activity-comment-form input,
        .activity-comment-form textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #deb887;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: inherit;
            font-size: 14px;
            background: #fcf8f0;
            color: #5d4e37;
        }

        .activity-comment-form textarea {
            height: 60px;
            resize: vertical;
        }

        .activity-comments {
            max-height: 200px;
            overflow-y: auto;
        }

        .activity-comment {
            background: #fcf8f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 2px solid #d4b896;
            font-size: 14px;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }

        .activity-comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .activity-comment-author {
            font-weight: bold;
            color: #5d4e37;
            font-size: 13px;
        }

        .activity-comment-time {
            color: #8b7355;
            font-size: 12px;
        }

        .activity-comment-text {
            color: #6b5b47;
            line-height: 1.4;
        }

        /* Êú™ËÆÄÁïôË®ÄÊåáÁ§∫Âô®ÂãïÁï´ */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .unread-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
            animation: pulse 2s infinite;
            z-index: 10;
        }
        
        /* ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊ®£Âºè */
        .confirmation-card {
            background: rgba(252, 248, 240, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(139, 115, 85, 0.15);
            margin-bottom: 20px;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }
        
        .confirmation-item {
            background: #faf8f4;
            border-left: 4px solid #d4b896;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }
        
        .confirmation-item.confirmed {
            border-left: 4px solid #8fbc8f;
            opacity: 0.7;
        }
        
        .confirmation-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .confirmation-item-title {
            font-weight: bold;
            color: #5d4e37;
            font-size: 1.1em;
        }
        
        .confirmation-item-status {
            font-size: 0.9em;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
        }
        
        /* ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË®éË´ñÂçÄÊ®£Âºè */
         .confirmation-discussion {
             background: #faf8f4;
             border-radius: 8px;
             margin-top: 10px;
             overflow: hidden;
             transition: all 0.3s ease;
             border: 1px solid rgba(222, 184, 135, 0.3);
         }
         
         .confirmation-comment-form {
             margin-bottom: 15px;
         }
         
         .confirmation-comment-form textarea {
             width: 100%;
             padding: 8px;
             border: 1px solid #deb887;
             border-radius: 5px;
             margin-bottom: 10px;
             font-family: inherit;
             font-size: 14px;
             resize: vertical;
             min-height: 60px;
             background: #fcf8f0;
             color: #5d4e37;
         }
         
         .confirmation-comments {
             max-height: 300px;
             overflow-y: auto;
             padding-right: 5px;
         }
         
         .confirmation-comment {
             background: #fcf8f0;
             border-radius: 5px;
             margin-bottom: 10px;
             font-size: 14px;
             transition: all 0.3s ease;
             border: 1px solid rgba(222, 184, 135, 0.3);
         }
         
         .confirmation-reply-form {
             margin-top: 5px;
             margin-bottom: 10px;
         }
         
         .confirmation-reply-form textarea {
             width: 100%;
             padding: 6px;
             border: 1px solid #deb887;
             border-radius: 4px;
             font-family: inherit;
             font-size: 13px;
             resize: vertical;
             min-height: 50px;
             background: #fcf8f0;
             color: #5d4e37;
         }
        
        .status-pending {
            background: #d4b896;
        }
        
        .status-confirmed {
            background: #8fbc8f;
        }
        
        .confirmation-item-details {
            color: #8b7355;
            margin-bottom: 10px;
        }
        
        .confirmation-item-actions {
            display: flex;
            gap: 10px;
        }
        
        .confirmation-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-confirm {
            background: #8fbc8f;
            color: #5d4e37;
        }
        
        .btn-confirm:hover {
            background: #7fb07f;
        }
        
        .btn-edit {
            background: #d4b896;
            color: #5d4e37;
        }
        
        .btn-edit:hover {
            background: #c9a876;
        }
        
        .btn-delete {
            background: #cd853f;
            color: #5d4e37;
        }
        
        .btn-delete:hover {
            background: #b8860b;
        }
        
        .add-confirmation-form {
            background: #faf8f4;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(222, 184, 135, 0.3);
        }
        
        .add-confirmation-form input,
        .add-confirmation-form textarea,
        .add-confirmation-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #deb887;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: inherit;
            background: #fcf8f0;
            color: #5d4e37;
        }
        
        .add-confirmation-form textarea {
            height: 80px;
            resize: vertical;
        }
        
        .add-confirmation-form select {
            cursor: pointer;
        }
        
        .confirmation-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #d4b896;
            color: #5d4e37;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ê®ôÈ°åÂçÄÂüü -->
        <div class="header">
            <h1>üèîÔ∏è Êó•ÊúàÊΩ≠ÊóÖË°åÊâãÂÜä</h1>
            <div class="date">üìÖ 2024Âπ¥8Êúà8Êó• - 8Êúà10Êó•</div>
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="showUpdateForm()" style="display: none;">üìù Êõ¥Êñ∞Ë°åÁ®ã</button>
                <button class="btn btn-success" onclick="toggleDiscussion()" style="display: none;">üí¨ ÂÆ∂Â∫≠Ë®éË´ñ</button>
                <button class="btn btn-warning" onclick="clearInviteCodeVerification()" title="Ê∏ÖÈô§ÈÇÄË´ãÁ¢ºÈ©óË≠âÁãÄÊÖã" style="display: none;">üîê ÈáçÁΩÆÈÇÄË´ãÁ¢º</button>
                <button class="btn btn-info" onclick="forceUserRelogin()" title="ÈáçÊñ∞Ë®≠ÂÆöÁî®Êà∂Ë∫´‰ªΩÂíåÈ†≠ÂÉè">üë§ Êõ¥Êñ∞ÂÄã‰∫∫Ë≥áË®ä</button>
                <button class="btn btn-info" onclick="window.open('user-manual.html', '_blank')" title="Êü•Áúã‰ΩøÁî®Ë™™Êòé">üìñ ‰ΩøÁî®ËÄÖÊâãÂÜä</button>
                <button class="btn btn-info" onclick="showPage('packing')">üéí ÂÄã‰∫∫ÊâìÂåÖÊ∏ÖÂñÆ</button>
            </div>
        </div>
        
        <!-- ÊâìÂåÖÊ∏ÖÂñÆÈ†ÅÈù¢ -->
        <div id="packing-page" class="page packing-page">
            <!-- ËøîÂõûÊåâÈàïÁßªÂãïÂà∞È†ÅÈù¢È†ÇÈÉ® -->
            <div class="back-to-main-top">
                <button onclick="showPage('main')" class="btn btn-back-home-top">
                    <div class="btn-icon">üè†</div>
                    <div class="btn-text">ËøîÂõû‰∏ªÈ†Å</div>
                </button>
            </div>
            
            <div class="packing-header">
                <h2 class="packing-title">
                    <span class="title-text">ÊóÖË°åÊâìÂåÖÊ∏ÖÂñÆ</span>
                    <span class="title-underline"></span>
                </h2>
                <div class="packing-actions">
                    <button onclick="resetPackingList()" class="btn btn-common-items">
                        <div class="btn-icon">üîÑ</div>
                        <div class="btn-text">ÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆ</div>
                    </button>
                    <button onclick="showAddPackingItemForm()" class="btn btn-add-item">
                        <div class="btn-icon">‚ûï</div>
                        <div class="btn-text">Êñ∞Â¢ûÁâ©ÂìÅ</div>
                    </button>
                </div>
            </div>
                
            <style>
                /* È†ÇÈÉ®ËøîÂõûÊåâÈàïÊ®£Âºè */
                .back-to-main-top {
                    display: flex;
                    justify-content: flex-start;
                    margin-bottom: 20px;
                    padding-top: 10px;
                }
                
                .btn-back-home-top {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    padding: 10px 20px;
                    border-radius: 25px;
                    font-weight: 600;
                    font-size: 14px;
                    background-image: linear-gradient(to right, #d4b896, #c9a876);
                    color: #5d4e37;
                    box-shadow: 0 3px 12px rgba(212, 184, 150, 0.25);
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                    border: none;
                    cursor: pointer;
                }
                
                .btn-back-home-top::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.2));
                    transform: translateX(-100%);
                    transition: transform 0.5s;
                    z-index: 1;
                }
                
                .btn-back-home-top:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 5px 18px rgba(212, 184, 150, 0.3);
                }
                
                .btn-back-home-top:hover::before {
                    transform: translateX(100%);
                }
                
                .btn-back-home-top:active {
                    transform: translateY(1px);
                    box-shadow: 0 2px 8px rgba(212, 184, 150, 0.2);
                }
                
                .btn-back-home-top .btn-icon,
                .btn-back-home-top .btn-text {
                    position: relative;
                    z-index: 2;
                }
                
                .btn-back-home-top .btn-icon {
                    font-size: 16px;
                }
                
                /* ÈüøÊáâÂºèË®≠Ë®à */
                @media (max-width: 768px) {
                    .back-to-main-top {
                        justify-content: center;
                    }
                    
                    .btn-back-home-top {
                        width: auto;
                        min-width: 140px;
                    }
                }
                
                /* ÊâìÂåÖÊ∏ÖÂñÆÊ®ôÈ°åÊ®£Âºè */
                .packing-title {
                    font-size: 28px; 
                    position: relative; 
                    display: inline-block; 
                    margin-bottom: 20px;
                }
                
                .title-text {
                    background: linear-gradient(to right, #d4b896, #c9a876); 
                    -webkit-background-clip: text; 
                    background-clip: text; 
                    color: transparent; 
                    font-weight: 700;
                    letter-spacing: 0.5px;
                }
                
                .title-underline {
                    position: absolute; 
                    bottom: -8px; 
                    left: 0; 
                    width: 60px; 
                    height: 4px; 
                    background: linear-gradient(to right, #3498db, #2980b9); 
                    border-radius: 4px;
                }
                
                /* ÊåâÈàïÂÖ±Áî®Ê®£Âºè */
                .packing-actions {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 20px;
                }
                
                .packing-actions .btn {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    padding: 12px 20px;
                    border-radius: 12px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                    position: relative;
                    overflow: hidden;
                }
                
                .packing-actions .btn::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.2));
                    transform: translateX(-100%);
                    transition: transform 0.5s;
                    z-index: 1;
                }
                
                .packing-actions .btn:hover::before {
                    transform: translateX(100%);
                }
                
                .packing-actions .btn:active {
                    transform: translateY(2px);
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                }
                
                .packing-actions .btn-icon {
                    font-size: 18px;
                    position: relative;
                    z-index: 2;
                }
                
                .packing-actions .btn-text {
                    position: relative;
                    z-index: 2;
                }
                
                /* ËºâÂÖ•Â∏∏Áî®Áâ©ÂìÅÊåâÈàï */
                .btn-common-items {
                    background-image: linear-gradient(to right, #e8d5b7, #d4b896);
                    color: #5d4e37;
                    border: 1px solid rgba(212, 165, 116, 0.3);
                }
                
                .btn-common-items:hover {
                    background-image: linear-gradient(to right, #d4b896, #c9a876);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 15px rgba(212, 165, 116, 0.3);
                }
                
                /* Êñ∞Â¢ûÁâ©ÂìÅÊåâÈàï */
                .btn-add-item {
                    background-image: linear-gradient(to right, #f5e6d3, #e8d5b7);
                    color: #5d4e37;
                    border: 1px solid rgba(222, 184, 135, 0.3);
                }
                
                .btn-add-item:hover {
                    background-image: linear-gradient(to right, #e8d5b7, #deb887);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 15px rgba(222, 184, 135, 0.3);
                }
                
                /* ÈüøÊáâÂºèË®≠Ë®à */
                @media (max-width: 768px) {
                    .packing-actions {
                        flex-direction: column;
                        gap: 10px;
                    }
                    
                    .packing-actions .btn {
                        width: 100%;
                    }
                }
            </style>
            
            <!-- Á∏ΩÈ´îÈÄ≤Â∫¶Ê¢ù -->
            <div class="packing-progress">
                <div class="progress-header">
                    <div class="progress-title">ÊâìÂåÖÈÄ≤Â∫¶</div>
                    <div id="packing-progress-text" class="progress-text">Â∑≤ÂÆåÊàê: 0/0 (0%)</div>
                </div>
                <div class="progress-bar-container">
                    <div id="packing-progress-bar" class="progress-bar"></div>
                </div>
            </div>
            
            <style>
                /* ÈÄ≤Â∫¶Ê¢ùÊ®£Âºè */
                .packing-progress {
                    background: #ffffff;
                    border-radius: 16px;
                    padding: 20px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                    margin-bottom: 25px;
                    border: 1px solid rgba(0, 0, 0, 0.03);
                }
                
                .progress-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                }
                
                .progress-title {
                    font-size: 16px;
                    font-weight: 600;
                    color: #2c3e50;
                }
                
                .progress-text {
                    font-size: 14px;
                    color: #7f8c8d;
                    font-weight: 500;
                }
                
                .progress-bar-container {
                    height: 12px;
                    background-color: #f1f2f6;
                    border-radius: 10px;
                    overflow: hidden;
                    position: relative;
                }
                
                .progress-bar {
                    height: 100%;
                    width: 0%;
                    background-color: #e74c3c;
                    border-radius: 10px;
                    transition: width 0.5s ease, background-color 0.5s ease;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                    position: relative;
                }
                
                .progress-bar::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(90deg, 
                        rgba(255, 255, 255, 0.1) 0%, 
                        rgba(255, 255, 255, 0.2) 20%, 
                        rgba(255, 255, 255, 0.1) 40%
                    );
                    background-size: 200% 100%;
                    animation: shimmer 1.5s infinite linear;
                }
                
                @keyframes shimmer {
                    0% {
                        background-position: 100% 0;
                    }
                    100% {
                        background-position: -100% 0;
                    }
                }
            </style>
            
            <!-- Êñ∞Â¢ûÁâ©ÂìÅË°®ÂñÆ -->
            <div id="addPackingItemForm" class="add-item-form" style="display: none;">
                <h3 class="form-title">Êñ∞Â¢ûÊâìÂåÖÁâ©ÂìÅ</h3>
                
                <div class="form-row">
                    <div class="input-group">
                        <label for="newPackingItem">Áâ©ÂìÅÂêçÁ®±</label>
                        <input type="text" id="newPackingItem" placeholder="Ëº∏ÂÖ•Áâ©ÂìÅÂêçÁ®±">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="input-group">
                        <label for="newItemCategory">ÈÅ∏ÊìáÂàÜÈ°û</label>
                        <select id="newItemCategory" onchange="toggleCustomCategoryInput()">
                            <option value="clothing">Ë°£Áâ©</option>
                            <option value="toiletries">Áõ•Ê¥óÁî®ÂìÅ</option>
                            <option value="protection">Èò≤Ë≠∑Áî®ÂìÅ</option>
                            <option value="electronics">ÈõªÂ≠êÁî¢ÂìÅ</option>
                            <option value="essentials">ÂÖ∂‰ªñÂøÖÈúÄÂìÅ</option>
                            <option value="custom">Ëá™Ë®ÇÂàÜÈ°û...</option>
                        </select>
                    </div>
                </div>
                
                <div id="customCategoryRow" class="form-row" style="display: none; opacity: 0; transform: translateY(-10px); max-height: 0; overflow: hidden;">
                    <div class="input-group">
                        <label for="customCategory">Ëá™Ë®ÇÂàÜÈ°ûÂêçÁ®±</label>
                        <input type="text" id="customCategory" placeholder="Ëº∏ÂÖ•Ëá™Ë®ÇÂàÜÈ°ûÂêçÁ®±">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button onclick="addPackingItem()" class="btn btn-submit">
                        <div class="btn-icon">‚úÖ</div>
                        <div class="btn-text">Êñ∞Â¢ûÁâ©ÂìÅ</div>
                    </button>
                    <button onclick="hideAddPackingItemForm()" class="btn btn-cancel">
                        <div class="btn-icon">‚ùå</div>
                        <div class="btn-text">ÂèñÊ∂à</div>
                    </button>
                </div>
                
                <style>
                    /* Ë°®ÂñÆÊ®£Âºè */
                    .add-item-form {
                        background: #ffffff;
                        border-radius: 16px;
                        padding: 24px;
                        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
                        margin-bottom: 25px;
                        animation: formSlideDown 0.4s ease-out;
                        border: 1px solid rgba(0, 0, 0, 0.05);
                    }
                    
                    @keyframes formSlideDown {
                        from {
                            opacity: 0;
                            transform: translateY(-20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    .form-title {
                        font-size: 20px;
                        font-weight: 600;
                        color: #2c3e50;
                        margin-top: 0;
                        margin-bottom: 20px;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #f1f2f6;
                    }
                    
                    .form-row {
                        margin-bottom: 16px;
                        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
                    }
                    
                    .input-group {
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .input-group label {
                        font-size: 14px;
                        font-weight: 600;
                        color: #34495e;
                        margin-bottom: 6px;
                    }
                    
                    .add-item-form input,
                    .add-item-form select {
                        padding: 12px 16px;
                        border: 1px solid #e0e0e0;
                        border-radius: 10px;
                        font-size: 15px;
                        transition: all 0.3s ease;
                        background-color: #f9f9f9;
                    }
                    
                    .add-item-form input:focus,
                    .add-item-form select:focus {
                        border-color: #3498db;
                        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
                        outline: none;
                        background-color: #ffffff;
                    }
                    
                    .add-item-form select {
                        cursor: pointer;
                        appearance: none;
                        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                        background-repeat: no-repeat;
                        background-position: right 16px center;
                        padding-right: 40px;
                    }
                    
                    /* Ë°®ÂñÆÊåâÈàïÊ®£Âºè */
                    .form-actions {
                        display: flex;
                        gap: 12px;
                        margin-top: 24px;
                    }
                    
                    .form-actions .btn {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        padding: 12px 20px;
                        border-radius: 10px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .form-actions .btn::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.2));
                        transform: translateX(-100%);
                        transition: transform 0.5s;
                        z-index: 1;
                    }
                    
                    .form-actions .btn:hover::before {
                        transform: translateX(100%);
                    }
                    
                    .form-actions .btn:active {
                        transform: translateY(2px);
                    }
                    
                    .btn-submit {
                        background-image: linear-gradient(to right, #2ecc71, #27ae60);
                        color: white;
                        box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
                    }
                    
                    .btn-submit:hover {
                        background-image: linear-gradient(to right, #27ae60, #219653);
                    }
                    
                    .btn-cancel {
                        background-image: linear-gradient(to right, #e74c3c, #c0392b);
                        color: white;
                        box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2);
                    }
                    
                    .btn-cancel:hover {
                        background-image: linear-gradient(to right, #c0392b, #a93226);
                    }
                    
                    /* Ëá™Ë®ÇÂàÜÈ°ûËº∏ÂÖ•Ê°ÜÂãïÁï´ */
                    #customCategoryRow {
                        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
                    }
                    
                    /* ÈüøÊáâÂºèË®≠Ë®à */
                    @media (max-width: 768px) {
                        .form-actions {
                            flex-direction: column;
                        }
                        
                        .add-item-form {
                            padding: 20px 16px;
                        }
                    }
                </style>
            </div>
            
            <!-- ÂàÜÈ°ûÂÆπÂô® -->
            <div id="packing-categories" class="packing-categories-container">
                <!-- ÂàÜÈ°ûÊúÉÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
            </div>
            
            <style>
                /* ÂàÜÈ°ûÂÆπÂô®Ê®£Âºè */
                .packing-categories-container {
                    margin-bottom: 30px;
                }
                
                /* ÂàÜÈ°ûÂÆπÂô® */
                .category-container {
                    background: #fcf8f0;
                    border-radius: 16px;
                    margin-bottom: 16px;
                    box-shadow: 0 4px 15px rgba(139, 115, 85, 0.1);
                    overflow: hidden;
                    border: 1px solid rgba(222, 184, 135, 0.3);
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                }
                
                .category-container:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(139, 115, 85, 0.15);
                }
                
                /* ÂàÜÈ°ûÊ®ôÈ°å */
                .category-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 16px 20px;
                    cursor: pointer;
                    background: linear-gradient(to right, rgba(212, 184, 150, 0.1), rgba(212, 184, 150, 0.05));
                    border-bottom: 1px solid rgba(222, 184, 135, 0.3);
                    transition: background-color 0.3s ease;
                }
                
                .category-header:hover {
                    background: linear-gradient(to right, rgba(212, 184, 150, 0.15), rgba(212, 184, 150, 0.1));
                }
                
                .category-title {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-weight: 600;
                    color: #5d4e37;
                    font-size: 16px;
                }
                
                .category-title span:last-child {
                    position: relative;
                }
                
                .category-status {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 14px;
                    color: #8b7355;
                }
                
                .status-indicator {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    display: inline-block;
                    transition: background-color 0.3s ease;
                }
                
                /* ÂàÜÈ°ûÈ†ÖÁõÆÂÆπÂô® */
                .category-items {
                    max-height: 0;
                    overflow: hidden;
                    transition: max-height 0.4s ease;
                }
                
                .category-items.expanded {
                    max-height: 1000px; /* Ë∂≥Â§†Â§ßÁöÑÈ´òÂ∫¶‰ª•È°ØÁ§∫ÊâÄÊúâÂÖßÂÆπ */
                }
                
                /* ÊâìÂåÖÁâ©ÂìÅ */
                .packing-item {
                    display: flex;
                    align-items: center;
                    padding: 14px 20px;
                    border-bottom: 1px solid rgba(222, 184, 135, 0.2);
                    transition: background-color 0.2s ease;
                }
                
                .packing-item:last-child {
                    border-bottom: none;
                }
                
                .packing-item:hover {
                    background-color: rgba(212, 184, 150, 0.1);
                }
                
                /* Ê†∏ÂèñÊñπÂ°äÊ®£Âºè */
                .packing-item input[type="checkbox"] {
                    appearance: none;
                    -webkit-appearance: none;
                    width: 22px;
                    height: 22px;
                    border: 2px solid #deb887;
                    border-radius: 6px;
                    margin-right: 12px;
                    position: relative;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    flex-shrink: 0;
                    background: #fcf8f0;
                }
                
                .packing-item input[type="checkbox"]:checked {
                    background-color: #8fbc8f;
                    border-color: #8fbc8f;
                }
                
                .packing-item input[type="checkbox"]:checked::after {
                    content: '‚úì';
                    position: absolute;
                    color: white;
                    font-size: 14px;
                    font-weight: bold;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                }
                
                .packing-item input[type="checkbox"]:focus {
                    outline: none;
                    box-shadow: 0 0 0 3px rgba(143, 188, 143, 0.2);
                }
                
                /* Ê®ôÁ±§Ê®£Âºè */
                .packing-item label {
                    flex-grow: 1;
                    margin-left: 5px;
                    font-size: 15px;
                    color: #6b5b47;
                    cursor: pointer;
                    transition: color 0.2s ease, text-decoration 0.2s ease;
                }
                
                .packing-item input[type="checkbox"]:checked + label {
                    color: #8b7355;
                    text-decoration: line-through;
                }
                
                /* Âà™Èô§ÊåâÈàïÊ®£Âºè */
                .delete-item {
                    background: none;
                    border: none;
                    font-size: 16px;
                    cursor: pointer;
                    opacity: 0.5;
                    transition: opacity 0.2s ease, transform 0.2s ease;
                    padding: 5px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-left: 5px;
                }
                
                .delete-item:hover {
                    opacity: 1;
                    transform: scale(1.1);
                    background-color: rgba(205, 133, 63, 0.1);
                }
                
                /* Á©∫Ê∏ÖÂñÆÊèêÁ§∫ */
                .empty-list-message {
                    text-align: center;
                    color: #8b7355;
                    padding: 30px 20px;
                    font-size: 16px;
                    background: #fcf8f0;
                    border-radius: 16px;
                    box-shadow: 0 4px 15px rgba(139, 115, 85, 0.1);
                    margin-bottom: 25px;
                    border: 1px solid rgba(222, 184, 135, 0.3);
                }
                
                /* ÈüøÊáâÂºèË®≠Ë®à */
                @media (max-width: 768px) {
                    .category-header {
                        padding: 14px 16px;
                    }
                    
                    .packing-item {
                        padding: 12px 16px;
                    }
                    
                    .category-title {
                        font-size: 15px;
                    }
                }
            </style>
            

        </div>

        <div id="main-page" class="page active">
            <div class="main-content">
            <!-- ‰∏ªË¶ÅË°åÁ®ãÂçÄÂüü -->
            <div class="itinerary-section">
                <h2>üóìÔ∏è ÊóÖË°åË°åÁ®ã</h2>
                
                <!-- Êó•ÊúüÂàáÊèõÊ®ôÁ±§ -->
                <div class="day-tab">
                    <button class="active" onclick="showDay(1)">8/8 (‰∫î)</button>
                    <button onclick="showDay(2)">8/9 (ÂÖ≠)</button>
                    <button onclick="showDay(3)">8/10 (Êó•)</button>
                </div>

                <!-- Á¨¨‰∏ÄÂ§©Ë°åÁ®ã -->
                <div id="day1" class="day-content active">
                    <div class="activity">
                        <div class="activity-time">09:00</div>
                        <div class="activity-title">üöó È´òÈõÑÂá∫Áôº</div>
                        <div class="activity-details">ÈñãÂßãÊàëÂÄëÁöÑÊó•ÊúàÊΩ≠‰πãÊóÖÔºÅ</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day1-activity1')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day1-activity1" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">12:00</div>
                        <div class="activity-title">üçú ÂçàÈ§ê - Á´πÈ¶ôÂúí</div>
                        <div class="activity-details">Ë∑ØÁ®ãÁ¥Ñ1Â∞èÊôÇ45ÂàÜÈêò</div>
                        <div class="activity-links">
                            <a href="https://maps.app.goo.gl/Z4FwX1HCSUiFjLgW8" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                            <a href="https://maps.app.goo.gl/J3GT86WiSKWocXieA" target="_blank" class="link-btn tesla-btn" style="background: #e74c3c; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 32px; padding: 0;"><img src="img/Tesla.svg" alt="Tesla" style="width: 20px; height: 20px; filter: brightness(0) invert(1);"></a>
                        </div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day1-activity2')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day1-activity2" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">15:00</div>
                        <div class="activity-title">ü•æ Ê≠•ÈÅìÂÅ•Ëµ∞</div>
                        <div class="activity-details">Âú∞ÈªûÂæÖÁ¢∫Ë™çÔºå‰∫´ÂèóÂ§ßËá™ÁÑ∂ÁöÑÁæéÊôØ</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day1-activity3')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day1-activity3" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">18:00</div>
                        <div class="activity-title">üçΩÔ∏è ÊôöÈ§ê - Ê∞ëÂÆø</div>
                        <div class="activity-details">
                            ÈÅ∏È†ÖÔºöÂ∏ÇÂçÄË≤∑ÁèæÊàêÈ£üÁâ©ÔºàÁáíÁÉ§„ÄÅÈππÈÖ•ÈõûÔºâÊàñÁÅ´ÈçãÔºàÂÖ®ËÅØÈ£üÊùêÔºâ<br>
                            È£≤ÂìÅÔºöÁ¥ÖÈÖí„ÄÅÂï§ÈÖí„ÄÅÂ∞èÂ≠©ÁÑ°ÈÖíÁ≤æÈ£≤Êñô
                        </div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day1-activity4')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day1-activity4" class="activity-discussion" style="display: none;"></div>
                    </div>
                </div>

                <!-- Á¨¨‰∫åÂ§©Ë°åÁ®ã -->
                <div id="day2" class="day-content">
                    <div class="activity">
                        <div class="activity-time">09:00</div>
                        <div class="activity-title">üèÑ‚Äç‚ôÄÔ∏è Êó•ÊúàÊΩ≠Á´ãÊß≥SUPÈ´îÈ©ó</div>
                        <div class="activity-details">Ë∑ØÁ®ãÁ¥Ñ10ÂàÜÈêòÔºåÈ´îÈ©óÊ∞¥‰∏äÈÅãÂãïÁöÑÊ®ÇË∂£</div>
                        <div class="activity-links">
                            <a href="https://maps.app.goo.gl/YiyeqhiqPpJHWoxD6" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                            <a href="https://maps.app.goo.gl/JoViJpmjYGrQbKRL6" target="_blank" class="link-btn tesla-btn" style="background: #e74c3c; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 32px; padding: 0;"><img src="img/Tesla.svg" alt="Tesla" style="width: 20px; height: 20px; filter: brightness(0) invert(1);"></a>
                        </div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day2-activity1')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day2-activity1" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">12:00</div>
                        <div class="activity-title">üç± ÂçàÈ§ê + Áõ•Ê¥ó</div>
                        <div class="activity-details">ÂõûÈ£ØÂ∫óÁõ•Ê¥óÔºåË∑Ø‰∏äÈö®‰æøË≤∑ÂõûÈ£ØÂ∫óÂêÉ</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day2-activity2')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day2-activity2" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">15:00</div>
                        <div class="activity-title">‚òï ‰∏ãÂçàËå∂ - ÈπøÁØôÂíñÂï°ËéäÂúí</div>
                        <div class="activity-details">Ë∑ØÁ®ãÁ¥Ñ15ÂàÜÈêòÔºå‰∫´ÂèóÂ±±ÊôØÂíñÂï°</div>
                        <div class="activity-links">
                            <a href="https://maps.app.goo.gl/st5HA5XjiPttuzMB7" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                            <a href="https://maps.app.goo.gl/jFBJEradwCgeQ7QZ6" target="_blank" class="link-btn tesla-btn" style="background: #e74c3c; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 32px; padding: 0;"><img src="img/Tesla.svg" alt="Tesla" style="width: 20px; height: 20px; filter: brightness(0) invert(1);"></a>
                        </div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day2-activity3')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day2-activity3" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">19:00</div>
                        <div class="activity-title">üçΩÔ∏è ÊôöÈ§ê</div>
                        <div class="activity-details">È§êÂª≥ÂæÖË®Ç</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day2-activity4')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day2-activity4" class="activity-discussion" style="display: none;"></div>
                    </div>
                </div>

                <!-- Á¨¨‰∏âÂ§©Ë°åÁ®ã -->
                <div id="day3" class="day-content">
                    <div class="activity">
                        <div class="activity-time">06:30</div>
                        <div class="activity-title">ü•ê Ê∞ëÂÆøÊó©È§ê</div>
                        <div class="activity-details">‰∫´Áî®Ê∞ëÂÆøÊèê‰æõÁöÑÊó©È§ê</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day3-activity1')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day3-activity1" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">07:00</div>
                        <div class="activity-title">üö¥‚Äç‚ôÄÔ∏è ÂñÆËªäÁí∞ÊπñÊó•ÊúàÊΩ≠</div>
                        <div class="activity-details">Ë∑ØÁ®ãÁ¥Ñ10ÂàÜÈêòÔºåËá™Áî±ÂèÉÂä†ÔºåÊ≤íÂèÉÂä†ÁöÑ‰∫∫ÂèØ‰ª•Áù°Êôö‰∏ÄÈªû</div>
                        <div class="activity-links">
                            <a href="https://maps.app.goo.gl/yKeRJjKdjiHf5nT5A" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                            <a href="https://maps.app.goo.gl/8ANMfrNSWh1BnKUK7" target="_blank" class="link-btn tesla-btn" style="background: #e74c3c; display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 32px; padding: 0;"><img src="img/Tesla.svg" alt="Tesla" style="width: 20px; height: 20px; filter: brightness(0) invert(1);"></a>
                        </div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day3-activity2')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day3-activity2" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">11:00</div>
                        <div class="activity-title">üè® ÈÄÄÊàø</div>
                        <div class="activity-details">Êï¥ÁêÜË°åÊùéÔºåÊ∫ñÂÇôÈõ¢Èñã</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day3-activity3')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day3-activity3" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">12:00</div>
                        <div class="activity-title">üçú ÂçàÈ§ê</div>
                        <div class="activity-details">È§êÂª≥ÂæÖË®Ç</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day3-activity4')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day3-activity4" class="activity-discussion" style="display: none;"></div>
                    </div>
                    
                    <div class="activity">
                        <div class="activity-time">14:00</div>
                        <div class="activity-title">üëã Ëß£Êï£</div>
                        <div class="activity-details">ÁµêÊùüÊÑâÂø´ÁöÑÊóÖÁ®ãÔºåÂêÑËá™ÂõûÂÆ∂</div>
                        <button class="btn btn-primary" onclick="toggleActivityDiscussion('day3-activity5')" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;">üí¨ Ë®éË´ñ</button>
                        <div id="day3-activity5" class="activity-discussion" style="display: none;"></div>
                    </div>
                </div>

                <!-- Ë®éË´ñÂçÄÂüü -->
                <div id="discussion" class="discussion-section" style="display: none;">
                    <h3>üí¨ ÂÆ∂Â∫≠Ë®éË´ñÂçÄ</h3>
                    <div class="comment-form">
                        <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px; color: #2c3e50; font-weight: bold;">
                            ÁôºË°®ËÄÖÔºö<span id="currentUserDisplay">ËºâÂÖ•‰∏≠...</span>
                        </div>
                        <textarea id="commentText" placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÅÂª∫Ë≠∞ÊàñÂïèÈ°å..."></textarea>
                        <button class="btn btn-primary" onclick="addComment()">ÁôºË°®ÁïôË®Ä</button>
                    </div>
                    <div id="commentsList" class="comments-list">
                        <!-- ÁïôË®ÄÊúÉÂãïÊÖãËºâÂÖ•Âà∞ÈÄôË£° -->
                    </div>
                </div>

                <!-- Êõ¥Êñ∞Ë°®ÂñÆ -->
                <div id="updateForm" class="update-form" style="display: none;">
                    <h3>üìù Êõ¥Êñ∞Ë°åÁ®ã</h3>
                    <input type="text" id="updateTitle" placeholder="Êõ¥Êñ∞Ê®ôÈ°å">
                    <textarea id="updateContent" placeholder="ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁöÑÊõ¥Êñ∞ÂÖßÂÆπ..."></textarea>
                    <button class="btn btn-success" onclick="submitUpdate()">Êèê‰∫§Êõ¥Êñ∞</button>
                    <button class="btn" onclick="hideUpdateForm()" style="background: #95a5a6; color: white; margin-left: 10px;">ÂèñÊ∂à</button>
                </div>
            </div>

            <!-- ÂÅ¥ÈÇäÊ¨Ñ -->
            <div class="sidebar">
                <!-- ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö -->
                <div class="confirmation-card">
                    <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        üìã ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
                        <button onclick="showAddConfirmationForm()" class="confirmation-btn btn-edit" style="font-size: 11px;">
                            ‚ûï Êñ∞Â¢û‰∫ãÈ†Ö
                        </button>
                    </h3>
                    
                    <!-- Êñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË°®ÂñÆ -->
                    <div id="addConfirmationForm" class="add-confirmation-form" style="display: none;">
                        <input type="text" id="confirmationTitle" placeholder="‰∫ãÈ†ÖÊ®ôÈ°å (‰æãÂ¶Ç: Á¢∫Ë™çÈ§êÂª≥Ë®Ç‰Ωç)">
                        <textarea id="confirmationDetails" placeholder="Ë©≥Á¥∞Ë™™Êòé (‰æãÂ¶Ç: ÈúÄË¶ÅÂú®8/5ÂâçÁ¢∫Ë™çÊó•ÊúàÊΩ≠È§êÂª≥ÁöÑË®Ç‰ΩçÔºåËÅØÁµ°ÈõªË©±: 049-123456)"></textarea>
                        <select id="confirmationRelatedDay">
                            <option value="">ÈÅ∏ÊìáÁõ∏ÈóúÊó•Êúü</option>
                            <option value="day1">8/8 (‰∫î)</option>
                            <option value="day2">8/9 (ÂÖ≠)</option>
                            <option value="day3">8/10 (Êó•)</option>
                            <option value="all">ÂÖ®ÈÉ®Êó•Êúü</option>
                        </select>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="addConfirmationItem()" class="confirmation-btn btn-confirm" style="flex: 1;">Êñ∞Â¢û</button>
                            <button onclick="hideAddConfirmationForm()" class="confirmation-btn" style="flex: 1; background: #95a5a6; color: white;">ÂèñÊ∂à</button>
                        </div>
                    </div>
                    
                    <!-- Á∑®ËºØÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË°®ÂñÆ -->
                    <div id="editConfirmationForm" class="add-confirmation-form" style="display: none;">
                        <input type="hidden" id="editConfirmationId">
                        <input type="text" id="editConfirmationTitle" placeholder="‰∫ãÈ†ÖÊ®ôÈ°å">
                        <textarea id="editConfirmationDetails" placeholder="Ë©≥Á¥∞Ë™™Êòé"></textarea>
                        <select id="editConfirmationRelatedDay">
                            <option value="">ÈÅ∏ÊìáÁõ∏ÈóúÊó•Êúü</option>
                            <option value="day1">8/8 (‰∫î)</option>
                            <option value="day2">8/9 (ÂÖ≠)</option>
                            <option value="day3">8/10 (Êó•)</option>
                            <option value="all">ÂÖ®ÈÉ®Êó•Êúü</option>
                        </select>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="updateConfirmationItem()" class="confirmation-btn btn-confirm" style="flex: 1;">Êõ¥Êñ∞</button>
                            <button onclick="hideEditConfirmationForm()" class="confirmation-btn" style="flex: 1; background: #95a5a6; color: white;">ÂèñÊ∂à</button>
                        </div>
                    </div>
                    
                    <div id="confirmationItems" style="max-height: 300px; overflow-y: auto;">
                        <!-- ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊúÉÂãïÊÖãËºâÂÖ•Âà∞ÈÄôË£° -->
                    </div>
                </div>
                
                <!-- ‰ΩèÂÆøË≥áË®ä -->
                <div class="info-card">
                    <h3>üè® ‰ΩèÂÆøË≥áË®ä</h3>
                    <h4>3JD.HOME</h4>
                    <a href="https://maps.app.goo.gl/pYVRDqcJJx61gBGP8" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                    
                    <div class="emergency-contact">
                        <h4>üö® Á∑äÊÄ•ËÅØÁµ°</h4>
                        <p>Ê∞ëÂÆøÈõªË©±Ôºö0978-201-007</p>
                        <p>LINEÔºö@rtk2718v</p>
                        <p>Á∑äÊÄ•ËÅØÁµ°‰∫∫ÔºöËÄÅÈóÜ</p>
                    </div>
                </div>

                <!-- ÈôÑËøëÁæéÈ£ü -->
                <div class="info-card">
                    <h3>üç¥ ÈôÑËøëÁæéÈ£ü</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 10px;">
                            <strong>È≠öÂÖâÁ™ØÁÉ§È∫µÂåÖ</strong><br>
                            <a href="https://maps.app.goo.gl/wWTSEYKu9f2rxVrq5" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <strong>Ëµ∞Ë∑ØÊìºË≤ì</strong><br>
                            <a href="https://maps.app.goo.gl/bEACb3WmXziVFp9H8" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <strong>Á¥†È£üÈ§êÂª≥</strong><br>
                            <a href="https://maps.app.goo.gl/fJxANeiLY4oF7MpZ9" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <strong>Êó•ÊúàÊΩ≠Á¥ÖËå∂È§®ÔºàÁæ©Â§ßÂà©È∫µÔºâ</strong><br>
                            <a href="https://maps.app.goo.gl/szkuNrdFYWckuBJ66" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                        </li>
                        <li style="margin-bottom: 10px;">
                            <strong>ÂÖ®ËÅØ</strong><br>
                            <a href="https://maps.app.goo.gl/wHReMsvXB2ByosJw8" target="_blank" class="link-btn">üß≠ Â∞éËà™</a>
                        </li>
                    </ul>
                </div>

                <!-- Â§©Ê∞£Ë≥áË®ä -->
                <div class="info-card weather-widget" id="weatherWidget">
                    <div class="weather-header" onclick="toggleWeatherCard()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üå§Ô∏è Â§©Ê∞£È†êÂ†±</h3>
                        <span class="weather-toggle-icon" id="weatherToggleIcon" style="font-size: 1.2em; transition: transform 0.3s ease;">‚ñº</span>
                    </div>
                    
                    <!-- Á∞°ÂåñÈ°ØÁ§∫ÔºàÊî∂Êë∫ÁãÄÊÖãÔºâ -->
                    <div class="weather-summary" id="weatherSummary" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="weather-icon" id="weatherIconSummary" style="font-size: 1.5em;">‚òÄÔ∏è</span>
                            <div>
                                <div class="weather-temp" id="weatherTempSummary" style="font-weight: bold;">Ê∫´Â∫¶Ôºö--¬∞C</div>
                                <div class="weather-condition" id="weatherConditionSummary" style="font-size: 0.9em; color: #666;">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ë©≥Á¥∞ÂÖßÂÆπÔºàÂ±ïÈñãÁãÄÊÖãÔºâ -->
                    <div class="weather-details-container" id="weatherDetailsContainer">
                        <div class="weather-loading" id="weatherLoading" style="text-align: center; padding: 20px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                            <p>ËºâÂÖ•Â§©Ê∞£Ë≥áË®ä‰∏≠...</p>
                        </div>
                        <div class="weather-content" id="weatherContent" style="display: none;">
                            <div class="weather-icon" id="weatherIcon" style="font-size: 3em; text-align: center; margin-bottom: 10px;">‚òÄÔ∏è</div>
                            <div class="weather-location" id="weatherLocation" style="text-align: center; font-weight: bold; margin-bottom: 5px;">Êó•ÊúàÊΩ≠Âú∞ÂçÄ</div>
                            <div class="weather-temp" id="weatherTemp" style="text-align: center; font-size: 1.2em; margin-bottom: 5px;">Ê∫´Â∫¶Ôºö--¬∞C</div>
                            <div class="weather-condition" id="weatherCondition" style="text-align: center; color: #666; margin-bottom: 15px;">--</div>
                            <div class="weather-details" id="weatherDetails">
                                <div class="weather-detail-item">
                                    <span>üíß ÊøïÂ∫¶Ôºö</span><span id="weatherHumidity">--%</span>
                                </div>
                                <div class="weather-detail-item">
                                    <span>üí® È¢®ÈÄüÔºö</span><span id="weatherWind">-- km/h</span>
                                </div>
                                <div class="weather-detail-item">
                                    <span>üëÅÔ∏è ËÉΩË¶ãÂ∫¶Ôºö</span><span id="weatherVisibility">-- km</span>
                                </div>
                            </div>
                            <div class="weather-forecast" id="weatherForecast">
                                <h4 style="margin: 15px 0 10px 0; font-size: 0.9em; color: #666;">Êú™‰æÜ3Â§©È†êÂ†±</h4>
                                <div class="forecast-items" id="forecastItems"></div>
                            </div>
                            <div class="weather-update-time" id="weatherUpdateTime" style="font-size: 0.8em; color: #999; margin-top: 10px; text-align: center;"></div>
                        </div>
                        <div class="weather-error" id="weatherError" style="display: none; text-align: center; padding: 20px; color: #e74c3c;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                            <p>ÁÑ°Ê≥ïËºâÂÖ•Â§©Ê∞£Ë≥áË®ä</p>
                            <button onclick="loadWeatherData()" class="btn btn-primary" style="margin-top: 10px; font-size: 0.8em; padding: 5px 10px;">ÈáçÊñ∞ËºâÂÖ•</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÊâìÂåÖÊ∏ÖÂñÆÂÖ•Âè£ -->
                <div class="info-card">
                    <h3 style="display: flex; justify-content: space-between; align-items: center;">
                        üéíÂÄã‰∫∫ÊâìÂåÖÊ∏ÖÂñÆ
                    </h3>
                    <p style="margin-bottom: 15px;">Ë¶èÂäÉ‰Ω†ÁöÑÊóÖË°åÂøÖÂÇôÁâ©ÂìÅÔºåÁ¢∫‰øù‰∏çÊúÉÈÅ∫Êºè‰ªª‰ΩïÈáçË¶ÅÁâ©ÂìÅ„ÄÇ</p>
                    <div style="text-align: center;">
                        <button onclick="showPage('packing')" class="btn btn-primary" style="width: 100%;">Êü•ÁúãÂÆåÊï¥ÊâìÂåÖÊ∏ÖÂñÆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁü•Ë®äÊÅØ -->
    <div id="notification" class="notification"></div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let comments = [];
        let updates = [];
        let activityComments = {};
        let userProfiles = [];
        let currentUser = null;

        // È°ØÁ§∫ÁâπÂÆöÂ§©Êï∏ÁöÑË°åÁ®ã
        function showDay(dayNumber) {
            // Èö±ËóèÊâÄÊúâÂ§©Êï∏ÂÖßÂÆπ
            document.querySelectorAll('.day-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊåâÈàïÁöÑactiveÁãÄÊÖã
            document.querySelectorAll('.day-tab button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÂ§©Êï∏
            document.getElementById(`day${dayNumber}`).classList.add('active');
            event.target.classList.add('active');
        }

        // ÂàáÊèõË®éË´ñÂçÄÈ°ØÁ§∫
        function toggleDiscussion() {
            const discussion = document.getElementById('discussion');
            if (discussion.style.display === 'none') {
                discussion.style.display = 'block';
                loadComments();
            } else {
                discussion.style.display = 'none';
            }
        }

        // È°ØÁ§∫Êõ¥Êñ∞Ë°®ÂñÆ
        function showUpdateForm() {
            document.getElementById('updateForm').style.display = 'block';
        }

        // Èö±ËóèÊõ¥Êñ∞Ë°®ÂñÆ
        function hideUpdateForm() {
            document.getElementById('updateForm').style.display = 'none';
            document.getElementById('updateTitle').value = '';
            document.getElementById('updateContent').value = '';
        }

        // Êñ∞Â¢ûÁïôË®Ä
        async function addComment(replyToId = null) {
            const text = document.getElementById('commentText').value.trim();
            
            if (!currentUser) {
                showNotification('Ë´ãÂÖàË®≠ÂÆöÂÄã‰∫∫ID', 'error');
                return;
            }
            
            if (!text) {
                showNotification('Ë´ãÂ°´ÂØ´ÁïôË®ÄÂÖßÂÆπ', 'error');
                return;
            }
            
            const author = currentUser.name;
            
            const comment = {
                id: Date.now(),
                author: author,
                text: text,
                timestamp: new Date().toISOString(),
                replyTo: replyToId,
                replies: []
            };
            
            try {
                if (replyToId) {
                    // ÊâæÂà∞Ë¢´ÂõûÂæ©ÁöÑÁïôË®Ä‰∏¶Ê∑ªÂä†ÂõûÂæ©
                    const parentComment = findCommentById(comments, replyToId);
                    if (parentComment) {
                        parentComment.replies.push(comment);
                        // Êõ¥Êñ∞ Firebase
                        await dbService.saveComments(comments);
                    }
                } else {
                    // Êñ∞ÁöÑ‰∏ªÁïôË®Ä
                    comments.unshift(comment);
                    // Êõ¥Êñ∞ Firebase
                    await dbService.saveComments(comments);
                }
                
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                document.getElementById('commentText').value = '';
                showNotification('ÁïôË®ÄÂ∑≤ÁôºË°®ÔºÅ');
            } catch (error) {
                console.error('ÁôºË°®ÁïôË®ÄÂ§±Êïó:', error);
                showNotification('ÁôºË°®ÁïôË®ÄÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // Êü•ÊâæÁïôË®ÄÁöÑËºîÂä©ÂáΩÊï∏
        function findCommentById(commentsList, id) {
            for (let comment of commentsList) {
                if (comment.id === id) {
                    return comment;
                }
                // ÈÅûËø¥ÊêúÂ∞ãÂõûÂæ©‰∏≠ÁöÑÁïôË®Ä
                const found = findCommentById(comment.replies || [], id);
                if (found) return found;
            }
            return null;
        }
        
        // Ê∏≤ÊüìÁïôË®ÄÂàóË°®
        function renderComments() {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            
            comments.forEach(comment => {
                renderComment(comment, commentsList, 0);
            });
        }
        
        // Ê∏≤ÊüìÂñÆÂÄãÁïôË®ÄÔºàÊîØÊè¥Â∑¢ÁãÄÂõûÂæ©Ôºâ
        function renderComment(comment, container, depth = 0) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.style.marginLeft = `${depth * 20}px`;
            if (depth > 0) {
                commentDiv.style.borderLeft = '3px solid #3498db';
                commentDiv.style.paddingLeft = '15px';
                commentDiv.style.backgroundColor = '#f8f9fa';
            }
            
            commentDiv.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author">${comment.author}</span>
                    <span class="comment-time">${formatTimestamp(comment.timestamp)}</span>
                    <button class="reply-btn" onclick="showReplyForm(${comment.id})" style="margin-left: 10px; font-size: 12px; padding: 2px 8px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">ÂõûÂæ©</button>
                </div>
                <div class="comment-text">${comment.text}</div>
                <div id="reply-form-${comment.id}" class="reply-form" style="display: none; margin-top: 10px; padding: 10px; background: #ecf0f1; border-radius: 5px;">
                    <div style="margin-bottom: 8px; padding: 5px; background: #f8f9fa; border-radius: 3px; color: #2c3e50; font-size: 12px;">
                        ÂõûË¶ÜËÄÖÔºö<span class="current-user-name">${currentUser ? currentUser.name : 'Êú™ÁôªÂÖ•'}</span>
                    </div>
                    <textarea id="reply-text-${comment.id}" placeholder="ÂõûÂæ© ${comment.author} ÁöÑÁïôË®Ä..." style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; resize: vertical; min-height: 60px;"></textarea>
                    <div style="margin-top: 8px;">
                        <button onclick="submitReply(${comment.id})" style="padding: 5px 12px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">ÁôºË°®ÂõûÂæ©</button>
                        <button onclick="hideReplyForm(${comment.id})" style="padding: 5px 12px; background: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            container.appendChild(commentDiv);
            
            // Êõ¥Êñ∞Êñ∞Âª∫Á´ãÁöÑÁî®Êà∂È°ØÁ§∫
            setTimeout(() => {
                updateCurrentUserDisplay();
            }, 0);
            
            // Ê∏≤ÊüìÂõûÂæ©
            if (comment.replies && comment.replies.length > 0) {
                comment.replies.forEach(reply => {
                    renderComment(reply, container, depth + 1);
                });
            }
        }

        // ËºâÂÖ•ÁïôË®Ä
        function loadComments() {
            const savedComments = localStorage.getItem('comments');
            if (savedComments) {
                comments = JSON.parse(savedComments);
                // Á¢∫‰øùËàäÁïôË®ÄÁõ∏ÂÆπÊñ∞ÁöÑ‰∏≤ÊñáÁµêÊßã
                comments.forEach(comment => {
                    if (!comment.replies) {
                        comment.replies = [];
                    }
                });
                renderComments();
            }
        }
        
        // È°ØÁ§∫ÂõûÂæ©Ë°®ÂñÆ
        function showReplyForm(commentId) {
            // Èö±ËóèÊâÄÊúâÂÖ∂‰ªñÂõûÂæ©Ë°®ÂñÆ
            document.querySelectorAll('.reply-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // È°ØÁ§∫ÊåáÂÆöÁöÑÂõûÂæ©Ë°®ÂñÆ
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'block';
                document.getElementById(`reply-text-${commentId}`).focus();
            }
        }
        
        // Èö±ËóèÂõûÂæ©Ë°®ÂñÆ
        function hideReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'none';
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                document.getElementById(`reply-text-${commentId}`).value = '';
            }
        }
        
        // Êèê‰∫§ÂõûÂæ©
        async function submitReply(commentId) {
            const text = document.getElementById(`reply-text-${commentId}`).value.trim();
            
            if (!currentUser) {
                showNotification('Ë´ãÂÖàË®≠ÂÆöÂÄã‰∫∫ID', 'error');
                return;
            }
            
            if (!text) {
                showNotification('Ë´ãÂ°´ÂØ´ÂõûÂæ©ÂÖßÂÆπ', 'error');
                return;
            }
            
            const author = currentUser.name;
            
            const reply = {
                id: Date.now(),
                author: author,
                text: text,
                timestamp: new Date().toISOString(),
                replyTo: commentId,
                replies: []
            };
            
            try {
                // ÊâæÂà∞Ë¢´ÂõûÂæ©ÁöÑÁïôË®Ä‰∏¶Ê∑ªÂä†ÂõûÂæ©
                const parentComment = findCommentById(comments, commentId);
                if (parentComment) {
                    parentComment.replies.push(reply);
                    // Êõ¥Êñ∞ Firebase
                    await dbService.saveComments(comments);
                    hideReplyForm(commentId);
                    showNotification('ÂõûÂæ©Â∑≤ÁôºË°®ÔºÅ');
                } else {
                    showNotification('Êâæ‰∏çÂà∞ÂéüÁïôË®Ä', 'error');
                }
            } catch (error) {
                console.error('ÁôºË°®ÂõûÂæ©Â§±Êïó:', error);
                showNotification('ÁôºË°®ÂõûÂæ©Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // Êèê‰∫§Êõ¥Êñ∞
        async function submitUpdate() {
            const title = document.getElementById('updateTitle').value.trim();
            const content = document.getElementById('updateContent').value.trim();
            
            if (!title || !content) {
                showNotification('Ë´ãÂ°´ÂØ´Êõ¥Êñ∞Ê®ôÈ°åÂíåÂÖßÂÆπ', 'error');
                return;
            }
            
            const update = {
                id: Date.now(),
                title: title,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            try {
                updates.unshift(update);
                // Êõ¥Êñ∞ Firebase
                await dbService.saveUpdates(updates);
                hideUpdateForm();
                showNotification('Êõ¥Êñ∞Ë´ãÊ±ÇÂ∑≤Êèê‰∫§ÔºÅ');
            } catch (error) {
                console.error('Êèê‰∫§Êõ¥Êñ∞Â§±Êïó:', error);
                showNotification('Êèê‰∫§Êõ¥Êñ∞Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }



        // È°ØÁ§∫ÈÄöÁü•
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑË®àÊôÇÂô®
            if (window.notificationTimer) {
                clearTimeout(window.notificationTimer);
                window.notificationTimer = null;
            }
            
            // ÂâµÂª∫ÈóúÈñâÊåâÈàï
            const closeButton = document.createElement('span');
            closeButton.innerHTML = '&times;';
            closeButton.style.cssText = `
                position: absolute;
                top: 8px;
                right: 10px;
                font-size: 18px;
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.2s ease;
            `;
            closeButton.addEventListener('mouseover', () => {
                closeButton.style.opacity = '1';
            });
            closeButton.addEventListener('mouseout', () => {
                closeButton.style.opacity = '0.7';
            });
            closeButton.addEventListener('click', () => {
                hideNotification();
            });
            
            // Ë®≠ÁΩÆÈÄöÁü•ÂÖßÂÆπ
            notification.innerHTML = '';
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            notification.style.position = 'relative';
            notification.style.display = 'flex'; // Á¢∫‰øùÈÄöÁü•ÂèØË¶ã
            
            // ÂâµÂª∫Ê∂àÊÅØÊñáÊú¨ÁØÄÈªû
            const messageText = document.createElement('span');
            messageText.textContent = message;
            messageText.style.cssText = `
                display: block;
                padding-right: 30px;
            `;
            
            notification.appendChild(messageText);
            notification.appendChild(closeButton);
            
            // Áµ±‰∏ÄÁöÑÈö±ËóèÂáΩÊï∏
            function hideNotification() {
                if (window.notificationTimer) {
                    clearTimeout(window.notificationTimer);
                    window.notificationTimer = null;
                }
                notification.classList.remove('show');
                // Á¢∫‰øùÈÄöÁü•ÂÆåÂÖ®Èö±Ëóè
                setTimeout(() => {
                    if (!notification.classList.contains('show')) {
                        notification.innerHTML = '';
                        notification.style.display = 'none';
                    }
                }, 300);
            }
            
            // Ë®≠ÁΩÆËá™ÂãïÈö±ËóèË®àÊôÇÂô®ÔºàÁ∞°ÂåñÁâàÊú¨ÔºåÁ¢∫‰øù‰∏ÄÂÆöÊúÉÂü∑Ë°åÔºâ
            window.notificationTimer = setTimeout(() => {
                hideNotification();
            }, duration);
        }

        // ÂÑ≤Â≠òÂà∞Êú¨Âú∞Â≠òÂÑ≤ (Â∑≤Ê£ÑÁî®Ôºå‰øùÁïô‰ΩúÁÇ∫Áõ∏ÂÆπÊÄßÊîØÊè¥)
        function saveToLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
            // Ê≥®ÊÑèÔºöÊ≠§ÂáΩÊï∏Â∑≤Ë¢´ Firebase Áõ∏ÈóúÂáΩÊï∏Âèñ‰ª£ÔºåÂÉÖ‰øùÁïô‰ΩúÁÇ∫Áõ∏ÂÆπÊÄßÊîØÊè¥
        }

        // Ê†ºÂºèÂåñÊôÇÈñìÊà≥ÁÇ∫Áî®Êà∂ÂèãÂ•ΩÁöÑÊ†ºÂºè
        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    console.warn('ÁÑ°ÊïàÁöÑÊôÇÈñìÊà≥:', timestamp);
                    return timestamp; // Â¶ÇÊûúÁÑ°Ê≥ïËß£ÊûêÔºåËøîÂõûÂéüÂßãÂÄº
                }
                return date.toLocaleString('zh-TW');
            } catch (error) {
                console.error('Ê†ºÂºèÂåñÊôÇÈñìÊà≥Â§±Êïó:', error);
                return timestamp;
            }
        }

        // Ê™¢Êü•Ê¥ªÂãïÊòØÂê¶ÊúâÊú™ËÆÄÁïôË®Ä
        async function hasUnreadComments(activityId) {
            try {
                // ‰ΩøÁî® window.currentUser Á¢∫‰øùÁç≤ÂèñÊúÄÊñ∞ÁöÑÁî®Êà∂ÁãÄÊÖã
                const user = window.currentUser || currentUser;
                if (!user) {
                    console.log(`Ê™¢Êü• ${activityId} Êú™ËÆÄÁïôË®ÄÔºöÁî®Êà∂Êú™ÁôªÂÖ•`);
                    return false;
                }
                
                // Áç≤ÂèñÊúÄÂæåÊü•ÁúãÊôÇÈñì
                const lastViewTime = await getLastViewTime(activityId);
                const comments = (window.activityComments && window.activityComments[activityId]) || activityComments[activityId] || [];
                
                console.log(`Ê™¢Êü• ${activityId} Êú™ËÆÄÁïôË®ÄÔºö`);
                console.log(`  - Áî®Êà∂: ${user.name}`);
                console.log(`  - ÊúÄÂæåÊü•ÁúãÊôÇÈñì: ${lastViewTime.toLocaleString()}`);
                console.log(`  - ÁïôË®ÄÊï∏: ${comments.length}`);
                console.log(`  - Ê¥ªÂãïÁïôË®ÄÊï∏Êìö‰æÜÊ∫ê: ${window.activityComments ? 'window.activityComments' : 'activityComments'}`);
                
                // Ê™¢Êü•ÊòØÂê¶ÊúâÊñ∞ÁïôË®ÄÊàñÂõûÂæ©
                for (let comment of comments) {
                    const commentTime = new Date(comment.timestamp);
                    console.log(`  - Ê™¢Êü•ÁïôË®Ä: ${comment.author} Âú® ${comment.timestamp}, ÁïôË®ÄÊôÇÈñì: ${commentTime.toLocaleString()}`);
                    if (commentTime > lastViewTime) {
                        console.log(`  ‚úÖ ÁôºÁèæÊú™ËÆÄ‰∏ªÁïôË®ÄÔºö${comment.author} Âú® ${comment.timestamp}`);
                        return true;
                    }
                    // Ê™¢Êü•ÂõûÂæ©
                    if (comment.replies && comment.replies.length > 0) {
                        for (let reply of comment.replies) {
                            const replyTime = new Date(reply.timestamp);
                            console.log(`    - Ê™¢Êü•ÂõûÂæ©: ${reply.author} Âú® ${reply.timestamp}, ÂõûÂæ©ÊôÇÈñì: ${replyTime.toLocaleString()}`);
                            if (replyTime > lastViewTime) {
                                console.log(`    ‚úÖ ÁôºÁèæÊú™ËÆÄÂõûÂæ©Ôºö${reply.author} Âú® ${reply.timestamp}`);
                                return true;
                            }
                        }
                    }
                }
                console.log(`  ‚ùå ${activityId} Ê≤íÊúâÊú™ËÆÄÁïôË®Ä`);
                return false;
            } catch (error) {
                console.error(`Ê™¢Êü• ${activityId} Êú™ËÆÄÁïôË®ÄÂ§±Êïó:`, error);
                return false;
            }
        }

        // Áç≤ÂèñÊúÄÂæåÊü•ÁúãÊôÇÈñì
        async function getLastViewTime(activityId) {
            try {
                if (!currentUser) return new Date(0);
                
                const viewTime = await dbService.getLastViewTime(currentUser.name, activityId);
                return viewTime ? new Date(viewTime) : new Date(0);
            } catch (error) {
                console.error('Áç≤ÂèñÊúÄÂæåÊü•ÁúãÊôÇÈñìÂ§±Êïó:', error);
                // Â¶ÇÊûú Firebase Áç≤ÂèñÂ§±ÊïóÔºåÂòóË©¶ÂæûÊú¨Âú∞Áç≤Âèñ
                const viewTimes = JSON.parse(localStorage.getItem('activityViewTimes') || '{}');
                return viewTimes[activityId] ? new Date(viewTimes[activityId]) : new Date(0);
            }
        }

        // Êõ¥Êñ∞ÊúÄÂæåÊü•ÁúãÊôÇÈñì
        async function updateLastViewTime(activityId) {
            try {
                if (!currentUser) return;
                
                const currentTime = new Date().toISOString();
                
                // Êõ¥Êñ∞ Firebase
                await dbService.updateLastViewTime(currentUser.name, activityId, currentTime);
                
                // ÂêåÊôÇÊõ¥Êñ∞Êú¨Âú∞Â≠òÂÑ≤Ôºà‰ΩúÁÇ∫ÂÇô‰ªΩÔºâ
                const viewTimes = JSON.parse(localStorage.getItem('activityViewTimes') || '{}');
                viewTimes[activityId] = currentTime;
                localStorage.setItem('activityViewTimes', JSON.stringify(viewTimes));
                
                updateUnreadIndicators();
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊúÄÂæåÊü•ÁúãÊôÇÈñìÂ§±Êïó:', error);
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâÊú™ËÆÄÊåáÁ§∫Âô®
        async function updateUnreadIndicators() {
            try {
                console.log('=== ÈñãÂßãÊõ¥Êñ∞ÊâÄÊúâÊú™ËÆÄÊåáÁ§∫Âô® ===');
                console.log('Áï∂ÂâçÁî®Êà∂:', window.currentUser ? window.currentUser.name : 'Êú™Ë®≠ÁΩÆ');
                console.log('Ê¥ªÂãïÁïôË®ÄÊï∏Êìö:', window.activityComments ? Object.keys(window.activityComments).length + 'ÂÄãÊ¥ªÂãï' : 'Êú™ËºâÂÖ•');
                
                // Êü•ÊâæÊâÄÊúâË®éË´ñÊåâÈàï‰∏¶Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                const buttons = document.querySelectorAll('button[onclick*="toggleActivityDiscussion"]');
                console.log('ÊâæÂà∞Ë®éË´ñÊåâÈàïÊï∏Èáè:', buttons.length);
                
                if (buttons.length === 0) {
                    console.warn('Êú™ÊâæÂà∞‰ªª‰ΩïË®éË´ñÊåâÈàïÔºåÂèØËÉΩÈ†ÅÈù¢Â∞öÊú™ÂÆåÂÖ®ËºâÂÖ•');
                    return;
                }
                
                for (const button of buttons) {
                    const onclickAttr = button.getAttribute('onclick');
                    const match = onclickAttr.match(/toggleActivityDiscussion\('([^']+)'\)/);
                    if (match) {
                        const activityId = match[1];
                        console.log(`ËôïÁêÜÊåâÈàï: ${activityId}`);
                        await updateUnreadIndicator(activityId, button);
                    } else {
                        console.warn('ÁÑ°Ê≥ïËß£ÊûêÊåâÈàïÁöÑ onclick Â±¨ÊÄß:', onclickAttr);
                    }
                }
                console.log('=== Êú™ËÆÄÊåáÁ§∫Âô®Êõ¥Êñ∞ÂÆåÊàê ===');
            } catch (error) {
                console.error('Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®Â§±Êïó:', error);
            }
        }

        // Êõ¥Êñ∞ÂñÆÂÄãÊú™ËÆÄÊåáÁ§∫Âô®
        async function updateUnreadIndicator(activityId, button) {
            try {
                console.log(`ÈñãÂßãÊõ¥Êñ∞ ${activityId} ÁöÑÊú™ËÆÄÊåáÁ§∫Âô®`);
                
                // ÁßªÈô§ÁèæÊúâÁöÑÊú™ËÆÄÊåáÁ§∫Âô®
                const existingIndicator = button.querySelector('.unread-indicator');
                if (existingIndicator) {
                    console.log(`ÁßªÈô§ ${activityId} ÁöÑÁèæÊúâÊú™ËÆÄÊåáÁ§∫Âô®`);
                    existingIndicator.remove();
                }
    
                // Â¶ÇÊûúÊúâÊú™ËÆÄÁïôË®ÄÔºåÊ∑ªÂä†ÊåáÁ§∫Âô®
                const hasUnread = await hasUnreadComments(activityId);
                if (hasUnread) {
                    console.log(`ÁÇ∫ ${activityId} Ê∑ªÂä†Êú™ËÆÄÊåáÁ§∫Âô®`);
                    const indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                    indicator.innerHTML = 'üî¥';
                    indicator.style.cssText = `
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        font-size: 12px;
                        animation: pulse 2s infinite;
                    `;
                    button.style.position = 'relative';
                    button.appendChild(indicator);
                    console.log(`${activityId} Êú™ËÆÄÊåáÁ§∫Âô®Â∑≤Ê∑ªÂä†`);
                } else {
                    console.log(`${activityId} Ê≤íÊúâÊú™ËÆÄÁïôË®ÄÔºå‰∏çÊ∑ªÂä†ÊåáÁ§∫Âô®`);
                }
            } catch (error) {
                console.error(`Êõ¥Êñ∞ ${activityId} ÁöÑÊú™ËÆÄÊåáÁ§∫Âô®Â§±Êïó:`, error);
            }
        }

        // ÂàáÊèõÊ¥ªÂãïË®éË´ñÂçÄÈ°ØÁ§∫
        async function toggleActivityDiscussion(activityId) {
            const discussionDiv = document.getElementById(activityId);
            
            if (discussionDiv.style.display === 'none') {
                // È°ØÁ§∫Ë®éË´ñÂçÄ‰∏¶ÂàùÂßãÂåñÂÖßÂÆπ
                discussionDiv.style.display = 'block';
                initActivityDiscussion(activityId);
                await loadActivityComments(activityId);
                // Êõ¥Êñ∞ÊúÄÂæåÊü•ÁúãÊôÇÈñì
                await updateLastViewTime(activityId);
            } else {
                // Èö±ËóèË®éË´ñÂçÄ
                discussionDiv.style.display = 'none';
            }
        }

        // ÂàùÂßãÂåñÊ¥ªÂãïË®éË´ñÂçÄ
        function initActivityDiscussion(activityId) {
            const discussionDiv = document.getElementById(activityId);
            
            if (discussionDiv.innerHTML === '') {
                discussionDiv.innerHTML = `
                     <h4 style="margin-bottom: 15px; color: #2c3e50; font-size: 16px;">üí¨ ÈáùÂ∞çÊ≠§Ë°åÁ®ãÁöÑË®éË´ñ</h4>
                     <div class="activity-comment-form">
                         <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px; color: #2c3e50; font-weight: bold; font-size: 14px;">
                             ÁôºË°®ËÄÖÔºö<span class="current-user-name">${currentUser ? currentUser.name : 'Êú™ÁôªÂÖ•'}</span>
                         </div>
                         <textarea id="activity-text-${activityId}" placeholder="Â∞çÈÄôÂÄãË°åÁ®ãÊúâ‰ªÄÈ∫ºÊÉ≥Ê≥ïÊàñÂª∫Ë≠∞Ôºü"></textarea>
                         <button class="btn btn-success" onclick="addActivityComment('${activityId}')" style="font-size: 12px; padding: 6px 12px;">ÁôºË°®ÁïôË®Ä</button>
                     </div>
                     <div id="${activityId}-comments" class="activity-comments">
                         <!-- ÁïôË®ÄÊúÉÂãïÊÖãËºâÂÖ•Âà∞ÈÄôË£° -->
                     </div>
                 `;
                 
                 // Êõ¥Êñ∞Êñ∞Âª∫Á´ãÁöÑÁî®Êà∂È°ØÁ§∫
                 setTimeout(() => {
                     updateCurrentUserDisplay();
                 }, 0);
            }
        }

        // Êñ∞Â¢ûÊ¥ªÂãïÁïôË®Ä
        async function addActivityComment(activityId, replyToId = null) {
            const textElement = document.getElementById(`activity-text-${activityId}`);
            
            if (!textElement) {
                showNotification('Êâæ‰∏çÂà∞Ë°®ÂñÆÂÖÉÁ¥†', 'error');
                return;
            }
            
            if (!currentUser) {
                showNotification('Ë´ãÂÖàË®≠ÂÆöÂÄã‰∫∫ID', 'error');
                return;
            }
            
            const text = textElement.value.trim();
            
            if (!text) {
                showNotification('Ë´ãÂ°´ÂØ´ÁïôË®ÄÂÖßÂÆπ', 'error');
                return;
            }
            
            const author = currentUser.name;
            
            const comment = {
                id: Date.now(),
                author: author,
                text: text,
                timestamp: new Date().toISOString(),
                replyTo: replyToId,
                replies: []
            };
            
            try {
                // ÂàùÂßãÂåñÊ¥ªÂãïÁïôË®ÄÈô£ÂàóÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
                if (!activityComments[activityId]) {
                    activityComments[activityId] = [];
                }
                
                if (replyToId) {
                    // ÊâæÂà∞Ë¢´ÂõûÂæ©ÁöÑÁïôË®Ä‰∏¶Ê∑ªÂä†ÂõûÂæ©
                    const parentComment = findCommentById(activityComments[activityId], replyToId);
                    if (parentComment) {
                        parentComment.replies.push(comment);
                    }
                } else {
                    // Êñ∞ÁöÑ‰∏ªÁïôË®Ä
                    activityComments[activityId].unshift(comment);
                }
                
                // Êõ¥Êñ∞ Firebase
                await dbService.saveActivityComments(activityId, activityComments[activityId]);
                
                // ÈáçÊñ∞Ê∏≤ÊüìÁïôË®ÄÂàóË°®
                renderActivityComments(activityId);
                
                // Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                updateUnreadIndicators();
                
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                const textElementClear = document.getElementById(`activity-text-${activityId}`);
                if (textElementClear) textElementClear.value = '';
                showNotification('ÁïôË®ÄÂ∑≤ÁôºË°®ÔºÅ');
            } catch (error) {
                console.error('ÁôºË°®Ê¥ªÂãïÁïôË®ÄÂ§±Êïó:', error);
                showNotification('ÁôºË°®Ê¥ªÂãïÁïôË®ÄÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // Ê∏≤ÊüìÊ¥ªÂãïÁïôË®ÄÂàóË°®
        function renderActivityComments(activityId) {
            const commentsList = document.getElementById(`${activityId}-comments`);
            const comments = activityComments[activityId] || [];
            
            commentsList.innerHTML = '';
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">ÈÇÑÊ≤íÊúâ‰∫∫Ë®éË´ñÈÄôÂÄãË°åÁ®ãÔºåÂø´‰æÜÁïô‰∏ãÁ¨¨‰∏ÄÂÄãÊÑèË¶ãÂêßÔºÅ</p>';
                return;
            }
            
            comments.forEach(comment => {
                renderActivityComment(comment, commentsList, activityId, 0);
            });
        }
        
        // Ê∏≤ÊüìÂñÆÂÄãÊ¥ªÂãïÁïôË®ÄÔºàÊîØÊè¥Â∑¢ÁãÄÂõûÂæ©Ôºâ
        function renderActivityComment(comment, container, activityId, depth = 0) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'activity-comment';
            commentDiv.style.marginLeft = `${depth * 15}px`;
            if (depth > 0) {
                commentDiv.style.borderLeft = '2px solid #3498db';
                commentDiv.style.paddingLeft = '10px';
                commentDiv.style.backgroundColor = '#f8f9fa';
            }
            
            commentDiv.innerHTML = `
                <div class="activity-comment-header">
                    <span class="activity-comment-author">${comment.author}</span>
                    <span class="activity-comment-time">${formatTimestamp(comment.timestamp)}</span>
                    <button onclick="showActivityReplyForm('${activityId}', ${comment.id})" style="margin-left: 8px; font-size: 11px; padding: 2px 6px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">ÂõûÂæ©</button>
                </div>
                <div class="activity-comment-text">${comment.text}</div>
                <div id="activity-reply-form-${activityId}-${comment.id}" class="activity-reply-form" style="display: none; margin-top: 8px; padding: 8px; background: #ecf0f1; border-radius: 5px;">
                    <div style="margin-bottom: 6px; padding: 4px; background: #f8f9fa; border-radius: 3px; color: #2c3e50; font-size: 11px;">
                        ÂõûË¶ÜËÄÖÔºö<span class="current-user-name">${currentUser ? currentUser.name : 'Êú™ÁôªÂÖ•'}</span>
                    </div>
                    <textarea id="activity-reply-text-${activityId}-${comment.id}" placeholder="ÂõûÂæ© ${comment.author} ÁöÑÁïôË®Ä..." style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 3px; resize: vertical; min-height: 50px; font-size: 12px;"></textarea>
                    <div style="margin-top: 6px;">
                        <button onclick="submitActivityReply('${activityId}', ${comment.id})" style="padding: 4px 8px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 4px; font-size: 11px;">ÁôºË°®ÂõûÂæ©</button>
                        <button onclick="hideActivityReplyForm('${activityId}', ${comment.id})" style="padding: 4px 8px; background: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            container.appendChild(commentDiv);
            
            // Êõ¥Êñ∞Êñ∞Âª∫Á´ãÁöÑÁî®Êà∂È°ØÁ§∫
            setTimeout(() => {
                updateCurrentUserDisplay();
            }, 0);
            
            // Ê∏≤ÊüìÂõûÂæ©
            if (comment.replies && comment.replies.length > 0) {
                comment.replies.forEach(reply => {
                    renderActivityComment(reply, container, activityId, depth + 1);
                });
            }
        }
        
        // È°ØÁ§∫Ê¥ªÂãïÂõûÂæ©Ë°®ÂñÆ
        function showActivityReplyForm(activityId, commentId) {
            // Èö±ËóèÊâÄÊúâÂÖ∂‰ªñÂõûÂæ©Ë°®ÂñÆ
            document.querySelectorAll('.activity-reply-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // È°ØÁ§∫ÊåáÂÆöÁöÑÂõûÂæ©Ë°®ÂñÆ
            const replyForm = document.getElementById(`activity-reply-form-${activityId}-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'block';
                const textArea = document.getElementById(`activity-reply-text-${activityId}-${commentId}`);
                if (textArea) textArea.focus();
            }
        }
        
        // Èö±ËóèÊ¥ªÂãïÂõûÂæ©Ë°®ÂñÆ
        function hideActivityReplyForm(activityId, commentId) {
            const replyForm = document.getElementById(`activity-reply-form-${activityId}-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'none';
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                const textArea = document.getElementById(`activity-reply-text-${activityId}-${commentId}`);
                if (textArea) textArea.value = '';
            }
        }
        
        // Êèê‰∫§Ê¥ªÂãïÂõûÂæ©
        async function submitActivityReply(activityId, commentId) {
            const textElement = document.getElementById(`activity-reply-text-${activityId}-${commentId}`);
            
            if (!textElement) {
                showNotification('Êâæ‰∏çÂà∞ÂõûÂæ©Ë°®ÂñÆÂÖÉÁ¥†', 'error');
                return;
            }
            
            if (!currentUser) {
                showNotification('Ë´ãÂÖàË®≠ÂÆöÂÄã‰∫∫ID', 'error');
                return;
            }
            
            const text = textElement.value.trim();
            
            if (!text) {
                showNotification('Ë´ãÂ°´ÂØ´ÂõûÂæ©ÂÖßÂÆπ', 'error');
                return;
            }
            
            const author = currentUser.name;
            
            const reply = {
                id: Date.now(),
                author: author,
                text: text,
                timestamp: new Date().toISOString(),
                replyTo: commentId,
                replies: []
            };
            
            try {
                // Á¢∫‰øù activityComments Â≠òÂú®
                if (!window.activityComments) {
                    console.warn('activityComments Êú™ÂÆöÁæ©ÔºåÊ≠£Âú®ÂàùÂßãÂåñ');
                    window.activityComments = {};
                }
                
                // Á¢∫‰øù activityComments[activityId] Â≠òÂú®
                if (!activityComments[activityId]) {
                    console.warn(`Ê¥ªÂãï ${activityId} ÁöÑÁïôË®ÄÂàóË°®‰∏çÂ≠òÂú®ÔºåÊ≠£Âú®ÂàùÂßãÂåñ`);
                    activityComments[activityId] = [];
                }
                
                console.log(`ÂòóË©¶Âú®Ê¥ªÂãï ${activityId} ‰∏≠Êü•ÊâæÁïôË®Ä ID: ${commentId}`);
                console.log('Áï∂ÂâçÊ¥ªÂãïÁïôË®ÄÂàóË°®:', activityComments[activityId]);
                
                // ÊâæÂà∞Ë¢´ÂõûÂæ©ÁöÑÁïôË®Ä‰∏¶Ê∑ªÂä†ÂõûÂæ©
                const parentComment = findCommentById(activityComments[activityId], commentId);
                if (parentComment) {
                    console.log(`ÊâæÂà∞ÂéüÁïôË®Ä:`, parentComment);
                    
                    // Á¢∫‰øù parentComment.replies Â≠òÂú®
                    if (!parentComment.replies) {
                        console.warn(`ÁïôË®Ä ${commentId} ÁöÑ replies Â±¨ÊÄß‰∏çÂ≠òÂú®ÔºåÊ≠£Âú®ÂàùÂßãÂåñ`);
                        parentComment.replies = [];
                    }
                    
                    parentComment.replies.push(reply);
                    
                    // Êõ¥Êñ∞ Firebase
                    await dbService.saveActivityComments(activityId, activityComments[activityId]);
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÁïôË®ÄÂàóË°®
                    renderActivityComments(activityId);
                    
                    hideActivityReplyForm(activityId, commentId);
                    
                    // Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                    updateUnreadIndicators();
                    
                    showNotification('ÂõûÂæ©Â∑≤ÁôºË°®ÔºÅ');
                } else {
                    console.error(`Êâæ‰∏çÂà∞ÂéüÁïôË®Ä ID: ${commentId}ÔºåÊ¥ªÂãï ID: ${activityId}`);
                    console.log('Áï∂ÂâçÊ¥ªÂãïÁïôË®ÄÂàóË°®:', JSON.stringify(activityComments[activityId]));
                    showNotification('Êâæ‰∏çÂà∞ÂéüÁïôË®Ä', 'error');
                }
            } catch (error) {
                console.error('ÁôºË°®Ê¥ªÂãïÂõûÂæ©Â§±Êïó:', error);
                console.error('ÈåØË™§Ë©≥ÊÉÖ:', error.stack);
                showNotification('ÁôºË°®Ê¥ªÂãïÂõûÂæ©Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // ËºâÂÖ•Ê¥ªÂãïÁïôË®Ä
        async function loadActivityComments(activityId) {
            try {
                // Âæû Firebase Áç≤ÂèñÁâπÂÆöÊ¥ªÂãïÁöÑÁïôË®Ä
                const comments = await dbService.getActivityComments(activityId);
                
                // Êõ¥Êñ∞Êú¨Âú∞Ê¥ªÂãïÁïôË®Ä
                if (comments) {
                    activityComments[activityId] = comments;
                    // Á¢∫‰øùÊâÄÊúâÁïôË®ÄÈÉΩÊúâ replies Èô£Âàó
                    activityComments[activityId].forEach(comment => {
                        if (!comment.replies) {
                            comment.replies = [];
                        }
                    });
                } else {
                    activityComments[activityId] = [];
                }
                
                renderActivityComments(activityId);
            } catch (error) {
                console.error(`ËºâÂÖ•Ê¥ªÂãï ${activityId} ÁöÑÁïôË®ÄÂ§±Êïó:`, error);
                showNotification('ËºâÂÖ•ÁïôË®ÄÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            await checkUserIdentity();
            await loadComments();
            
            // ÊâìÂåÖÊ∏ÖÂñÆÂ∞áÂú® Firebase ÂàùÂßãÂåñÂæåËºâÂÖ•ÔºåÈÄôË£°‰∏çÂÜçÂæû localStorage ËºâÂÖ•
            if (!window.packingItems) {
                window.packingItems = [];
                console.log('ÊâìÂåÖÊ∏ÖÂñÆÂàùÂßãÂåñÁÇ∫Á©∫Èô£ÂàóÔºåÁ≠âÂæÖ Firebase ËºâÂÖ•');
            } else {
                console.log('ÊâìÂåÖÊ∏ÖÂñÆÂ∑≤Âú®ÂÖ∂‰ªñÂú∞ÊñπÂàùÂßãÂåñÔºåË∑≥ÈÅéÈáçË§áÂàùÂßãÂåñ');
            }
            
            // ÂàùÂßãÂåñÊâìÂåÖÊ∏ÖÂñÆÁ≥ªÁµ±
            await initializePackingSystem();
            
            // È°ØÁ§∫‰∏ªÈ†ÅÈù¢
            showPage('main');
            
            // Á¢∫‰øùÊâìÂåÖÊ∏ÖÂñÆË¢´Ê∏≤Êüì
            renderPackingItems();
            
            // ÂàùÂßãÂåñÊú™ËÆÄÊåáÁ§∫Âô®
            setTimeout(async () => {
                await updateUnreadIndicators();
            }, 500);
            
            // ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
            await loadConfirmationItems();
            
            // Ë®≠ÁΩÆÁõ£ËÅΩÊâÄÊúâÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁöÑË®éË´ñËÆäÂåñ
            if (window.dbService && typeof window.dbService.listenToAllConfirmationItemComments === 'function') {
                try {
                    window.dbService.listenToAllConfirmationItemComments((itemId, comments) => {
                        // Â¶ÇÊûúË®éË´ñÂçÄÂ∑≤Á∂ìÊâìÈñãÔºåÂâáÊõ¥Êñ∞È°ØÁ§∫
                        const discussionDiv = document.getElementById(`confirmation-discussion-${itemId}`);
                        if (discussionDiv && discussionDiv.style.display !== 'none') {
                            renderConfirmationItemComments(itemId, comments);
                        }
                    });
                    console.log('Â∑≤Ë®≠ÁΩÆÁõ£ËÅΩÊâÄÊúâÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË®éË´ñ');
                } catch (error) {
                    console.error('Ë®≠ÁΩÆÁõ£ËÅΩÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË®éË´ñÂ§±Êïó:', error);
                }
            }
        });
        
        // Ê™¢Êü•Áî®Êà∂Ë∫´‰ªΩ
        async function checkUserIdentity() {
            try {
                // ÂÖàÊ™¢Êü•Êú¨Âú∞ÂÑ≤Â≠ò
                const savedUser = localStorage.getItem('currentUser');
                
                if (savedUser) {
                    // Â¶ÇÊûúÊú¨Âú∞ÊúâÁî®Êà∂Ë≥áÊñôÔºåÂÖà‰ΩøÁî®ÂÆÉ
                    currentUser = JSON.parse(savedUser);
                    updateCurrentUserDisplay();
                    
                    // ÁÑ∂ÂæåÂòóË©¶Âæû Firebase Áç≤ÂèñÊúÄÊñ∞ÁöÑÁî®Êà∂Ë≥áÊñô
                    try {
                        const firebaseUser = await dbService.getUserProfile(currentUser.name);
                        if (firebaseUser) {
                            // Â¶ÇÊûú Firebase ‰∏≠ÊúâÊõ¥Êñ∞ÁöÑË≥áÊñôÔºå‰ΩøÁî®ÂÆÉ
                            currentUser = firebaseUser;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            updateCurrentUserDisplay();
                        }
                    } catch (err) {
                        console.error('Âæû Firebase Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±Êïó:', err);
                        // ÁπºÁ∫å‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô
                    }
                } else {
                    // Â¶ÇÊûúÊú¨Âú∞Ê≤íÊúâÁî®Êà∂Ë≥áÊñôÔºåÈ°ØÁ§∫Ë∫´‰ªΩË®≠ÂÆöÂΩàÁ™ó
                    showUserIdentityModal();
                }
            } catch (error) {
                console.error('Ê™¢Êü•Áî®Êà∂Ë∫´‰ªΩÂ§±Êïó:', error);
                // Â¶ÇÊûúÂá∫ÈåØÔºåÈ°ØÁ§∫Ë∫´‰ªΩË®≠ÂÆöÂΩàÁ™ó
                showUserIdentityModal();
            }
        }
        
        // È°ØÁ§∫Áî®Êà∂Ë∫´‰ªΩË®≠ÂÆöÂΩàÁ™ó
        function showUserIdentityModal() {
            // Ê™¢Êü•ÊòØÂê¶Â∑≤È©óË≠âÈÇÄË´ãÁ¢º
            const inviteCodeVerified = localStorage.getItem('inviteCodeVerified');
            if (!inviteCodeVerified) {
                showInviteCodeModal();
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #fcf8f0;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(222, 184, 135, 0.3);
                    border: 2px solid #deb887;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    max-height: 90vh;
                    overflow-y: auto;
                ">
                    <h2 style="color: #5d4e37; margin-bottom: 20px; font-size: 24px;">üë§ Ê≠°Ëøé‰æÜÂà∞ÂÄã‰∫∫ÊóÖË°åÊâãÂÜä</h2>
                    <p style="color: #8b7355; margin-bottom: 25px; line-height: 1.6;">Ë´ãÂëäË®¥ÊàëÂÄëÊÇ®ÁöÑÂÄã‰∫∫IDÔºå‰∏¶ÈÅ∏Êìá‰∏ÄÂÄãÈ†≠ÂÉèÔºÅ</p>
                    
                    <input type="text" id="userNameInput" placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂÄã‰∫∫IDÔºà‰æãÂ¶ÇÔºöÂ∞èÈõ∑„ÄÅÈòøËã¶„ÄÅÊ≥âÊàêÔºâ" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #deb887;
                        border-radius: 8px;
                        font-size: 16px;
                        margin-bottom: 20px;
                        box-sizing: border-box;
                        background: #faf6f0;
                        color: #5d4e37;
                    ">
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #5d4e37; margin-bottom: 15px; font-size: 18px;">ÈÅ∏ÊìáÊÇ®ÁöÑÈ†≠ÂÉèÔºö</h3>
                        <div id="avatarSelection" style="
                            display: grid;
                            grid-template-columns: repeat(5, 1fr);
                            gap: 10px;
                            justify-items: center;
                            margin-bottom: 20px;
                        ">
                            ${generateAvatarOptions()}
                        </div>
                    </div>
                    
                    <button onclick="setUserIdentity()" style="
                        background: #d4a574;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        width: 100%;
                        transition: background 0.3s;
                    " onmouseover="this.style.background='#c19660'" onmouseout="this.style.background='#d4a574'">ÈñãÂßã‰ΩøÁî®</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('userNameInput').focus();
            
            // ÊåâEnterÈçµ‰πüËÉΩÊèê‰∫§
            document.getElementById('userNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setUserIdentity();
                }
            });
            
            // Ë®≠ÁΩÆÈ†≠ÂÉèÈÅ∏ÊìáÂäüËÉΩ
            setupAvatarSelection();
        }
        
        // ÁîüÊàêÈ†≠ÂÉèÈÅ∏È†Ö
        function generateAvatarOptions() {
            let avatarHTML = '';
            for (let i = 1; i <= 10; i++) {
                const avatarId = `ID-${i.toString().padStart(2, '0')}`;
                avatarHTML += `
                    <div class="avatar-option" data-avatar="${avatarId}" style="
                        width: 60px;
                        height: 60px;
                        border: 3px solid transparent;
                        border-radius: 50%;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        overflow: hidden;
                        position: relative;
                    " onclick="selectAvatar('${avatarId}')">
                        <img src="./img/${avatarId}.png" alt="È†≠ÂÉè ${i}" style="
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            border-radius: 50%;
                        ">
                    </div>
                `;
            }
            return avatarHTML;
        }
        
        // Ë®≠ÁΩÆÈ†≠ÂÉèÈÅ∏ÊìáÂäüËÉΩ
        function setupAvatarSelection() {
            // È†êË®≠ÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÈ†≠ÂÉè
            selectAvatar('ID-01');
        }
        
        // ÈÅ∏ÊìáÈ†≠ÂÉè
        function selectAvatar(avatarId) {
            // ÁßªÈô§ÊâÄÊúâÈ†≠ÂÉèÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.style.border = '3px solid transparent';
                option.style.transform = 'scale(1)';
                option.style.boxShadow = 'none';
            });
            
            // Ë®≠ÁΩÆÈÅ∏‰∏≠ÁöÑÈ†≠ÂÉèÊ®£Âºè
            const selectedAvatar = document.querySelector(`[data-avatar="${avatarId}"]`);
            if (selectedAvatar) {
                selectedAvatar.style.border = '3px solid #d4a574';
                selectedAvatar.style.transform = 'scale(1.1)';
                selectedAvatar.style.boxShadow = '0 4px 12px rgba(212, 165, 116, 0.4)';
            }
            
            // ÂÑ≤Â≠òÈÅ∏ÊìáÁöÑÈ†≠ÂÉè
            window.selectedAvatar = avatarId;
        }
        
        // È°ØÁ§∫ÈÇÄË´ãÁ¢ºÈ©óË≠âÂΩàÁ™ó
        function showInviteCodeModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #fcf8f0;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(222, 184, 135, 0.3);
                    border: 2px solid #deb887;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                ">
                    <h2 style="color: #d4a574; margin-bottom: 20px; font-size: 24px;">üîê ÈÇÄË´ãÁ¢ºÈ©óË≠â</h2>
                    <p style="color: #8b7355; margin-bottom: 25px; line-height: 1.6;">ÈÄôÊòØ‰∏ÄÂÄãÁßÅ‰∫∫ÊóÖË°åÊâãÂÜäÔºåË´ãËº∏ÂÖ•ÈÇÄË´ãÁ¢º‰ª•ÁπºÁ∫åË®™Âïè„ÄÇ</p>
                    <input type="password" id="inviteCodeInput" placeholder="Ë´ãËº∏ÂÖ•ÈÇÄË´ãÁ¢º" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #deb887;
                        border-radius: 8px;
                        font-size: 16px;
                        margin-bottom: 15px;
                        box-sizing: border-box;
                        text-align: center;
                        letter-spacing: 2px;
                        background: #faf6f0;
                        color: #5d4e37;
                    ">
                    <div id="inviteCodeError" style="
                        color: #d4a574;
                        font-size: 14px;
                        margin-bottom: 15px;
                        display: none;
                    ">ÈÇÄË´ãÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•</div>
                    <button onclick="verifyInviteCode()" style="
                        background: #d4a574;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        width: 100%;
                        transition: background 0.3s;
                    " onmouseover="this.style.background='#c19660'" onmouseout="this.style.background='#d4a574'">È©óË≠âÈÇÄË´ãÁ¢º</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('inviteCodeInput').focus();
            
            // ÊåâEnterÈçµ‰πüËÉΩÊèê‰∫§
            document.getElementById('inviteCodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyInviteCode();
                }
            });
        }
        
        // È©óË≠âÈÇÄË´ãÁ¢º
        async function verifyInviteCode() {
            const inviteCode = document.getElementById('inviteCodeInput').value.trim();
            const correctCode = '0808..';
            
            // Ê™¢Êü•ÈÇÄË´ãÁ¢ºÊòØÂê¶ÁÇ∫Êú¨Âú∞Á°¨Á∑®Á¢ºÁöÑÈÇÄË´ãÁ¢º
            if (inviteCode === correctCode) {
                console.log('‰ΩøÁî®Á°¨Á∑®Á¢ºÈÇÄË´ãÁ¢ºÈ©óË≠âÊàêÂäü');
                // ÈÇÄË´ãÁ¢ºÊ≠£Á¢∫ÔºåÂÑ≤Â≠òÈ©óË≠âÁãÄÊÖã
                localStorage.setItem('inviteCodeVerified', 'true');
                
                // ÁßªÈô§ÈÇÄË´ãÁ¢ºÂΩàÁ™ó
                document.querySelector('div[style*="position: fixed"]').remove();
                
                // È°ØÁ§∫Áî®Êà∂Ë∫´‰ªΩË®≠ÂÆöÂΩàÁ™ó
                showUserIdentityModal();
                
                showNotification('ÈÇÄË´ãÁ¢ºÈ©óË≠âÊàêÂäüÔºÅÊ≠°Ëøé‰ΩøÁî®ÊóÖË°åÊâãÂÜä„ÄÇ', 'success');
                return;
            }
            
            // Ê™¢Êü• dbService ÊòØÂê¶Â∑≤Ê≠£Á¢∫ÂàùÂßãÂåñ
            if (!window.dbService || typeof window.dbService.verifyInviteCode !== 'function') {
                console.error('Firebase Ë≥áÊñôÂ∫´ÊúçÂãôÊú™ÂàùÂßãÂåñÊàñ verifyInviteCode ÊñπÊ≥ï‰∏çÂ≠òÂú®');
                
                // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
                const errorDiv = document.getElementById('inviteCodeError');
                errorDiv.textContent = 'Firebase ÈÄ£Êé•Â§±ÊïóÔºåË´ã‰ΩøÁî®È†êË®≠ÈÇÄË´ãÁ¢º 0808..';
                errorDiv.style.display = 'block';
                document.getElementById('inviteCodeInput').style.borderColor = '#d4a574';
                
                // 3ÁßíÂæåÈö±ËóèÈåØË™§Ë®äÊÅØ‰∏¶ÈáçÁΩÆÈÇäÊ°ÜÈ°èËâ≤
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = 'ÈÇÄË´ãÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•';
                    document.getElementById('inviteCodeInput').style.borderColor = '#deb887';
                }, 5000); // Âª∂Èï∑È°ØÁ§∫ÊôÇÈñìÔºåËÆìÁî®Êà∂ÊúâË∂≥Â§†ÊôÇÈñìÁúãÂà∞ÊèêÁ§∫
                return;
            }
            
            try {
                // ‰ΩøÁî® Firebase È©óË≠âÈÇÄË´ãÁ¢º
                console.log('ÂòóË©¶È©óË≠âÈÇÄË´ãÁ¢º:', inviteCode);
                const isValid = await dbService.verifyInviteCode(inviteCode);
                
                if (isValid) {
                    console.log('ÈÇÄË´ãÁ¢ºÈ©óË≠âÊàêÂäü');
                    // ÈÇÄË´ãÁ¢ºÊ≠£Á¢∫ÔºåÂÑ≤Â≠òÈ©óË≠âÁãÄÊÖã
                    localStorage.setItem('inviteCodeVerified', 'true');
                    
                    // ÁßªÈô§ÈÇÄË´ãÁ¢ºÂΩàÁ™ó
                    document.querySelector('div[style*="position: fixed"]').remove();
                    
                    // È°ØÁ§∫Áî®Êà∂Ë∫´‰ªΩË®≠ÂÆöÂΩàÁ™ó
                    showUserIdentityModal();
                    
                    showNotification('ÈÇÄË´ãÁ¢ºÈ©óË≠âÊàêÂäüÔºÅÊ≠°Ëøé‰ΩøÁî®ÊóÖË°åÊâãÂÜä„ÄÇ', 'success');
                } else {
                    console.warn('ÈÇÄË´ãÁ¢ºÈ©óË≠âÂ§±Êïó:', inviteCode);
                    // ÈÇÄË´ãÁ¢ºÈåØË™§
                    const errorDiv = document.getElementById('inviteCodeError');
                    errorDiv.style.display = 'block';
                    document.getElementById('inviteCodeInput').value = '';
                    document.getElementById('inviteCodeInput').focus();
                    document.getElementById('inviteCodeInput').style.borderColor = '#d4a574';
                    
                    // ÊèêÁ§∫ÂèØ‰ª•‰ΩøÁî®È†êË®≠ÈÇÄË´ãÁ¢º
                    errorDiv.textContent = 'ÈÇÄË´ãÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•';
                    
                    // 5ÁßíÂæåÈö±ËóèÈåØË™§Ë®äÊÅØ‰∏¶ÈáçÁΩÆÈÇäÊ°ÜÈ°èËâ≤
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                        errorDiv.textContent = 'ÈÇÄË´ãÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•';
                        document.getElementById('inviteCodeInput').style.borderColor = '#deb887';
                    }, 5000);
                }
            } catch (error) {
                console.error('È©óË≠âÈÇÄË´ãÁ¢ºÂ§±Êïó:', error);
                
                // È°ØÁ§∫ÈåØË™§Ë®äÊÅØÔºåÊèêÁ§∫ÂèØ‰ΩøÁî®È†êË®≠ÈÇÄË´ãÁ¢º
                const errorDiv = document.getElementById('inviteCodeError');
                errorDiv.textContent = 'È©óË≠âÂ§±ÊïóÔºåË´ã‰ΩøÁî®È†êË®≠ÈÇÄË´ãÁ¢º 0808..';
                errorDiv.style.display = 'block';
                document.getElementById('inviteCodeInput').style.borderColor = '#e74c3c';
                
                // 5ÁßíÂæåÈö±ËóèÈåØË™§Ë®äÊÅØ‰∏¶ÈáçÁΩÆÈÇäÊ°ÜÈ°èËâ≤
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = 'ÈÇÄË´ãÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•';
                    document.getElementById('inviteCodeInput').style.borderColor = '#ddd';
                }, 5000);
            }
        }
        
        // Ë®≠ÂÆöÁî®Êà∂Ë∫´‰ªΩ
        async function setUserIdentity() {
            const userName = document.getElementById('userNameInput').value.trim();
            if (!userName) {
                 alert('Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂÄã‰∫∫ID');
                 return;
             }
            
            // Ê™¢Êü•ÊòØÂê¶ÈÅ∏Êìá‰∫ÜÈ†≠ÂÉè
            const selectedAvatar = window.selectedAvatar || 'ID-01';
            
            currentUser = {
                name: userName,
                avatar: selectedAvatar,
                joinDate: new Date().toLocaleString('zh-TW')
            };
            
            try {
                // ÂÑ≤Â≠òÁî®Êà∂Ë≥áË®äÂà∞ Firebase
                await dbService.saveUserProfile(currentUser);
                
                // ÂêåÊôÇÂÑ≤Â≠òÂà∞Êú¨Âú∞Ôºà‰ΩúÁÇ∫ÂÇô‰ªΩÔºâ
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Êõ¥Êñ∞Áî®Êà∂ÂàóË°®
                await loadUserProfiles();
                
                // ÁßªÈô§ÂΩàÁ™ó
                document.querySelector('div[style*="position: fixed"]').remove();
                
                // Êõ¥Êñ∞Áî®Êà∂È°ØÁ§∫
                updateCurrentUserDisplay();
                
                showNotification(`Ê≠°Ëøé ${userName}ÔºÅÊÇ®ÁèæÂú®ÂèØ‰ª•ÈñãÂßã‰ΩøÁî®ÂÄã‰∫∫ÊóÖË°åÊâãÂÜä‰∫Ü„ÄÇ`);
            } catch (error) {
                console.error('Ë®≠ÂÆöÁî®Êà∂Ë∫´‰ªΩÂ§±Êïó:', error);
                
                // Â¶ÇÊûú Firebase ÂÑ≤Â≠òÂ§±ÊïóÔºåÂÉÖ‰ΩøÁî®Êú¨Âú∞ÂÑ≤Â≠ò
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Êõ¥Êñ∞Áî®Êà∂ÂàóË°®
                loadUserProfiles();
                if (!userProfiles.find(user => user.name === userName)) {
                    userProfiles.push(currentUser);
                    saveToLocalStorage('userProfiles', userProfiles);
                }
                
                // ÁßªÈô§ÂΩàÁ™ó
                document.querySelector('div[style*="position: fixed"]').remove();
                
                // Êõ¥Êñ∞Áî®Êà∂È°ØÁ§∫
                updateCurrentUserDisplay();
                
                showNotification(`Ê≠°Ëøé ${userName}ÔºÅÊÇ®ÁèæÂú®ÂèØ‰ª•ÈñãÂßã‰ΩøÁî®ÂÄã‰∫∫ÊóÖË°åÊâãÂÜä‰∫Ü„ÄÇ`);
            }
        }
        
        // ËºâÂÖ•Áî®Êà∂Ë≥áÊñô
        async function loadUserProfiles() {
            try {
                // Âæû Firebase ËºâÂÖ•Áî®Êà∂Ë≥áÊñô
                const profiles = await dbService.getUserProfiles();
                
                if (profiles && profiles.length > 0) {
                    userProfiles = profiles;
                } else {
                    // Â¶ÇÊûú Firebase ‰∏≠Ê≤íÊúâË≥áÊñôÔºåÂòóË©¶ÂæûÊú¨Âú∞ËºâÂÖ•
                    const saved = localStorage.getItem('userProfiles');
                    userProfiles = saved ? JSON.parse(saved) : [
                        { name: 'Â∞èÈõ∑', avatar: 'ID-01', joinDate: '2024-01-01' },
                        { name: 'ÈòøËã¶', avatar: 'ID-02', joinDate: '2024-01-01' },
                        { name: 'Ê≥âÊàê', avatar: 'ID-03', joinDate: '2024-01-01' },
                        { name: 'Â∞èÁ¥Ö', avatar: 'ID-04', joinDate: '2024-01-01' }
                    ];
                    
                    // Â∞áÈ†êË®≠Áî®Êà∂Ë≥áÊñôÂÑ≤Â≠òÂà∞ Firebase
                    if (!saved) {
                        try {
                            for (const user of userProfiles) {
                                await dbService.saveUserProfile(user);
                            }
                        } catch (err) {
                            console.error('ÂàùÂßãÂåñÁî®Êà∂Ë≥áÊñôÂà∞ Firebase Â§±Êïó:', err);
                        }
                    }
                }
            } catch (error) {
                console.error('ËºâÂÖ•Áî®Êà∂Ë≥áÊñôÂ§±Êïó:', error);
                
                // Â¶ÇÊûú Firebase ËºâÂÖ•Â§±ÊïóÔºåÂæûÊú¨Âú∞ËºâÂÖ•
                const saved = localStorage.getItem('userProfiles');
                userProfiles = saved ? JSON.parse(saved) : [
                    { name: 'Â∞èÈõ∑', avatar: 'ID-01', joinDate: '2024-01-01' },
                    { name: 'ÈòøËã¶', avatar: 'ID-02', joinDate: '2024-01-01' },
                    { name: 'Ê≥âÊàê', avatar: 'ID-03', joinDate: '2024-01-01' },
                    { name: 'Â∞èÁ¥Ö', avatar: 'ID-04', joinDate: '2024-01-01' }
                ];
            }
        }
        
        // Êõ¥Êñ∞Áï∂ÂâçÁî®Êà∂È°ØÁ§∫
        function updateCurrentUserDisplay() {
            // Êõ¥Êñ∞ÂÖ®ÂüüË®éË´ñÂçÄÁöÑÁî®Êà∂È°ØÁ§∫
            const globalUserDisplay = document.getElementById('currentUserDisplay');
            if (globalUserDisplay && currentUser) {
                // Â¶ÇÊûúÁî®Êà∂ÊúâÈ†≠ÂÉèÔºåÈ°ØÁ§∫È†≠ÂÉèÂíåÂêçÁ®±
                if (currentUser.avatar) {
                    globalUserDisplay.innerHTML = `
                        <img src="./img/${currentUser.avatar}.png" alt="${currentUser.name}ÁöÑÈ†≠ÂÉè" style="
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            object-fit: cover;
                            margin-right: 8px;
                            vertical-align: middle;
                        ">
                        <span style="vertical-align: middle;">${currentUser.name}</span>
                    `;
                } else {
                    globalUserDisplay.textContent = currentUser.name;
                }
            }
            
            // Êõ¥Êñ∞ÊâÄÊúâÂãïÊÖãÁîüÊàêÁöÑÁî®Êà∂ÂêçÁ®±È°ØÁ§∫
            document.querySelectorAll('.current-user-name').forEach(element => {
                if (currentUser) {
                    // Â¶ÇÊûúÁî®Êà∂ÊúâÈ†≠ÂÉèÔºåÈ°ØÁ§∫È†≠ÂÉèÂíåÂêçÁ®±
                    if (currentUser.avatar) {
                        element.innerHTML = `
                            <img src="./img/${currentUser.avatar}.png" alt="${currentUser.name}ÁöÑÈ†≠ÂÉè" style="
                                width: 20px;
                                height: 20px;
                                border-radius: 50%;
                                object-fit: cover;
                                margin-right: 6px;
                                vertical-align: middle;
                            ">
                            <span style="vertical-align: middle;">${currentUser.name}</span>
                        `;
                    } else {
                        element.textContent = currentUser.name;
                    }
                }
            });
            
            
        }
        
        
        
        // Ê∏ÖÈô§ÈÇÄË´ãÁ¢ºÈ©óË≠âÁãÄÊÖã
        async function clearInviteCodeVerification() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÈÇÄË´ãÁ¢ºÈ©óË≠âÁãÄÊÖãÂóéÔºü‰∏ãÊ¨°Ë®™ÂïèÊôÇÂ∞áÈúÄË¶ÅÈáçÊñ∞Ëº∏ÂÖ•ÈÇÄË´ãÁ¢º„ÄÇ')) {
                try {
                    // Ê∏ÖÈô§Êú¨Âú∞ÂÑ≤Â≠ò
                    localStorage.removeItem('inviteCodeVerified');
                    localStorage.removeItem('currentUser');
                    
                    // Â¶ÇÊûúÊúâÁï∂ÂâçÁî®Êà∂Ôºå‰πüÊ∏ÖÈô§ Firebase ‰∏≠ÁöÑÁõ∏ÈóúË≥áÊñô
                    if (currentUser && currentUser.name) {
                        // ÈÄôË£°ÂèØ‰ª•Ê∑ªÂä†Ê∏ÖÈô§Áî®Êà∂ÁâπÂÆöË≥áÊñôÁöÑÈÇèËºØÔºåÂ¶ÇÊûúÈúÄË¶ÅÁöÑË©±
                        // ‰æãÂ¶ÇÔºöawait dbService.clearUserData(currentUser.name);
                    }
                    
                    showNotification('ÈÇÄË´ãÁ¢ºÈ©óË≠âÁãÄÊÖãÂ∑≤Ê∏ÖÈô§ÔºåÈ†ÅÈù¢Â∞áÈáçÊñ∞ËºâÂÖ•„ÄÇ', 'warning');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } catch (error) {
                    console.error('Ê∏ÖÈô§ÈÇÄË´ãÁ¢ºÈ©óË≠âÁãÄÊÖãÂ§±Êïó:', error);
                    
                    // Â¶ÇÊûú Firebase Êìç‰ΩúÂ§±ÊïóÔºåËá≥Â∞ëÊ∏ÖÈô§Êú¨Âú∞ÂÑ≤Â≠ò
                    localStorage.removeItem('inviteCodeVerified');
                    localStorage.removeItem('currentUser');
                    
                    showNotification('ÈÇÄË´ãÁ¢ºÈ©óË≠âÁãÄÊÖãÂ∑≤Ê∏ÖÈô§ÔºåÈ†ÅÈù¢Â∞áÈáçÊñ∞ËºâÂÖ•„ÄÇ', 'warning');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }
        }
        
        // Âº∑Âà∂Áî®Êà∂ÈáçÊñ∞ÁôªÂÖ•ÔºàÁî®ÊñºÊõ¥Êñ∞È†≠ÂÉèÁ≠âÂÄã‰∫∫Ë≥áË®äÔºâ
        async function forceUserRelogin() {
            if (confirm('ÁÇ∫‰∫ÜÊõ¥Êñ∞ÊÇ®ÁöÑÂÄã‰∫∫Ë≥áË®äÔºàÂ¶ÇÈ†≠ÂÉèÔºâÔºåÈúÄË¶ÅÈáçÊñ∞Ë®≠ÂÆöÁî®Êà∂Ë∫´‰ªΩ„ÄÇÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü')) {
                try {
                    // ‰øùÁïôÈÇÄË´ãÁ¢ºÈ©óË≠âÁãÄÊÖãÔºåÂè™Ê∏ÖÈô§Áî®Êà∂Ë∫´‰ªΩ
                    localStorage.removeItem('currentUser');
                    
                    // ÈáçÁΩÆÂÖ®ÂüüÁî®Êà∂ËÆäÊï∏
                    currentUser = null;
                    window.currentUser = null;
                    
                    showNotification('Áî®Êà∂Ë∫´‰ªΩÂ∑≤Ê∏ÖÈô§ÔºåË´ãÈáçÊñ∞Ë®≠ÂÆöÂÄã‰∫∫Ë≥áË®ä„ÄÇ', 'warning');
                    
                    // Á´ãÂç≥È°ØÁ§∫Áî®Êà∂Ë∫´‰ªΩË®≠ÂÆöÂΩàÁ™ó
                    setTimeout(() => {
                        showUserIdentityModal();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Âº∑Âà∂ÈáçÊñ∞ÁôªÂÖ•Â§±Êïó:', error);
                    showNotification('Êìç‰ΩúÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                }
            }
        }
    </script>
    
    <!-- Firebase Ê®°ÁµÑ (ÈùûÊ®°ÁµÑÊñπÂºèËºâÂÖ•) -->
    <script src="./js/firebase-config.js"></script>
    <script src="./js/database-service.js"></script>
    <script src="./js/firebase-init.js"></script>
    
    <!-- ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö JavaScript ÂäüËÉΩ -->
    <script>
        // ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁõ∏ÈóúËÆäÊï∏
        window.confirmationItems = window.confirmationItems || [];
        
        // È°ØÁ§∫Êñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË°®ÂñÆ
        function showAddConfirmationForm() {
            document.getElementById('addConfirmationForm').style.display = 'block';
            document.getElementById('confirmationTitle').focus();
        }
        
        // Èö±ËóèÊñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË°®ÂñÆ
        function hideAddConfirmationForm() {
            document.getElementById('addConfirmationForm').style.display = 'none';
            document.getElementById('confirmationTitle').value = '';
            document.getElementById('confirmationDetails').value = '';
            document.getElementById('confirmationRelatedDay').value = '';
        }
        
        // È°ØÁ§∫Á∑®ËºØÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË°®ÂñÆ
        function showEditConfirmationForm(id) {
            // Á¢∫‰øù‰ΩøÁî®ÂÖ®ÂüüËÆäÊï∏ window.confirmationItems
            if (!window.confirmationItems) {
                window.confirmationItems = [];
                console.warn('ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÈô£Âàó‰∏çÂ≠òÂú®ÔºåÂ∑≤ÂàùÂßãÂåñÁÇ∫Á©∫Èô£Âàó');
                return;
            }
            
            const item = window.confirmationItems.find(item => item.id === id);
            if (!item) {
                console.warn(`Êâæ‰∏çÂà∞ ID ÁÇ∫ ${id} ÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö`);
                return;
            }
            
            document.getElementById('editConfirmationId').value = item.id;
            document.getElementById('editConfirmationTitle').value = item.title;
            document.getElementById('editConfirmationDetails').value = item.details;
            document.getElementById('editConfirmationRelatedDay').value = item.relatedDay;
            document.getElementById('editConfirmationForm').style.display = 'block';
            document.getElementById('editConfirmationTitle').focus();
        }
        
        // Èö±ËóèÁ∑®ËºØÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË°®ÂñÆ
        function hideEditConfirmationForm() {
            document.getElementById('editConfirmationForm').style.display = 'none';
        }
        
        // Êñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
        async function addConfirmationItem() {
            const title = document.getElementById('confirmationTitle').value.trim();
            const details = document.getElementById('confirmationDetails').value.trim();
            const relatedDay = document.getElementById('confirmationRelatedDay').value;
            
            if (!title) {
                showNotification('Ë´ãËº∏ÂÖ•‰∫ãÈ†ÖÊ®ôÈ°å', 'error');
                return;
            }
            
            const newItem = {
                id: Date.now().toString(),
                title: title,
                details: details,
                relatedDay: relatedDay,
                confirmed: false,
                createdAt: new Date().toLocaleString('zh-TW'),
                createdBy: currentUser ? currentUser.name : 'ÂåøÂêçÁî®Êà∂',
                confirmedAt: '', // ‰ΩøÁî®Á©∫Â≠ó‰∏≤ËÄåÈùû null Êàñ undefined
                confirmedBy: '' // ‰ΩøÁî®Á©∫Â≠ó‰∏≤ËÄåÈùû null Êàñ undefined
            };
            
            // Á¢∫‰øùÊâÄÊúâÂ±¨ÊÄßÈÉΩ‰∏çÊòØ undefinedÔºåFirebase ‰∏çÊé•Âèó undefined ÂÄº
            Object.keys(newItem).forEach(key => {
                if (newItem[key] === undefined) {
                    newItem[key] = '';
                }
            });
            
            try {
                // Ê∑ªÂä†Âà∞Êú¨Âú∞Èô£Âàó
                if (!window.confirmationItems) {
                    window.confirmationItems = [];
                }
                window.confirmationItems.push(newItem);
                
                // ÂÑ≤Â≠òÂà∞ localStorage ‰ΩúÁÇ∫ÂÇô‰ªΩ
                localStorage.setItem('confirmationItems', JSON.stringify(window.confirmationItems));
                
                // Â¶ÇÊûú Firebase Â∑≤ÂàùÂßãÂåñÔºå‰πüÂÑ≤Â≠òÂà∞ Firebase
                if (window.dbService && typeof window.dbService.saveConfirmationItems === 'function') {
                    console.log('Ê≠£Âú®Â∞áÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase...');
                    const result = await window.dbService.saveConfirmationItems(window.confirmationItems);
                    if (result) {
                        console.log('ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ∑≤ÊàêÂäüÂÑ≤Â≠òÂà∞ Firebase');
                    } else {
                        console.warn('ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase Â§±ÊïóÔºå‰ΩÜÂ∑≤ÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                    }
                } else {
                    console.warn('Firebase Êú™ÂàùÂßãÂåñÊàñ saveConfirmationItems ÊñπÊ≥ï‰∏çÂèØÁî®ÔºåÂÉÖÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂàóË°®
                renderConfirmationItems();
                
                // Èö±ËóèË°®ÂñÆ
                hideAddConfirmationForm();
                
                showNotification('Â∑≤Êñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö');
            } catch (error) {
                console.error('Êñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±Êïó:', error);
                showNotification('Êñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }
        
        // Êõ¥Êñ∞ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
        async function updateConfirmationItem() {
            const id = document.getElementById('editConfirmationId').value;
            const title = document.getElementById('editConfirmationTitle').value.trim();
            const details = document.getElementById('editConfirmationDetails').value.trim();
            const relatedDay = document.getElementById('editConfirmationRelatedDay').value;
            
            if (!title) {
                showNotification('Ë´ãËº∏ÂÖ•‰∫ãÈ†ÖÊ®ôÈ°å', 'error');
                return;
            }
            
            try {
                // Á¢∫‰øù confirmationItems Â≠òÂú®
                if (!window.confirmationItems) {
                    window.confirmationItems = [];
                }
                
                // ÊâæÂà∞‰∏¶Êõ¥Êñ∞È†ÖÁõÆ
                const itemIndex = window.confirmationItems.findIndex(item => item.id === id);
                if (itemIndex === -1) {
                    showNotification('Êâæ‰∏çÂà∞Ë¶ÅÊõ¥Êñ∞ÁöÑ‰∫ãÈ†Ö', 'error');
                    return;
                }
                
                // ‰øùÁïôÂéüÊúâÁöÑÁ¢∫Ë™çÁãÄÊÖãÂíåÁ¢∫Ë™çËÄÖË≥áË®ä
                const confirmed = window.confirmationItems[itemIndex].confirmed;
                const confirmedAt = window.confirmationItems[itemIndex].confirmedAt;
                const confirmedBy = window.confirmationItems[itemIndex].confirmedBy;
                
                // Êõ¥Êñ∞È†ÖÁõÆ
                window.confirmationItems[itemIndex] = {
                    ...window.confirmationItems[itemIndex],
                    title: title,
                    details: details,
                    relatedDay: relatedDay,
                    confirmed: confirmed,
                    confirmedAt: confirmedAt === undefined || confirmedAt === null ? '' : confirmedAt,
                    confirmedBy: confirmedBy === undefined || confirmedBy === null ? '' : confirmedBy
                };
                
                // ÂÑ≤Â≠òÂà∞ localStorage ‰ΩúÁÇ∫ÂÇô‰ªΩ
                localStorage.setItem('confirmationItems', JSON.stringify(window.confirmationItems));
                
                // Â¶ÇÊûú Firebase Â∑≤ÂàùÂßãÂåñÔºå‰πüÂÑ≤Â≠òÂà∞ Firebase
                if (window.dbService && typeof window.dbService.saveConfirmationItems === 'function') {
                    console.log('Ê≠£Âú®Â∞áÊõ¥Êñ∞ÂæåÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase...');
                    const result = await window.dbService.saveConfirmationItems(window.confirmationItems);
                    if (result) {
                        console.log('Êõ¥Êñ∞ÂæåÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ∑≤ÊàêÂäüÂÑ≤Â≠òÂà∞ Firebase');
                    } else {
                        console.warn('Êõ¥Êñ∞ÂæåÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase Â§±ÊïóÔºå‰ΩÜÂ∑≤ÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                    }
                } else {
                    console.warn('Firebase Êú™ÂàùÂßãÂåñÊàñ saveConfirmationItems ÊñπÊ≥ï‰∏çÂèØÁî®ÔºåÂÉÖÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂàóË°®
                renderConfirmationItems();
                
                // Èö±ËóèË°®ÂñÆ
                hideEditConfirmationForm();
                
                showNotification('Â∑≤Êõ¥Êñ∞ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö');
            } catch (error) {
                console.error('Êõ¥Êñ∞ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±Êïó:', error);
                showNotification('Êõ¥Êñ∞ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }
        
        // Á¢∫Ë™çÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
        async function confirmItem(id) {
            try {
                // Á¢∫‰øù confirmationItems Â≠òÂú®
                if (!window.confirmationItems) {
                    window.confirmationItems = [];
                }
                
                // ÊâæÂà∞‰∏¶Êõ¥Êñ∞È†ÖÁõÆ
                const itemIndex = window.confirmationItems.findIndex(item => item.id === id);
                if (itemIndex === -1) {
                    showNotification('Êâæ‰∏çÂà∞Ë¶ÅÁ¢∫Ë™çÁöÑ‰∫ãÈ†Ö', 'error');
                    return;
                }
                
                // Êõ¥Êñ∞Á¢∫Ë™çÁãÄÊÖã
                window.confirmationItems[itemIndex].confirmed = true;
                window.confirmationItems[itemIndex].confirmedAt = new Date().toLocaleString('zh-TW');
                window.confirmationItems[itemIndex].confirmedBy = currentUser ? currentUser.name : 'ÂåøÂêçÁî®Êà∂';
                
                // Á¢∫‰øù confirmedAt Âíå confirmedBy ‰∏çÊòØ undefined Êàñ null
                if (window.confirmationItems[itemIndex].confirmedAt === undefined || window.confirmationItems[itemIndex].confirmedAt === null) {
                    window.confirmationItems[itemIndex].confirmedAt = '';
                }
                if (window.confirmationItems[itemIndex].confirmedBy === undefined || window.confirmationItems[itemIndex].confirmedBy === null) {
                    window.confirmationItems[itemIndex].confirmedBy = '';
                }
                
                // ÂÑ≤Â≠òÂà∞ localStorage ‰ΩúÁÇ∫ÂÇô‰ªΩ
                localStorage.setItem('confirmationItems', JSON.stringify(window.confirmationItems));
                
                // Â¶ÇÊûú Firebase Â∑≤ÂàùÂßãÂåñÔºå‰πüÂÑ≤Â≠òÂà∞ Firebase
                if (window.dbService && typeof window.dbService.saveConfirmationItems === 'function') {
                    console.log('Ê≠£Âú®Â∞áÂ∑≤Á¢∫Ë™çÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase...');
                    const result = await window.dbService.saveConfirmationItems(window.confirmationItems);
                    if (result) {
                        console.log('Â∑≤Á¢∫Ë™çÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ∑≤ÊàêÂäüÂÑ≤Â≠òÂà∞ Firebase');
                    } else {
                        console.warn('Â∑≤Á¢∫Ë™çÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase Â§±ÊïóÔºå‰ΩÜÂ∑≤ÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                    }
                } else {
                    console.warn('Firebase Êú™ÂàùÂßãÂåñÊàñ saveConfirmationItems ÊñπÊ≥ï‰∏çÂèØÁî®ÔºåÂÉÖÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂàóË°®
                renderConfirmationItems();
                
                showNotification('Â∑≤Á¢∫Ë™ç‰∫ãÈ†Ö');
            } catch (error) {
                console.error('Á¢∫Ë™ç‰∫ãÈ†ÖÂ§±Êïó:', error);
                showNotification('Á¢∫Ë™ç‰∫ãÈ†ÖÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }
        
        // Âà™Èô§ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
        async function deleteConfirmationItem(id) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂóéÔºü')) return;
            
            try {
                // Á¢∫‰øù confirmationItems Â≠òÂú®
                if (!window.confirmationItems) {
                    window.confirmationItems = [];
                    showNotification('Êâæ‰∏çÂà∞Ë¶ÅÂà™Èô§ÁöÑ‰∫ãÈ†Ö', 'error');
                    return;
                }
                
                // ÂæûÈô£Âàó‰∏≠ÁßªÈô§È†ÖÁõÆ
                window.confirmationItems = window.confirmationItems.filter(item => item.id !== id);
                
                // Á¢∫‰øùÊâÄÊúâÈ†ÖÁõÆÁöÑÊâÄÊúâÂ±¨ÊÄßÈÉΩ‰∏çÊòØ undefinedÔºåFirebase ‰∏çÊé•Âèó undefined ÂÄº
                window.confirmationItems.forEach(item => {
                    Object.keys(item).forEach(key => {
                        if (item[key] === undefined) {
                            item[key] = '';
                        }
                    });
                });
                
                // ÂÑ≤Â≠òÂà∞ localStorage ‰ΩúÁÇ∫ÂÇô‰ªΩ
                localStorage.setItem('confirmationItems', JSON.stringify(window.confirmationItems));
                
                // Â¶ÇÊûú Firebase Â∑≤ÂàùÂßãÂåñÔºå‰πüÂÑ≤Â≠òÂà∞ Firebase
                if (window.dbService && typeof window.dbService.saveConfirmationItems === 'function') {
                    console.log('Ê≠£Âú®Â∞áÊõ¥Êñ∞ÂæåÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase...');
                    const result = await window.dbService.saveConfirmationItems(window.confirmationItems);
                    if (result) {
                        console.log('Âà™Èô§ÂæåÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ∑≤ÊàêÂäüÂÑ≤Â≠òÂà∞ Firebase');
                    } else {
                        console.warn('Âà™Èô§ÂæåÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂÑ≤Â≠òÂà∞ Firebase Â§±ÊïóÔºå‰ΩÜÂ∑≤ÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                    }
                } else {
                    console.warn('Firebase Êú™ÂàùÂßãÂåñÊàñ saveConfirmationItems ÊñπÊ≥ï‰∏çÂèØÁî®ÔºåÂÉÖÂÑ≤Â≠òÂà∞Êú¨Âú∞');
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂàóË°®
                renderConfirmationItems();
                
                showNotification('Â∑≤Âà™Èô§ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö');
            } catch (error) {
                console.error('Âà™Èô§ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±Êïó:', error);
                showNotification('Âà™Èô§ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }
        
        // ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
        async function loadConfirmationItems() {
            try {
                // Â¶ÇÊûú Firebase Â∑≤ÂàùÂßãÂåñÔºåÂæû Firebase ËºâÂÖ•
                if (window.dbService && typeof window.dbService.getConfirmationItems === 'function') {
                    const items = await window.dbService.getConfirmationItems();
                    if (items && items.length > 0) {
                        window.confirmationItems = items;
                        renderConfirmationItems();
                        return;
                    }
                    
                    // Â¶ÇÊûú Firebase ‰∏≠Ê≤íÊúâË≥áÊñôÔºå‰ΩÜÊúâÊú¨Âú∞Ë≥áÊñôÔºåÂâáÂ∞áÊú¨Âú∞Ë≥áÊñôÂêåÊ≠•Âà∞ Firebase
                    const saved = localStorage.getItem('confirmationItems');
                    if (saved) {
                        const localItems = JSON.parse(saved);
                        if (localItems && localItems.length > 0) {
                            window.confirmationItems = localItems;
                            // ÂêåÊ≠•Âà∞ Firebase
                            if (typeof window.dbService.saveConfirmationItems === 'function') {
                                await window.dbService.saveConfirmationItems(localItems);
                                console.log('Â∑≤Â∞áÊú¨Âú∞ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂêåÊ≠•Âà∞ Firebase');
                            }
                            renderConfirmationItems();
                            return;
                        }
                    }
                    
                    // Â¶ÇÊûú Firebase ÂíåÊú¨Âú∞ÈÉΩÊ≤íÊúâË≥áÊñôÔºåÂàùÂßãÂåñ‰∏Ä‰∫õÁØÑ‰æãË≥áÊñô
                    window.confirmationItems = [
                        {
                            id: '1',
                            title: 'Á¢∫Ë™çÈ§êÂª≥Ë®Ç‰Ωç',
                            details: 'ÈúÄË¶ÅÂú®8/5ÂâçÁ¢∫Ë™çÊó•ÊúàÊΩ≠È§êÂª≥ÁöÑË®Ç‰ΩçÔºåËÅØÁµ°ÈõªË©±: 049-123456',
                            relatedDay: 'day2',
                            confirmed: false,
                            createdAt: '2024/7/20 10:00:00',
                            createdBy: 'Á≥ªÁµ±',
                            confirmedAt: '', // ‰ΩøÁî®Á©∫Â≠ó‰∏≤ËÄåÈùû null Êàñ undefined
                            confirmedBy: '' // ‰ΩøÁî®Á©∫Â≠ó‰∏≤ËÄåÈùû null Êàñ undefined
                        },
                        {
                            id: '2',
                            title: 'Á¢∫Ë™çÁ´ãÊß≥È†êÁ¥ÑÊôÇÈñì',
                            details: 'ÈúÄË¶ÅÁ¢∫Ë™çÁ´ãÊß≥È´îÈ©óÁöÑÈ†êÁ¥ÑÊôÇÈñìÔºåÂèØËÉΩÈúÄË¶ÅÊèêÂâç30ÂàÜÈêòÂà∞ÈÅî',
                            relatedDay: 'day2',
                            confirmed: true,
                            createdAt: '2024/7/20 10:00:00',
                            createdBy: 'Á≥ªÁµ±',
                            confirmedAt: '2024/7/25 15:30:00',
                            confirmedBy: 'Â∞èÈõ∑'
                        }
                    ];
                    
                    // Á¢∫‰øùÊâÄÊúâÈ†ÖÁõÆÁöÑÊâÄÊúâÂ±¨ÊÄßÈÉΩ‰∏çÊòØ undefinedÔºåFirebase ‰∏çÊé•Âèó undefined ÂÄº
                    window.confirmationItems.forEach(item => {
                        Object.keys(item).forEach(key => {
                            if (item[key] === undefined) {
                                item[key] = '';
                            }
                        });
                    });
                    localStorage.setItem('confirmationItems', JSON.stringify(window.confirmationItems));
                    
                    // ÂêåÊ≠•Âà∞ Firebase
                    if (typeof window.dbService.saveConfirmationItems === 'function') {
                        try {
                            await window.dbService.saveConfirmationItems(window.confirmationItems);
                            console.log('Â∑≤Â∞áÂàùÂßãÂåñÁöÑÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂêåÊ≠•Âà∞ Firebase');
                        } catch (err) {
                            console.error('ÂàùÂßãÂåñÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂà∞ Firebase Â§±Êïó:', err);
                        }
                    }
                }
                
                renderConfirmationItems();
                // ÂàùÂßãÂåñÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊú™ËÆÄÊåáÁ§∫Âô®
                updateConfirmationItemUnreadIndicators();
            } catch (error) {
                console.error('ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±Êïó:', error);
                showNotification('ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }
        
        // Ê∏≤ÊüìÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂàóË°®
        function renderConfirmationItems() {
            const container = document.getElementById('confirmationItems');
            if (!container) return;
            
            // Á¢∫‰øù window.confirmationItems Â≠òÂú®
            if (!window.confirmationItems) {
                window.confirmationItems = [];
                console.warn('ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÈô£Âàó‰∏çÂ≠òÂú®ÔºåÂ∑≤ÂàùÂßãÂåñÁÇ∫Á©∫Èô£Âàó');
            }
            
            // ÂÖàÊéíÂ∫èÔºöÊú™Á¢∫Ë™çÁöÑÂú®ÂâçÔºåÂ∑≤Á¢∫Ë™çÁöÑÂú®ÂæåÔºåÂêå‰∏ÄÁãÄÊÖã‰∏ãÊåâÂâµÂª∫ÊôÇÈñìÊéíÂ∫è
            const sortedItems = [...window.confirmationItems].sort((a, b) => {
                if (a.confirmed !== b.confirmed) {
                    return a.confirmed ? 1 : -1; // Êú™Á¢∫Ë™çÁöÑÂú®Ââç
                }
                return new Date(b.createdAt) - new Date(a.createdAt); // Êñ∞Âª∫Á´ãÁöÑÂú®Ââç
            });
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            container.innerHTML = '';
            
            // Â¶ÇÊûúÊ≤íÊúâÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÔºåÈ°ØÁ§∫ÊèêÁ§∫
            if (sortedItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">ÁõÆÂâçÊ≤íÊúâÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö</div>';
                return;
            }
            
            // Ê∏≤ÊüìÊØèÂÄãÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
            sortedItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `confirmation-item ${item.confirmed ? 'confirmed' : ''}`;
                
                // Ê†πÊìöÈóúËÅØÊó•ÊúüÈ°ØÁ§∫‰∏çÂêåÁöÑÊ®ôÁ±§
                let dayLabel = '';
                switch (item.relatedDay) {
                    case 'day1':
                        dayLabel = '8/8 (‰∫î)';
                        break;
                    case 'day2':
                        dayLabel = '8/9 (ÂÖ≠)';
                        break;
                    case 'day3':
                        dayLabel = '8/10 (Êó•)';
                        break;
                    case 'all':
                        dayLabel = 'ÂÖ®ÈÉ®Êó•Êúü';
                        break;
                    default:
                        dayLabel = 'Êú™ÊåáÂÆöÊó•Êúü';
                }
                
                itemElement.innerHTML = `
                    <div class="confirmation-item-header">
                        <div class="confirmation-item-title">${item.title}</div>
                        <div class="confirmation-item-status ${item.confirmed ? 'status-confirmed' : 'status-pending'}">
                            ${item.confirmed ? 'Â∑≤Á¢∫Ë™ç' : 'ÂæÖÁ¢∫Ë™ç'}
                        </div>
                    </div>
                    <div class="confirmation-item-details">${item.details}</div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">
                        <span>Áõ∏ÈóúÊó•Êúü: ${dayLabel}</span>
                        <span style="margin-left: 10px;">Âª∫Á´ãËÄÖ: ${item.createdBy}</span>
                    </div>
                    ${item.confirmed && item.confirmedBy && item.confirmedBy !== '' && item.confirmedBy !== undefined && item.confirmedAt && item.confirmedAt !== '' && item.confirmedAt !== undefined ? `
                        <div style="font-size: 12px; color: #27ae60; margin-bottom: 10px;">
                            Á¢∫Ë™çËÄÖ: ${item.confirmedBy} (${item.confirmedAt})
                        </div>
                    ` : ''}
                    <div class="confirmation-item-actions">
                        ${!item.confirmed ? `
                            <button onclick="confirmItem('${item.id}')" class="confirmation-btn btn-confirm">Á¢∫Ë™ç</button>
                        ` : ''}
                        <button onclick="showEditConfirmationForm('${item.id}')" class="confirmation-btn btn-edit">Á∑®ËºØ</button>
                        <button onclick="deleteConfirmationItem('${item.id}')" class="confirmation-btn btn-delete">Âà™Èô§</button>
                        <button onclick="toggleConfirmationItemDiscussion('${item.id}')" class="confirmation-btn" style="background-color: #3498db; color: white; position: relative;">üí¨ Ë®éË´ñ</button>
                    </div>
                    <div id="confirmation-discussion-${item.id}" class="confirmation-discussion" style="display: none; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;"></div>
                `;
                
                container.appendChild(itemElement);
            });
        }
    </script>
    
    <!-- ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË®éË´ñÂäüËÉΩ -->
    <script>
        // ÂàáÊèõÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË®éË´ñÂçÄÈ°ØÁ§∫
        async function toggleConfirmationItemDiscussion(itemId) {
            const discussionDiv = document.getElementById(`confirmation-discussion-${itemId}`);
            
            if (discussionDiv.style.display === 'none') {
                // È°ØÁ§∫Ë®éË´ñÂçÄ‰∏¶ÂàùÂßãÂåñÂÖßÂÆπ
                discussionDiv.style.display = 'block';
                initConfirmationItemDiscussion(itemId);
                await loadConfirmationItemComments(itemId);
                
                // Êõ¥Êñ∞ÊúÄÂæåÊü•ÁúãÊôÇÈñì
                if (currentUser) {
                    await dbService.updateConfirmationItemLastViewTime(currentUser.name, itemId);
                    // Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                    updateConfirmationItemUnreadIndicators();
                }
            } else {
                // Èö±ËóèË®éË´ñÂçÄ
                discussionDiv.style.display = 'none';
            }
        }

        // ÂàùÂßãÂåñÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖË®éË´ñÂçÄ
        function initConfirmationItemDiscussion(itemId) {
            const discussionDiv = document.getElementById(`confirmation-discussion-${itemId}`);
            
            if (discussionDiv.innerHTML === '') {
                discussionDiv.innerHTML = `
                     <h4 style="margin-bottom: 15px; color: #2c3e50; font-size: 16px;">üí¨ Ë®éË´ñÂçÄ</h4>
                     <div class="confirmation-comment-form">
                         <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px; color: #2c3e50; font-weight: bold; font-size: 14px;">
                             ÁôºË°®ËÄÖÔºö<span class="current-user-name">${currentUser ? currentUser.name : 'Êú™ÁôªÂÖ•'}</span>
                         </div>
                         <textarea id="confirmation-text-${itemId}" placeholder="Â∞çÈÄôÂÄãÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊúâ‰ªÄÈ∫ºÊÉ≥Ê≥ïÊàñÂª∫Ë≠∞Ôºü" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; min-height: 80px;"></textarea>
                         <button class="btn btn-success" onclick="addConfirmationItemComment('${itemId}')" style="font-size: 12px; padding: 6px 12px; margin-top: 8px;">ÁôºË°®ÁïôË®Ä</button>
                     </div>
                     <div id="${itemId}-comments" class="confirmation-comments" style="margin-top: 15px;">
                         <!-- ÁïôË®ÄÊúÉÂãïÊÖãËºâÂÖ•Âà∞ÈÄôË£° -->
                     </div>
                 `;
                 
                 // Êõ¥Êñ∞Êñ∞Âª∫Á´ãÁöÑÁî®Êà∂È°ØÁ§∫
                 setTimeout(() => {
                     updateCurrentUserDisplay();
                 }, 0);
            }
        }

        // Êñ∞Â¢ûÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁïôË®Ä
        async function addConfirmationItemComment(itemId, replyToId = null) {
            const textElement = document.getElementById(`confirmation-text-${itemId}`);
            
            if (!textElement) {
                showNotification('Êâæ‰∏çÂà∞Ë°®ÂñÆÂÖÉÁ¥†', 'error');
                return;
            }
            
            if (!currentUser) {
                showNotification('Ë´ãÂÖàË®≠ÂÆöÂÄã‰∫∫ID', 'error');
                return;
            }
            
            const text = textElement.value.trim();
            
            if (!text) {
                showNotification('Ë´ãÂ°´ÂØ´ÁïôË®ÄÂÖßÂÆπ', 'error');
                return;
            }
            
            const author = currentUser.name;
            
            const comment = {
                id: Date.now(),
                author: author,
                text: text,
                timestamp: new Date().toISOString(),
                replyTo: replyToId,
                replies: []
            };
            
            try {
                // Âæû Firebase Áç≤ÂèñÁï∂ÂâçÁïôË®Ä
                let comments = await dbService.getConfirmationItemComments(itemId) || [];
                
                if (replyToId) {
                    // ÊâæÂà∞Ë¢´ÂõûÂæ©ÁöÑÁïôË®Ä‰∏¶Ê∑ªÂä†ÂõûÂæ©
                    const parentComment = findCommentById(comments, replyToId);
                    if (parentComment) {
                        if (!parentComment.replies) {
                            parentComment.replies = [];
                        }
                        parentComment.replies.push(comment);
                    }
                } else {
                    // Êñ∞ÁöÑ‰∏ªÁïôË®Ä
                    comments.unshift(comment);
                }
                
                // Êõ¥Êñ∞ Firebase
                await dbService.saveConfirmationItemComments(itemId, comments);
                
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                textElement.value = '';
                showNotification('ÁïôË®ÄÂ∑≤ÁôºË°®ÔºÅ');
            } catch (error) {
                console.error('ÁôºË°®ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁïôË®ÄÂ§±Êïó:', error);
                showNotification('ÁôºË°®ÁïôË®ÄÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // Ê∏≤ÊüìÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁïôË®ÄÂàóË°®
        function renderConfirmationItemComments(itemId, comments) {
            const commentsList = document.getElementById(`${itemId}-comments`);
            
            commentsList.innerHTML = '';
            
            if (!comments || comments.length === 0) {
                commentsList.innerHTML = '<p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">ÈÇÑÊ≤íÊúâ‰∫∫Ë®éË´ñÈÄôÂÄã‰∫ãÈ†ÖÔºåÂø´‰æÜÁïô‰∏ãÁ¨¨‰∏ÄÂÄãÊÑèË¶ãÂêßÔºÅ</p>';
                return;
            }
            
            comments.forEach(comment => {
                renderConfirmationItemComment(comment, commentsList, itemId, 0);
            });
        }
        
        // Ê∏≤ÊüìÂñÆÂÄãÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁïôË®ÄÔºàÊîØÊè¥Â∑¢ÁãÄÂõûÂæ©Ôºâ
        function renderConfirmationItemComment(comment, container, itemId, depth = 0) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'confirmation-comment';
            commentDiv.style.marginLeft = `${depth * 15}px`;
            commentDiv.style.marginBottom = '10px';
            commentDiv.style.padding = '10px';
            commentDiv.style.backgroundColor = depth > 0 ? '#f1f8ff' : '#f5f5f5';
            commentDiv.style.borderRadius = '5px';
            commentDiv.style.border = depth > 0 ? '1px solid #d1e4ff' : '1px solid #e0e0e0';
            
            commentDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: bold; color: #2c3e50;">${comment.author}</span>
                    <span style="color: #7f8c8d; font-size: 12px;">${formatTimestamp(comment.timestamp)}</span>
                </div>
                <div style="margin-bottom: 8px;">${comment.text}</div>
                <div>
                    <button onclick="showConfirmationItemReplyForm('${itemId}', ${comment.id})" style="font-size: 11px; padding: 2px 6px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">ÂõûÂæ©</button>
                </div>
                <div id="confirmation-reply-form-${itemId}-${comment.id}" class="confirmation-reply-form" style="display: none; margin-top: 8px; padding: 8px; background: #ecf0f1; border-radius: 5px;">
                    <div style="margin-bottom: 6px; padding: 4px; background: #f8f9fa; border-radius: 3px; color: #2c3e50; font-size: 11px;">
                        ÂõûË¶ÜËÄÖÔºö<span class="current-user-name">${currentUser ? currentUser.name : 'Êú™ÁôªÂÖ•'}</span>
                    </div>
                    <textarea id="confirmation-reply-text-${itemId}-${comment.id}" placeholder="ÂõûÂæ© ${comment.author} ÁöÑÁïôË®Ä..." style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 3px; resize: vertical; min-height: 50px; font-size: 12px;"></textarea>
                    <div style="margin-top: 6px;">
                        <button onclick="submitConfirmationItemReply('${itemId}', ${comment.id})" style="padding: 4px 8px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 4px; font-size: 11px;">ÁôºË°®ÂõûÂæ©</button>
                        <button onclick="hideConfirmationItemReplyForm('${itemId}', ${comment.id})" style="padding: 4px 8px; background: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">ÂèñÊ∂à</button>
                    </div>
                </div>
            `;
            
            container.appendChild(commentDiv);
            
            // Êõ¥Êñ∞Êñ∞Âª∫Á´ãÁöÑÁî®Êà∂È°ØÁ§∫
            setTimeout(() => {
                updateCurrentUserDisplay();
            }, 0);
            
            // Ê∏≤ÊüìÂõûÂæ©
            if (comment.replies && comment.replies.length > 0) {
                comment.replies.forEach(reply => {
                    renderConfirmationItemComment(reply, container, itemId, depth + 1);
                });
            }
        }
        
        // È°ØÁ§∫ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂõûÂæ©Ë°®ÂñÆ
        function showConfirmationItemReplyForm(itemId, commentId) {
            // Èö±ËóèÊâÄÊúâÂÖ∂‰ªñÂõûÂæ©Ë°®ÂñÆ
            document.querySelectorAll('.confirmation-reply-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // È°ØÁ§∫ÊåáÂÆöÁöÑÂõûÂæ©Ë°®ÂñÆ
            const replyForm = document.getElementById(`confirmation-reply-form-${itemId}-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'block';
                const textArea = document.getElementById(`confirmation-reply-text-${itemId}-${commentId}`);
                if (textArea) textArea.focus();
            }
        }
        
        // Èö±ËóèÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂõûÂæ©Ë°®ÂñÆ
        function hideConfirmationItemReplyForm(itemId, commentId) {
            const replyForm = document.getElementById(`confirmation-reply-form-${itemId}-${commentId}`);
            if (replyForm) {
                replyForm.style.display = 'none';
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                const textArea = document.getElementById(`confirmation-reply-text-${itemId}-${commentId}`);
                if (textArea) textArea.value = '';
            }
        }
        
        // Êèê‰∫§ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂõûÂæ©
        async function submitConfirmationItemReply(itemId, commentId) {
            const textElement = document.getElementById(`confirmation-reply-text-${itemId}-${commentId}`);
            
            if (!textElement) {
                showNotification('Êâæ‰∏çÂà∞ÂõûÂæ©Ë°®ÂñÆÂÖÉÁ¥†', 'error');
                return;
            }
            
            if (!currentUser) {
                showNotification('Ë´ãÂÖàË®≠ÂÆöÂÄã‰∫∫ID', 'error');
                return;
            }
            
            const text = textElement.value.trim();
            
            if (!text) {
                showNotification('Ë´ãÂ°´ÂØ´ÂõûÂæ©ÂÖßÂÆπ', 'error');
                return;
            }
            
            const author = currentUser.name;
            
            const reply = {
                id: Date.now(),
                author: author,
                text: text,
                timestamp: new Date().toISOString(),
                replyTo: commentId,
                replies: []
            };
            
            try {
                // Âæû Firebase Áç≤ÂèñÁï∂ÂâçÁïôË®Ä
                let comments = await dbService.getConfirmationItemComments(itemId) || [];
                
                // ÊâæÂà∞Ë¢´ÂõûÂæ©ÁöÑÁïôË®Ä‰∏¶Ê∑ªÂä†ÂõûÂæ©
                const parentComment = findCommentById(comments, commentId);
                if (parentComment) {
                    if (!parentComment.replies) {
                        parentComment.replies = [];
                    }
                    parentComment.replies.push(reply);
                    
                    // Êõ¥Êñ∞ Firebase
                    await dbService.saveConfirmationItemComments(itemId, comments);
                    
                    hideConfirmationItemReplyForm(itemId, commentId);
                    showNotification('ÂõûÂæ©Â∑≤ÁôºË°®ÔºÅ');
                } else {
                    console.error(`Êâæ‰∏çÂà∞ÂéüÁïôË®Ä ID: ${commentId}Ôºå‰∫ãÈ†Ö ID: ${itemId}`);
                    showNotification('Êâæ‰∏çÂà∞ÂéüÁïôË®Ä', 'error');
                }
            } catch (error) {
                console.error('ÁôºË°®ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂõûÂæ©Â§±Êïó:', error);
                showNotification('ÁôºË°®ÂõûÂæ©Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        // ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁïôË®Ä
        async function loadConfirmationItemComments(itemId) {
            try {
                // Âæû Firebase Áç≤ÂèñÁâπÂÆöÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁöÑÁïôË®Ä
                const comments = await dbService.getConfirmationItemComments(itemId);
                
                // Ê∏≤ÊüìÁïôË®Ä
                renderConfirmationItemComments(itemId, comments);
                
                // Ë®≠ÁΩÆÁõ£ËÅΩ
                dbService.listenToConfirmationItemComments(itemId, (updatedComments) => {
                    renderConfirmationItemComments(itemId, updatedComments);
                    // Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                    updateConfirmationItemUnreadIndicators();
                });
                
                // Êõ¥Êñ∞ÊúÄÂæåÊü•ÁúãÊôÇÈñì
                if (currentUser) {
                    await dbService.updateConfirmationItemLastViewTime(currentUser.name, itemId);
                }
            } catch (error) {
                console.error(`ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö ${itemId} ÁöÑÁïôË®ÄÂ§±Êïó:`, error);
                showNotification('ËºâÂÖ•ÁïôË®ÄÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }
        
        // Ê™¢Êü•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊòØÂê¶ÊúâÊú™ËÆÄÁïôË®Ä
        async function hasUnreadConfirmationItemComments(itemId) {
            try {
                if (!currentUser) return false;
                
                // Áç≤ÂèñÊúÄÂæåÊü•ÁúãÊôÇÈñì
                const lastViewTime = await dbService.getConfirmationItemLastViewTime(currentUser.name, itemId);
                const comments = await dbService.getConfirmationItemComments(itemId) || [];
                
                // Ê™¢Êü•ÊòØÂê¶ÊúâÊñ∞ÁïôË®ÄÊàñÂõûÂæ©
                for (let comment of comments) {
                    if (new Date(comment.timestamp) > new Date(lastViewTime)) {
                        return true;
                    }
                    // Ê™¢Êü•ÂõûÂæ©
                    if (comment.replies) {
                        for (let reply of comment.replies) {
                            if (new Date(reply.timestamp) > new Date(lastViewTime)) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            } catch (error) {
                console.error('Ê™¢Êü•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊú™ËÆÄÁïôË®ÄÂ§±Êïó:', error);
                return false;
            }
        }
        
        // Êõ¥Êñ∞ÊâÄÊúâÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊú™ËÆÄÊåáÁ§∫Âô®
        async function updateConfirmationItemUnreadIndicators() {
            try {
                // Êü•ÊâæÊâÄÊúâË®éË´ñÊåâÈàï‰∏¶Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                const buttons = document.querySelectorAll('button[onclick*="toggleConfirmationItemDiscussion"]');
                
                for (const button of buttons) {
                    const onclickAttr = button.getAttribute('onclick');
                    const match = onclickAttr.match(/toggleConfirmationItemDiscussion\('([^']+)'\)/);
                    if (match) {
                        const itemId = match[1];
                        await updateConfirmationItemUnreadIndicator(itemId, button);
                    }
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊú™ËÆÄÊåáÁ§∫Âô®Â§±Êïó:', error);
            }
        }
        
        // Êõ¥Êñ∞ÂñÆÂÄãÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊú™ËÆÄÊåáÁ§∫Âô®
        async function updateConfirmationItemUnreadIndicator(itemId, button) {
            try {
                // ÁßªÈô§ÁèæÊúâÁöÑÊú™ËÆÄÊåáÁ§∫Âô®
                const existingIndicator = button.querySelector('.unread-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
    
                // Â¶ÇÊûúÊúâÊú™ËÆÄÁïôË®ÄÔºåÊ∑ªÂä†ÊåáÁ§∫Âô®
                const hasUnread = await hasUnreadConfirmationItemComments(itemId);
                if (hasUnread) {
                    const indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                    indicator.innerHTML = 'üî¥';
                    indicator.style.cssText = `
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        font-size: 12px;
                        animation: pulse 2s infinite;
                    `;
                    button.style.position = 'relative';
                    button.appendChild(indicator);
                }
            } catch (error) {
                console.error(`Êõ¥Êñ∞ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö ${itemId} ÁöÑÊú™ËÆÄÊåáÁ§∫Âô®Â§±Êïó:`, error);
            }
        }
    </script>
    
    <!-- ÈÄöÁî®ÂáΩÊï∏ -->
    <script>
        // Âú®ÁïôË®ÄÂàóË°®‰∏≠ÈÅûËø¥Êü•ÊâæÁâπÂÆö ID ÁöÑÁïôË®Ä
        function findCommentById(comments, commentId) {
            if (!comments || !Array.isArray(comments)) return null;
            
            // ÂÖàÂú®È†ÇÂ±§ÁïôË®Ä‰∏≠Êü•Êâæ
            const comment = comments.find(c => c.id == commentId);
            if (comment) return comment;
            
            // Â¶ÇÊûúÈ†ÇÂ±§Ê≤íÊúâÊâæÂà∞ÔºåÂâáÂú®ÊâÄÊúâÂõûÂæ©‰∏≠Êü•Êâæ
            for (const c of comments) {
                if (c.replies && Array.isArray(c.replies) && c.replies.length > 0) {
                    const found = findCommentById(c.replies, commentId);
                    if (found) return found;
                }
            }
            
            return null;
        }
    </script>
    
    <script>
        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ Firebase
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Ê™¢Êü• Firebase Áõ∏ÈóúÂáΩÊï∏ÊòØÂê¶Â∑≤ËºâÂÖ•
                if (window.checkAndMigrateData) {
                    // ÂòóË©¶ÈÅ∑ÁßªË≥áÊñô
                    await window.checkAndMigrateData();
                } else {
                    console.warn('Firebase ÂàùÂßãÂåñÂ§±Êïó: checkAndMigrateData Êú™ÂÆöÁæ©ÔºåÂ∞á‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô');
                }
            } catch (error) {
                console.error('Firebase Ë≥áÊñôÈÅ∑ÁßªÂ§±Êïó:', error);
                console.warn('Â∞á‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô');
            } finally {
                // ÁÑ°Ë´ñ Firebase ÊòØÂê¶ÂàùÂßãÂåñÊàêÂäüÔºåÈÉΩÂàùÂßãÂåñÈ†ÅÈù¢Ë≥áÊñô
                initializePageData();
            }
        });
        
        // ÂàùÂßãÂåñÈ†ÅÈù¢Ë≥áÊñô
        async function initializePageData() {
            try {
                // Ê™¢Êü• dbService ÊòØÂê¶Â∑≤Ê≠£Á¢∫ÂàùÂßãÂåñ
                if (!window.dbService) {
                    console.warn('dbService Êú™ÂÆöÁæ©ÔºåFirebase ÂèØËÉΩÊú™Ê≠£Á¢∫ÂàùÂßãÂåñÔºåÂ∞á‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô');
                    // ÂæûÊú¨Âú∞ÂÑ≤Â≠òËºâÂÖ•Ë≥áÊñô
                    loadDataFromLocalStorage();
                    return;
                }
                
                // Áõ£ËÅΩÂÖ®ÂüüÁïôË®ÄËÆäÂåñ
                if (typeof window.dbService.listenToComments === 'function') {
                    window.dbService.listenToComments(comments => {
                        window.comments = comments || [];
                        renderComments();
                    });
                } else {
                    console.warn('ÁïôË®ÄÁõ£ËÅΩÂäüËÉΩ‰∏çÂèØÁî®');
                    const savedComments = localStorage.getItem('comments');
                    window.comments = savedComments ? JSON.parse(savedComments) : [];
                    renderComments();
                }
                
                // È†êËºâÂÖ•ÊâÄÊúâÊ¥ªÂãïÁïôË®Ä
                try {
                    const allActivityComments = await window.dbService.getAllActivityComments();
                    window.activityComments = allActivityComments || {};
                    console.log('Â∑≤ËºâÂÖ•ÊâÄÊúâÊ¥ªÂãïÁïôË®Ä:', Object.keys(window.activityComments).length, 'ÂÄãÊ¥ªÂãï');
                    
                    // ËºâÂÖ•Ê¥ªÂãïÁïôË®ÄÂæåÁ´ãÂç≥Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                    setTimeout(async () => {
                        console.log('Firebase ËºâÂÖ•ÂæåÊõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®ÔºåÁï∂ÂâçÁî®Êà∂:', window.currentUser ? window.currentUser.name : 'Êú™Ë®≠ÁΩÆ');
                        await updateUnreadIndicators();
                    }, 500);
                } catch (error) {
                    console.error('ËºâÂÖ•Ê¥ªÂãïÁïôË®ÄÂ§±Êïó:', error);
                    const savedActivityComments = localStorage.getItem('activityComments');
                    window.activityComments = savedActivityComments ? JSON.parse(savedActivityComments) : {};
                    
                    // Âç≥‰ΩøËºâÂÖ•Â§±Êïó‰πüË¶ÅÊõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®
                    setTimeout(async () => {
                        console.log('Êú¨Âú∞ËºâÂÖ•ÂæåÊõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®ÔºåÁï∂ÂâçÁî®Êà∂:', window.currentUser ? window.currentUser.name : 'Êú™Ë®≠ÁΩÆ');
                        await updateUnreadIndicators();
                    }, 500);
                }
                
                // Áõ£ËÅΩÊ¥ªÂãïÁïôË®ÄËÆäÂåñ
                if (typeof window.dbService.listenToAllActivityComments === 'function') {
                    window.dbService.listenToAllActivityComments(activityCommentsData => {
                        window.activityComments = activityCommentsData || {};
                        console.log('Ê¥ªÂãïÁïôË®ÄÊï∏ÊìöÂ∑≤Êõ¥Êñ∞ÔºåÈáçÊñ∞Ê™¢Êü•Êú™ËÆÄÊåáÁ§∫Âô®');
                        // Êõ¥Êñ∞ÊâÄÊúâÊ¥ªÂãïÁöÑÊú™ËÆÄÊåáÁ§∫Âô®
                        updateUnreadIndicators();
                    });
                } else {
                    console.warn('Ê¥ªÂãïÁïôË®ÄÁõ£ËÅΩÂäüËÉΩ‰∏çÂèØÁî®');
                }
                
                // ËºâÂÖ•Áï∂ÂâçÁî®Êà∂ÔºàÂÑ™ÂÖàËºâÂÖ•ÔºåÁ¢∫‰øùÊú™ËÆÄÊåáÁ§∫Âô®ËÉΩÊ≠£Á¢∫Ê™¢Êü•Áî®Êà∂ÁãÄÊÖãÔºâ
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    window.currentUser = JSON.parse(savedUser);
                    updateCurrentUserDisplay();
                    console.log('Áï∂ÂâçÁî®Êà∂Â∑≤ËºâÂÖ•:', window.currentUser.name);
                }
                
                // Áõ£ËÅΩÁî®Êà∂Ë≥áÊñôËÆäÂåñ
                if (typeof window.dbService.listenToUserProfiles === 'function') {
                    window.dbService.listenToUserProfiles(profiles => {
                        window.userProfiles = profiles || [];
                    });
                } else {
                    console.warn('Áî®Êà∂Ë≥áÊñôÁõ£ËÅΩÂäüËÉΩ‰∏çÂèØÁî®');
                    const savedUserProfiles = localStorage.getItem('userProfiles');
                    window.userProfiles = savedUserProfiles ? JSON.parse(savedUserProfiles) : [
                        { name: 'Â∞èÈõ∑', avatar: 'ID-01', joinDate: '2024-01-01' },
                        { name: 'ÈòøËã¶', avatar: 'ID-02', joinDate: '2024-01-01' },
                        { name: 'Ê≥âÊàê', avatar: 'ID-03', joinDate: '2024-01-01' },
                        { name: 'Â∞èÁ¥Ö', avatar: 'ID-04', joinDate: '2024-01-01' }
                    ];
                }
                
                // Áõ£ËÅΩÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖËÆäÂåñ
                if (typeof window.dbService.listenToConfirmationItems === 'function') {
                    console.log('ÈñãÂßãÁõ£ËÅΩÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖËÆäÂåñ...');
                    window.dbService.listenToConfirmationItems(items => {
                        console.log('ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÂ∑≤Êõ¥Êñ∞:', items ? items.length : 0, 'ÂÄãÈ†ÖÁõÆ');
                        window.confirmationItems = items || [];
                        renderConfirmationItems();
                        // ÂàùÂßãÂåñÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊú™ËÆÄÊåáÁ§∫Âô®
                        updateConfirmationItemUnreadIndicators();
                    });
                } else {
                    console.warn('ÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÁõ£ËÅΩÂäüËÉΩ‰∏çÂèØÁî®ÔºåÂ∞á‰ΩøÁî®Êú¨Âú∞ÂÑ≤Â≠ò');
                    // Â¶ÇÊûúÁõ£ËÅΩÊñπÊ≥ï‰∏çÂ≠òÂú®ÔºåÂâáÁõ¥Êé•ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
                    loadConfirmationItems();
                }
                
                // ÂàùÂßãÂåñÊú™ËÆÄÊåáÁ§∫Âô®ÔºàÂú®Áî®Êà∂ËºâÂÖ•ÂæåÂü∑Ë°åÔºâ
                setTimeout(async () => {
                    console.log('ÈñãÂßãÂàùÂßãÂåñÊú™ËÆÄÊåáÁ§∫Âô®ÔºåÁï∂ÂâçÁî®Êà∂:', window.currentUser ? window.currentUser.name : 'Êú™Ë®≠ÁΩÆ');
                    await updateUnreadIndicators();
                }, 1000);
                
                // Ê∏¨Ë©¶ÊåâÈàïÂ∑≤ÁßªÈô§
                
                console.log('Firebase Ë≥áÊñôÂàùÂßãÂåñÂÆåÊàê');
            } catch (error) {
                console.error('ÂàùÂßãÂåñÈ†ÅÈù¢Ë≥áÊñôÂ§±Êïó:', error);
                console.warn('Â∞á‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô');
                // ÂæûÊú¨Âú∞ÂÑ≤Â≠òËºâÂÖ•Ë≥áÊñô
                loadDataFromLocalStorage();
            }
        }
        
        // ÂæûÊú¨Âú∞ÂÑ≤Â≠òËºâÂÖ•Ë≥áÊñô
        async function loadDataFromLocalStorage() {
            // ËºâÂÖ•Áï∂ÂâçÁî®Êà∂ÔºàÂÑ™ÂÖàËºâÂÖ•Ôºâ
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                window.currentUser = JSON.parse(savedUser);
                updateCurrentUserDisplay();
                console.log('ÂæûÊú¨Âú∞ËºâÂÖ•Áï∂ÂâçÁî®Êà∂:', window.currentUser.name);
            } else {
                // Â¶ÇÊûúÊ≤íÊúâÁî®Êà∂Ë®≠ÁΩÆÔºåÂâµÂª∫È†êË®≠Áî®Êà∂
                window.currentUser = { name: 'Ê∏¨Ë©¶Áî®Êà∂' };
                localStorage.setItem('currentUser', JSON.stringify(window.currentUser));
                updateCurrentUserDisplay();
                console.log('ÂâµÂª∫È†êË®≠Áî®Êà∂:', window.currentUser.name);
            }
            
            // ËºâÂÖ•ÁïôË®Ä
            const savedComments = localStorage.getItem('comments');
            window.comments = savedComments ? JSON.parse(savedComments) : [];
            renderComments();
            
            // ËºâÂÖ•Ê¥ªÂãïÁïôË®Ä
            const savedActivityComments = localStorage.getItem('activityComments');
            window.activityComments = savedActivityComments ? JSON.parse(savedActivityComments) : {};
            
            // Â¶ÇÊûúÊ≤íÊúâÊ¥ªÂãïÁïôË®ÄÊï∏ÊìöÔºåÂâµÂª∫‰∏Ä‰∫õÊ∏¨Ë©¶Êï∏Êìö
            if (Object.keys(window.activityComments).length === 0) {
                const testComments = {
                    'day1-activity1': [
                        {
                            id: 1,
                            author: 'Â∞èÈõ∑',
                            text: 'ÈÄôÂÄãÊôØÈªûÁúãËµ∑‰æÜÂæà‰∏çÈåØÔºÅ',
                            timestamp: new Date().toISOString(),
                            replies: [
                                {
                                    id: 2,
                                    author: 'ÈòøËã¶',
                                    text: 'ÂêåÊÑèÔºåÊàë‰πüÂæàÊúüÂæÖÔºÅ',
                                    timestamp: new Date().toISOString()
                                }
                            ]
                        }
                    ],
                    'day2-activity1': [
                        {
                            id: 3,
                            author: 'Ê≥âÊàê',
                            text: 'Êó•ÊúàÊΩ≠ÁúüÁöÑÂæàÁæéÔºÅ',
                            timestamp: new Date().toISOString(),
                            replies: []
                        }
                    ]
                };
                window.activityComments = testComments;
                localStorage.setItem('activityComments', JSON.stringify(testComments));
                console.log('ÂâµÂª∫Ê∏¨Ë©¶Ê¥ªÂãïÁïôË®ÄÊï∏Êìö');
            }
            // Âª∂ÈÅ≤Êõ¥Êñ∞Êú™ËÆÄÊåáÁ§∫Âô®ÔºåÁ¢∫‰øùÁî®Êà∂Â∑≤ËºâÂÖ•
            setTimeout(() => {
                updateUnreadIndicators();
            }, 100);
            
            // ËºâÂÖ•Áî®Êà∂Ë≥áÊñô
            const savedUserProfiles = localStorage.getItem('userProfiles');
            window.userProfiles = savedUserProfiles ? JSON.parse(savedUserProfiles) : [
                { name: 'Â∞èÈõ∑', avatar: 'ID-01', joinDate: '2024-01-01' },
                { name: 'ÈòøËã¶', avatar: 'ID-02', joinDate: '2024-01-01' },
                { name: 'Ê≥âÊàê', avatar: 'ID-03', joinDate: '2024-01-01' },
                { name: 'Â∞èÁ¥Ö', avatar: 'ID-04', joinDate: '2024-01-01' }
            ];
            
            // ËºâÂÖ•ÂæÖÁ¢∫Ë™ç‰∫ãÈ†Ö
            const savedConfirmationItems = localStorage.getItem('confirmationItems');
            window.confirmationItems = savedConfirmationItems ? JSON.parse(savedConfirmationItems) : [
                {
                    id: '1',
                    title: 'Á¢∫Ë™çÈ§êÂª≥Ë®Ç‰Ωç',
                    details: 'ÈúÄË¶ÅÂú®8/5ÂâçÁ¢∫Ë™çÊó•ÊúàÊΩ≠È§êÂª≥ÁöÑË®Ç‰ΩçÔºåËÅØÁµ°ÈõªË©±: 049-123456',
                    relatedDay: 'day2',
                    confirmed: false,
                    createdAt: '2024/7/20 10:00:00',
                    createdBy: 'Á≥ªÁµ±',
                    confirmedAt: '',
                    confirmedBy: ''
                },
                {
                    id: '2',
                    title: 'Á¢∫Ë™çÁ´ãÊß≥È†êÁ¥ÑÊôÇÈñì',
                    details: 'ÈúÄË¶ÅÁ¢∫Ë™çÁ´ãÊß≥È´îÈ©óÁöÑÈ†êÁ¥ÑÊôÇÈñìÔºåÂèØËÉΩÈúÄË¶ÅÊèêÂâç30ÂàÜÈêòÂà∞ÈÅî',
                    relatedDay: 'day2',
                    confirmed: true,
                    createdAt: '2024/7/20 10:00:00',
                    createdBy: 'Á≥ªÁµ±',
                    confirmedAt: '2024/7/25 15:30:00',
                    confirmedBy: 'Â∞èÈõ∑'
                }
            ];
            renderConfirmationItems();
            // ÂàùÂßãÂåñÂæÖÁ¢∫Ë™ç‰∫ãÈ†ÖÊú™ËÆÄÊåáÁ§∫Âô®
            updateConfirmationItemUnreadIndicators();
            
            // ÂàùÂßãÂåñÊâìÂåÖÊ∏ÖÂñÆÁ≥ªÁµ±Ôºà‰ΩøÁî®Âç≥ÊôÇÂêåÊ≠•Ê®°ÂºèÔºâ
            await initializePackingSystem();
            
            console.log('Êú¨Âú∞Ë≥áÊñôËºâÂÖ•ÂÆåÊàê');
            
            // Ê∏¨Ë©¶ÊåâÈàïÂ∑≤ÁßªÈô§
        }
        
        // Ê∏¨Ë©¶ÊåâÈàïÁõ∏ÈóúÂáΩÊï∏Â∑≤ÁßªÈô§
        
        // ÊâìÂåÖÊ∏ÖÂñÆÁõ∏ÈóúÂäüËÉΩ
        // È°ØÁ§∫Êñ∞Â¢ûÊâìÂåÖÁâ©ÂìÅË°®ÂñÆ
        function showAddPackingItemForm() {
            const form = document.getElementById('addPackingItemForm');
            form.style.display = 'block';
            // Ê∑ªÂä† visible È°ûÂà•‰ª•Ëß∏ÁôºÂãïÁï´
            setTimeout(() => {
                form.classList.add('visible');
            }, 10);
            document.getElementById('newPackingItem').focus();
        }
        
        // Èö±ËóèÊñ∞Â¢ûÊâìÂåÖÁâ©ÂìÅË°®ÂñÆ
        function hideAddPackingItemForm() {
            const form = document.getElementById('addPackingItemForm');
            // ÁßªÈô§ visible È°ûÂà•‰ª•Ëß∏ÁôºÊ∑°Âá∫ÂãïÁï´
            form.classList.remove('visible');
            // Á≠âÂæÖÂãïÁï´ÂÆåÊàêÂæåÈö±ËóèË°®ÂñÆ
            setTimeout(() => {
                form.style.display = 'none';
                document.getElementById('newPackingItem').value = '';
            }, 300);
        }
        
        // Â∞áÂáΩÊï∏Êö¥Èú≤Âà∞ÂÖ®Âüü‰ΩúÁî®Âüü
        window.showAddPackingItemForm = showAddPackingItemForm;
        window.hideAddPackingItemForm = hideAddPackingItemForm;
        
        // ÂàùÂßãÂåñÊâìÂåÖÊ∏ÖÂñÆÁ≥ªÁµ± - ‰ΩøÁî®Âç≥ÊôÇÂêåÊ≠•Ê®°Âºè
        async function initializePackingSystem() {
            console.log('ÂàùÂßãÂåñÊâìÂåÖÊ∏ÖÂñÆÁ≥ªÁµ± - Âç≥ÊôÇÂêåÊ≠•Ê®°Âºè');
            
            // Á¨¨‰∏ÄÊ≠•ÔºöÂÑ™ÂÖàÂæûÊú¨Âú∞ÂÑ≤Â≠òËºâÂÖ•Êï∏ÊìöÔºàÊú¨Âú∞ÂÑ™ÂÖàÁ≠ñÁï•Ôºâ
            const savedPackingItems = localStorage.getItem('packingItems');
            if (savedPackingItems) {
                window.packingItems = JSON.parse(savedPackingItems);
                console.log('ÂæûÊú¨Âú∞ÂÑ≤Â≠òÂàùÂßãÂåñÊâìÂåÖÊ∏ÖÂñÆ:', window.packingItems.length, 'ÂÄãÈ†ÖÁõÆ');
            } else {
                // Â¶ÇÊûúÊú¨Âú∞Ê≤íÊúâÊï∏ÊìöÔºåÁõ¥Êé•ËºâÂÖ•È†êË®≠Â∏∏Áî®Áâ©ÂìÅÊ∏ÖÂñÆ
                window.packingItems = [
                    // Ë°£Áâ©È°û
                    { id: 'item1', name: 'ÊèõÊ¥óË°£Áâ©', category: 'clothing', checked: false },
                    { id: 'item2', name: 'ÂÖßË°£Ë§≤', category: 'clothing', checked: false },
                    { id: 'item3', name: 'Ë•™Â≠ê', category: 'clothing', checked: false },
                    { id: 'item4', name: 'Áù°Ë°£', category: 'clothing', checked: false },
                    { id: 'item5', name: 'Ê≥≥Ë°£/Ê≥≥Ë§≤', category: 'clothing', checked: false },
                    { id: 'item6', name: 'Â§ñÂ•ó/ËñÑÈï∑Ë¢ñ', category: 'clothing', checked: false },
                    { id: 'item7', name: 'ÈÅãÂãïÈûã', category: 'clothing', checked: false },
                    { id: 'item8', name: 'ÊãñÈûã/Ê∂ºÈûã', category: 'clothing', checked: false },
                    { id: 'item9', name: 'ÈÅÆÈôΩÂ∏Ω', category: 'clothing', checked: false },
                    
                    // Áõ•Ê¥óÁî®ÂìÅ
                    { id: 'item10', name: 'ÁâôÂà∑ÁâôËÜè', category: 'toiletries', checked: false },
                    { id: 'item11', name: 'Ê¥óÈ´ÆÁ≤æ/Ê≤êÊµ¥‰π≥', category: 'toiletries', checked: false },
                    { id: 'item12', name: 'ÊØõÂ∑æ/Êµ¥Â∑æ', category: 'toiletries', checked: false },
                    { id: 'item13', name: 'Ê¢≥Â≠ê/È´ÆÂúà', category: 'toiletries', checked: false },
                    { id: 'item14', name: 'ÂàÆÈ¨çÂàÄ', category: 'toiletries', checked: false },
                    { id: 'item15', name: 'ÂåñÂ¶ùÂìÅ/‰øùÈ§äÂìÅ', category: 'toiletries', checked: false },
                    
                    // Èò≤Ë≠∑Áî®ÂìÅ
                    { id: 'item16', name: 'Èò≤Êõ¨‰π≥/Èò≤Êõ¨Ë°£', category: 'protection', checked: false },
                    { id: 'item17', name: 'Èò≤ËöäÊ∂≤', category: 'protection', checked: false },
                    { id: 'item18', name: 'Èõ®ÂÖ∑/Èõ®ÂÇò', category: 'protection', checked: false },
                    { id: 'item19', name: 'Âè£ÁΩ©', category: 'protection', checked: false },
                    { id: 'item20', name: '‰πæÊ¥óÊâã/ÊøïÁ¥ôÂ∑æ', category: 'protection', checked: false },
                    
                    // ÈõªÂ≠êÁî¢ÂìÅ
                    { id: 'item21', name: 'ÊâãÊ©üÂÖÖÈõªÂô®', category: 'electronics', checked: false },
                    { id: 'item22', name: 'Ë°åÂãïÈõªÊ∫ê', category: 'electronics', checked: false },
                    { id: 'item23', name: 'Áõ∏Ê©ü/ÊîùÂΩ±Ê©ü', category: 'electronics', checked: false },
                    { id: 'item24', name: 'ËÄ≥Ê©ü', category: 'electronics', checked: false },
                    
                    // ÂÖ∂‰ªñÂøÖÈúÄÂìÅ
                    { id: 'item25', name: 'ÂÄã‰∫∫Ëó•ÂìÅ/Â∏∏ÂÇôËó•', category: 'essentials', checked: false },
                    { id: 'item26', name: 'Èõ∂È£ü/È£≤Êñô', category: 'essentials', checked: false },
                    { id: 'item27', name: 'Ë≠â‰ª∂/Èå¢ÂåÖ', category: 'essentials', checked: false },
                    { id: 'item28', name: 'Â§™ÈôΩÁúºÈè°', category: 'essentials', checked: false },
                    { id: 'item29', name: 'Ê∞¥Â£∫', category: 'essentials', checked: false },
                    { id: 'item30', name: 'Â∞èËÉåÂåÖ/ËÖ∞ÂåÖ', category: 'essentials', checked: false }
                ];
                localStorage.setItem('packingItems', JSON.stringify(window.packingItems));
                console.log('ÂàùÂßãÂåñÈ†êË®≠ÊâìÂåÖÊ∏ÖÂñÆ:', window.packingItems.length, 'ÂÄãÈ†ÖÁõÆ');
            }
            
            // Á´ãÂç≥Ê∏≤ÊüìÊú¨Âú∞Êï∏ÊìöÔºåÁ¢∫‰øùÁî®Êà∂ÁïåÈù¢Âø´ÈÄüÈüøÊáâ
            renderPackingItems();
            
            // Á¨¨‰∫åÊ≠•ÔºöË®≠ÁΩÆ Firebase ÂêåÊ≠•ÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
            setupFirebaseSync();
        }
        
        // Ë®≠ÁΩÆ Firebase ÂêåÊ≠•Ê©üÂà∂
        async function setupFirebaseSync() {
            // Ê™¢Êü•Áî®Êà∂Âíå Firebase ÊúçÂãôÊòØÂê¶ÂèØÁî®
            if (!window.currentUser || !window.currentUser.name || !window.dbService || !window.dbService.initialized) {
                console.log('Firebase ÂêåÊ≠•Êú™ÂïüÁî®ÔºöÁî®Êà∂Êú™Ë®≠ÁΩÆÊàñ Firebase ÊúçÂãôÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            try {
                console.log(`ÂòóË©¶Âæû Firebase ÂêåÊ≠•Áî®Êà∂ ${window.currentUser.name} ÁöÑÊâìÂåÖÊ∏ÖÂñÆ...`);
                
                // Âæû Firebase Áç≤ÂèñÊúÄÊñ∞Êï∏Êìö
                const firebaseItems = await window.dbService.getUserPackingItems(window.currentUser.name);
                
                if (firebaseItems !== null) {
                    // Â¶ÇÊûú Firebase ÊúâÊï∏ÊìöÔºåÂâáÊõ¥Êñ∞Êú¨Âú∞Êï∏Êìö
                    // ‰ΩÜÊàëÂÄëÈúÄË¶ÅÈÄ≤Ë°åÊô∫ËÉΩÂêà‰ΩµÔºåËÄå‰∏çÊòØÁ∞°ÂñÆË¶ÜËìã
                    if (window.packingItems.length === 0) {
                        // Â¶ÇÊûúÊú¨Âú∞ÊòØÁ©∫ÁöÑÔºåÁõ¥Êé•‰ΩøÁî® Firebase Êï∏Êìö
                        window.packingItems = firebaseItems;
                        console.log(`Âæû Firebase ÂêåÊ≠•ÊâìÂåÖÊ∏ÖÂñÆ: ${firebaseItems.length} ÂÄãÈ†ÖÁõÆ`);
                    } else {
                        // Â¶ÇÊûúÊú¨Âú∞ÊúâÊï∏ÊìöÔºåÊàëÂÄëÈúÄË¶ÅÊ±∫ÂÆö‰ΩøÁî®Âì™ÂÄãÁâàÊú¨
                        // ÈÄôË£°ÊàëÂÄëÈÅ∏Êìá‰ΩøÁî® Firebase ÁâàÊú¨Ôºå‰ΩÜÂú®ÂØ¶ÈöõÊáâÁî®‰∏≠ÂèØËÉΩÈúÄË¶ÅÊõ¥Ë§áÈõúÁöÑÂêà‰ΩµÁ≠ñÁï•
                        console.log('Êú¨Âú∞Âíå Firebase ÈÉΩÊúâÊâìÂåÖÊ∏ÖÂñÆÊï∏ÊìöÔºå‰ΩøÁî® Firebase ÁâàÊú¨');
                        window.packingItems = firebaseItems;
                    }
                    
                    // ÂêåÊ≠•Âà∞Êú¨Âú∞ÂÑ≤Â≠ò
                    localStorage.setItem('packingItems', JSON.stringify(window.packingItems));
                    renderPackingItems();
                } else {
                    // Â¶ÇÊûú Firebase Ê≤íÊúâÊï∏Êìö‰ΩÜÊú¨Âú∞ÊúâÔºåÂâáÂ∞áÊú¨Âú∞Êï∏ÊìöÂêåÊ≠•Âà∞ Firebase
                    if (window.packingItems.length > 0) {
                        console.log('Firebase ‰∏≠Ê≤íÊúâÊâìÂåÖÊ∏ÖÂñÆÔºåÂ∞áÊú¨Âú∞Êï∏ÊìöÂêåÊ≠•Âà∞ Firebase');
                        await window.dbService.saveUserPackingItems(window.currentUser.name, window.packingItems);
                    }
                }
                
                // Ë®≠ÁΩÆÂØ¶ÊôÇÁõ£ËÅΩÂô®ÔºåËá™ÂãïÊé•Êî∂ Firebase Êï∏ÊìöËÆäÊõ¥
                window.dbService.onUserPackingItemsChange(window.currentUser.name, (updatedItems) => {
                    console.log('Ê™¢Ê∏¨Âà∞ Firebase ÊâìÂåÖÊ∏ÖÂñÆËÆäÂåñÔºåÊõ¥Êñ∞Êú¨Âú∞Êï∏Êìö');
                    window.packingItems = updatedItems;
                    // ÂêåÊôÇ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
                    localStorage.setItem('packingItems', JSON.stringify(window.packingItems));
                    renderPackingItems();
                });
                
                console.log('Firebase ÂêåÊ≠•Ë®≠ÁΩÆÂÆåÊàê');
            } catch (error) {
                console.error('Ë®≠ÁΩÆ Firebase ÂêåÊ≠•Â§±Êïó:', error);
                // ÁôºÁîüÈåØË™§ÊôÇÔºåÊàëÂÄëÂ∑≤Á∂ìÊúâÊú¨Âú∞Êï∏ÊìöÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅÈ°çÂ§ñËôïÁêÜ
                // Âè™ÈúÄË®òÈåÑÈåØË™§‰∏¶ÁπºÁ∫å‰ΩøÁî®Êú¨Âú∞Êï∏Êìö
            }
        }
        
        // ÁÇ∫‰∫ÜÂêëÂæåÂÖºÂÆπÔºå‰øùÁïôËàäÂáΩÊï∏ÂêçÁ®±‰ΩÜÊîπÁÇ∫Ë™øÁî®Êñ∞ÂáΩÊï∏
        async function loadPackingItemsFromFirebase() {
            console.log('‰ΩøÁî®Êñ∞ÁöÑÂç≥ÊôÇÂêåÊ≠•Ê®°ÂºèÊõø‰ª£ËàäÁöÑËºâÂÖ•ÊñπÂºè');
            await initializePackingSystem();
        }
        
        // Êñ∞Â¢ûÊâìÂåÖÁâ©ÂìÅ
        async function addPackingItem() {
            const itemName = document.getElementById('newPackingItem').value.trim();
            
            if (!itemName) {
                showNotification('Ë´ãËº∏ÂÖ•Áâ©ÂìÅÂêçÁ®±', 'error');
                return;
            }
            
            if (!window.currentUser || !window.currentUser.name) {
                showNotification('Ë´ãÂÖàË®≠ÁΩÆÁî®Êà∂Ë∫´‰ªΩ', 'error');
                return;
            }
            
            // Áç≤ÂèñÂàÜÈ°û
            let category = document.getElementById('newItemCategory').value;
            
            // ËôïÁêÜËá™Ë®ÇÂàÜÈ°û
            if (category === 'custom') {
                const customCategory = document.getElementById('customCategory').value.trim();
                if (!customCategory) {
                    showNotification('Ë´ãËº∏ÂÖ•Ëá™Ë®ÇÂàÜÈ°ûÂêçÁ®±', 'error');
                    return;
                }
                category = customCategory;
            }
            
            // ÂâµÂª∫Êñ∞Áâ©ÂìÅ
            const newItem = {
                id: 'item_' + Date.now(),
                name: itemName,
                category: category,
                checked: false
            };
            
            try {
                // ‰ΩøÁî® Firebase ÊúçÂãôÊ∑ªÂä†È†ÖÁõÆ
                if (window.dbService && window.dbService.initialized) {
                    const success = await window.dbService.addPackingItem(window.currentUser.name, newItem);
                    if (success) {
                        // Êú¨Âú∞‰πüÊõ¥Êñ∞ÔºàFirebase Áõ£ËÅΩÂô®ÊúÉËá™ÂãïÊõ¥Êñ∞Ôºå‰ΩÜÁÇ∫‰∫ÜÂç≥ÊôÇÂèçÊáâÂÖàÊâãÂãïÊõ¥Êñ∞Ôºâ
                        if (!window.packingItems) {
                            window.packingItems = [];
                        }
                        window.packingItems.push(newItem);
                        // ÂêåÊôÇ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
                        localStorage.setItem('packingItems', JSON.stringify(window.packingItems));
                        renderPackingItems();
                        
                        showNotification('Â∑≤Êñ∞Â¢ûÁâ©ÂìÅÂà∞ÊâìÂåÖÊ∏ÖÂñÆ');
                    } else {
                        showNotification('Êñ∞Â¢ûÁâ©ÂìÅÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
                    }
                } else {
                    showNotification('Firebase ÊúçÂãôÊú™ÂèØÁî®', 'error');
                }
            } catch (error) {
                console.error('Êñ∞Â¢ûÊâìÂåÖÁâ©ÂìÅÂ§±Êïó:', error);
                showNotification('Êñ∞Â¢ûÁâ©ÂìÅÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
            }
            
            // Èö±ËóèË°®ÂñÆ‰∏¶Ê∏ÖÁ©∫Ëº∏ÂÖ•
            hideAddPackingItemForm();
            
            // ÈáçÁΩÆË°®ÂñÆ
            document.getElementById('newPackingItem').value = '';
            document.getElementById('newItemCategory').value = 'clothing';
            document.getElementById('customCategoryRow').style.display = 'none';
            document.getElementById('customCategory').value = '';
        }
        
        // Â∞á addPackingItem Êö¥Èú≤Âà∞ÂÖ®Âüü‰ΩúÁî®Âüü
        window.addPackingItem = addPackingItem;
        
        // Âà™Èô§ÊâìÂåÖÁâ©ÂìÅ
        async function deletePackingItem(itemId) {
            // Á¢∫‰øù packingItems Â≠òÂú®
            if (!window.packingItems) {
                return;
            }
            
            if (!window.currentUser || !window.currentUser.name) {
                showNotification('Ë´ãÂÖàË®≠ÁΩÆÁî®Êà∂Ë∫´‰ªΩ', 'error');
                return;
            }
            
            // ÊâæÂà∞Áâ©ÂìÅÁ¥¢Âºï
            const itemIndex = window.packingItems.findIndex(item => item.id === itemId);
            
            if (itemIndex === -1) {
                return;
            }
            
            try {
                // ‰ΩøÁî® Firebase ÊúçÂãôÂà™Èô§È†ÖÁõÆ
                if (window.dbService && window.dbService.initialized) {
                    const success = await window.dbService.deletePackingItem(window.currentUser.name, itemId);
                    if (success) {
                        // Êú¨Âú∞‰πüÊõ¥Êñ∞ÔºàFirebase Áõ£ËÅΩÂô®ÊúÉËá™ÂãïÊõ¥Êñ∞Ôºå‰ΩÜÁÇ∫‰∫ÜÂç≥ÊôÇÂèçÊáâÂÖàÊâãÂãïÊõ¥Êñ∞Ôºâ
                        window.packingItems.splice(itemIndex, 1);
                        // ÂêåÊôÇ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
                        localStorage.setItem('packingItems', JSON.stringify(window.packingItems));
                        renderPackingItems();
                        
                        showNotification('Â∑≤ÂæûÊâìÂåÖÊ∏ÖÂñÆ‰∏≠ÁßªÈô§Áâ©ÂìÅ');
                    } else {
                        showNotification('Âà™Èô§Áâ©ÂìÅÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
                    }
                } else {
                    showNotification('Firebase ÊúçÂãôÊú™ÂèØÁî®', 'error');
                }
            } catch (error) {
                console.error('Âà™Èô§ÊâìÂåÖÁâ©ÂìÅÂ§±Êïó:', error);
                showNotification('Âà™Èô§Áâ©ÂìÅÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
            }
        }
        
        // Êõ¥Êñ∞ÊâìÂåÖÁâ©ÂìÅÁãÄÊÖã
        async function updatePackingItemStatus(itemId, checked) {
            console.log(`Êõ¥Êñ∞ÊâìÂåÖÁâ©ÂìÅÁãÄÊÖã: ${itemId} = ${checked}`);
            
            // Á¢∫‰øù packingItems Â≠òÂú®
            if (!window.packingItems) {
                console.error('window.packingItems ‰∏çÂ≠òÂú®');
                return;
            }
            
            if (!window.currentUser || !window.currentUser.name) {
                console.error('Áî®Êà∂Êú™Ë®≠ÁΩÆÔºåÁÑ°Ê≥ïÊõ¥Êñ∞ÊâìÂåÖÁâ©ÂìÅÁãÄÊÖã');
                return;
            }
            
            // ÊâæÂà∞Áâ©ÂìÅ
            const item = window.packingItems.find(item => item.id === itemId);
            
            if (!item) {
                console.error(`Êâæ‰∏çÂà∞ ID ÁÇ∫ ${itemId} ÁöÑÁâ©ÂìÅ`);
                return;
            }
            
            try {
                // ‰ΩøÁî® Firebase ÊúçÂãôÊõ¥Êñ∞È†ÖÁõÆÁãÄÊÖã
                if (window.dbService && window.dbService.initialized) {
                    const success = await window.dbService.updatePackingItemStatus(window.currentUser.name, itemId, checked);
                    if (success) {
                        // Êú¨Âú∞‰πüÊõ¥Êñ∞ÔºàFirebase Áõ£ËÅΩÂô®ÊúÉËá™ÂãïÊõ¥Êñ∞Ôºå‰ΩÜÁÇ∫‰∫ÜÂç≥ÊôÇÂèçÊáâÂÖàÊâãÂãïÊõ¥Êñ∞Ôºâ
                        item.checked = checked;
                        // ÂêåÊôÇ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
                        localStorage.setItem('packingItems', JSON.stringify(window.packingItems));
                        
                        // Ê∑ªÂä†Ë™øË©¶‰ø°ÊÅØ
                        console.log('Áï∂ÂâçÊâìÂåÖÁâ©ÂìÅÁãÄÊÖã:', window.packingItems.map(item => ({id: item.id, name: item.name, checked: item.checked})));
                        
                        // Âª∂ÈÅ≤Êõ¥Êñ∞ÈÄ≤Â∫¶ÔºåÁ¢∫‰øùÊï∏ÊìöÂêåÊ≠•ÂÆåÊàê
                        setTimeout(() => {
                            updatePackingProgress();
                        }, 100);
                        
                        console.log('ÊâìÂåÖÊ∏ÖÂñÆÁãÄÊÖãÂ∑≤‰øùÂ≠òÂà∞ Firebase ÂíåÊú¨Âú∞ÂÑ≤Â≠ò:', window.packingItems);
                    } else {
                        console.error('Êõ¥Êñ∞ÊâìÂåÖÁâ©ÂìÅÁãÄÊÖãÂ§±Êïó');
                        // ÊÅ¢Âæ©ÂéüÁãÄÊÖã
                        const checkbox = document.getElementById(itemId);
                        if (checkbox) {
                            checkbox.checked = item.checked;
                        }
                    }
                } else {
                    console.error('Firebase ÊúçÂãôÊú™ÂèØÁî®');
                    // ÊÅ¢Âæ©ÂéüÁãÄÊÖã
                    const checkbox = document.getElementById(itemId);
                    if (checkbox) {
                        checkbox.checked = item.checked;
                    }
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊâìÂåÖÁâ©ÂìÅÁãÄÊÖãÂ§±Êïó:', error);
                // ÊÅ¢Âæ©ÂéüÁãÄÊÖã
                const checkbox = document.getElementById(itemId);
                if (checkbox) {
                    checkbox.checked = item.checked;
                }
            }
        }
        
        // ÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆ
        async function resetPackingList() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆÂóéÔºüÈÄôÂ∞áÊ∏ÖÈô§ÁõÆÂâçÁöÑÊâìÂåÖÊ∏ÖÂñÆ‰∏¶ËºâÂÖ•È†êË®≠ÁöÑÂ∏∏Áî®Áâ©ÂìÅ„ÄÇ')) {
                if (!window.currentUser || !window.currentUser.name) {
                    showNotification('Ë´ãÂÖàË®≠ÁΩÆÁî®Êà∂Ë∫´‰ªΩ', 'error');
                    return;
                }
                
                // È†êË®≠Áâ©ÂìÅÊ∏ÖÂñÆ
                const defaultItems = [
                    // Ë°£Áâ©È°û
                    { id: 'item1', name: 'ÊèõÊ¥óË°£Áâ©', category: 'clothing', checked: false },
                    { id: 'item2', name: 'ÂÖßË°£Ë§≤', category: 'clothing', checked: false },
                    { id: 'item3', name: 'Ë•™Â≠ê', category: 'clothing', checked: false },
                    { id: 'item4', name: 'Áù°Ë°£', category: 'clothing', checked: false },
                    { id: 'item5', name: 'Ê≥≥Ë°£/Ê≥≥Ë§≤', category: 'clothing', checked: false },
                    { id: 'item6', name: 'Â§ñÂ•ó/ËñÑÈï∑Ë¢ñ', category: 'clothing', checked: false },
                    { id: 'item7', name: 'ÈÅãÂãïÈûã', category: 'clothing', checked: false },
                    { id: 'item8', name: 'ÊãñÈûã/Ê∂ºÈûã', category: 'clothing', checked: false },
                    { id: 'item9', name: 'ÈÅÆÈôΩÂ∏Ω', category: 'clothing', checked: false },
                    
                    // Áõ•Ê¥óÁî®ÂìÅ
                    { id: 'item10', name: 'ÁâôÂà∑ÁâôËÜè', category: 'toiletries', checked: false },
                    { id: 'item11', name: 'Ê¥óÈ´ÆÁ≤æ/Ê≤êÊµ¥‰π≥', category: 'toiletries', checked: false },
                    { id: 'item12', name: 'ÊØõÂ∑æ/Êµ¥Â∑æ', category: 'toiletries', checked: false },
                    { id: 'item13', name: 'Ê¢≥Â≠ê/È´ÆÂúà', category: 'toiletries', checked: false },
                    { id: 'item14', name: 'ÂàÆÈ¨çÂàÄ', category: 'toiletries', checked: false },
                    { id: 'item15', name: 'ÂåñÂ¶ùÂìÅ/‰øùÈ§äÂìÅ', category: 'toiletries', checked: false },
                    
                    // Èò≤Ë≠∑Áî®ÂìÅ
                    { id: 'item16', name: 'Èò≤Êõ¨‰π≥/Èò≤Êõ¨Ë°£', category: 'protection', checked: false },
                    { id: 'item17', name: 'Èò≤ËöäÊ∂≤', category: 'protection', checked: false },
                    { id: 'item18', name: 'Èõ®ÂÖ∑/Èõ®ÂÇò', category: 'protection', checked: false },
                    { id: 'item19', name: 'Âè£ÁΩ©', category: 'protection', checked: false },
                    { id: 'item20', name: '‰πæÊ¥óÊâã/ÊøïÁ¥ôÂ∑æ', category: 'protection', checked: false },
                    
                    // ÈõªÂ≠êÁî¢ÂìÅ
                    { id: 'item21', name: 'ÊâãÊ©üÂÖÖÈõªÂô®', category: 'electronics', checked: false },
                    { id: 'item22', name: 'Ë°åÂãïÈõªÊ∫ê', category: 'electronics', checked: false },
                    { id: 'item23', name: 'Áõ∏Ê©ü/ÊîùÂΩ±Ê©ü', category: 'electronics', checked: false },
                    { id: 'item24', name: 'ËÄ≥Ê©ü', category: 'electronics', checked: false },
                    
                    // ÂÖ∂‰ªñÂøÖÈúÄÂìÅ
                    { id: 'item25', name: 'ÂÄã‰∫∫Ëó•ÂìÅ/Â∏∏ÂÇôËó•', category: 'essentials', checked: false },
                    { id: 'item26', name: 'Èõ∂È£ü/È£≤Êñô', category: 'essentials', checked: false },
                    { id: 'item27', name: 'Ë≠â‰ª∂/Èå¢ÂåÖ', category: 'essentials', checked: false },
                    { id: 'item28', name: 'Â§™ÈôΩÁúºÈè°', category: 'essentials', checked: false },
                    { id: 'item29', name: 'Ê∞¥Â£∫', category: 'essentials', checked: false },
                    { id: 'item30', name: 'Â∞èËÉåÂåÖ/ËÖ∞ÂåÖ', category: 'essentials', checked: false }
                ];
                
                try {
                    // ‰ΩøÁî® Firebase ÊúçÂãôÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆ
                    if (window.dbService && window.dbService.initialized) {
                        const success = await window.dbService.resetUserPackingList(window.currentUser.name, defaultItems);
                        if (success) {
                            // Êú¨Âú∞‰πüÊõ¥Êñ∞
                            window.packingItems = defaultItems;
                            // ÂêåÊôÇ‰øùÂ≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò
                            localStorage.setItem('packingItems', JSON.stringify(window.packingItems));
                            renderPackingItems();
                            
                            showNotification('Â∑≤ÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆ');
                        } else {
                            showNotification('ÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
                        }
                    } else {
                        showNotification('Firebase ÊúçÂãôÊú™ÂèØÁî®', 'error');
                    }
                } catch (error) {
                    console.error('ÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆÂ§±Êïó:', error);
                    showNotification('ÈáçÁΩÆÊâìÂåÖÊ∏ÖÂñÆÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
                }
            }
        }
        
        // Â∞á resetPackingList Êö¥Èú≤Âà∞ÂÖ®Âüü‰ΩúÁî®Âüü
        window.resetPackingList = resetPackingList;
        
        // È†ÅÈù¢ÂàáÊèõÂäüËÉΩ
        function showPage(pageId) {
            // Èö±ËóèÊâÄÊúâÈ†ÅÈù¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // È°ØÁ§∫ÊåáÂÆöÈ†ÅÈù¢
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Â¶ÇÊûúÊòØÊâìÂåÖÊ∏ÖÂñÆÈ†ÅÈù¢ÔºåÊõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
                if (pageId === 'packing') {
                    renderPackingItems();
                    updatePackingProgress();
                }
            }
        }
        
        // Â∞á showPage Êö¥Èú≤Âà∞ÂÖ®Âüü‰ΩúÁî®Âüü
        window.showPage = showPage;
        
        // È°ØÁ§∫Ëá™Ë®ÇÂàÜÈ°ûËº∏ÂÖ•Ê°Ü
        function toggleCustomCategoryInput() {
            const categorySelect = document.getElementById('newItemCategory');
            const customCategoryRow = document.getElementById('customCategoryRow');
            
            if (categorySelect.value === 'custom') {
                // ÂÖàÈ°ØÁ§∫ÂÖÉÁ¥†
                customCategoryRow.style.display = 'flex';
                customCategoryRow.style.maxHeight = '0px';
                // Ê∑ªÂä†ÂãïÁï´ÊïàÊûú
                setTimeout(() => {
                    customCategoryRow.style.opacity = '1';
                    customCategoryRow.style.transform = 'translateY(0)';
                    customCategoryRow.style.maxHeight = '60px'; // Ë∂≥Â§†ÁöÑÈ´òÂ∫¶‰ª•È°ØÁ§∫ÂÖßÂÆπ
                }, 10);
                setTimeout(() => {
                    document.getElementById('customCategory').focus();
                }, 400); // Á≠âÂæÖÂãïÁï´ÂÆåÊàêÂæåËÅöÁÑ¶
            } else {
                // ÂÖàÊ∑ªÂä†Ê∑°Âá∫ÂãïÁï´
                customCategoryRow.style.opacity = '0';
                customCategoryRow.style.transform = 'translateY(-10px)';
                customCategoryRow.style.maxHeight = '0px';
                // Á≠âÂæÖÂãïÁï´ÂÆåÊàêÂæåÈö±ËóèÂÖÉÁ¥†
                setTimeout(() => {
                    customCategoryRow.style.display = 'none';
                }, 400);
            }
        }
        
        // ÂàáÊèõÂàÜÈ°ûÂ±ïÈñã/Êî∂ÂêàÁãÄÊÖã
        function toggleCategory(categoryId) {
            const categoryItems = document.getElementById('category-items-' + categoryId);
            if (categoryItems) {
                categoryItems.classList.toggle('expanded');
                
                // Êõ¥Êñ∞Â±ïÈñã/Êî∂ÂêàÂúñÊ®ô
                const toggleIcon = document.getElementById('category-toggle-' + categoryId);
                if (toggleIcon) {
                    toggleIcon.textContent = categoryItems.classList.contains('expanded') ? 'üîΩ' : '‚ñ∂Ô∏è';
                }
            }
        }
        
        // Êõ¥Êñ∞ÊâìÂåÖÈÄ≤Â∫¶Ê¢ù
        function updatePackingProgress() {
            if (!window.packingItems || window.packingItems.length === 0) {
                document.getElementById('packing-progress-bar').style.width = '0%';
                document.getElementById('packing-progress-text').textContent = 'Â∑≤ÂÆåÊàê: 0/0 (0%)';
                return;
            }
            
            const total = window.packingItems.length;
            const completed = window.packingItems.filter(item => item.checked).length;
            const percentage = Math.round((completed / total) * 100);
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ùÂØ¨Â∫¶
            document.getElementById('packing-progress-bar').style.width = percentage + '%';
            
            // Ê†πÊìöÂÆåÊàêÁôæÂàÜÊØîËÆäÊèõÈ°èËâ≤
            let color = '#e74c3c'; // Á¥ÖËâ≤ < 30%
            if (percentage > 70) {
                color = '#2ecc71'; // Á∂†Ëâ≤ > 70%
            } else if (percentage >= 30) {
                color = '#f39c12'; // ÈªÉËâ≤ 30-70%
            }
            document.getElementById('packing-progress-bar').style.backgroundColor = color;
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶ÊñáÂ≠ó
            document.getElementById('packing-progress-text').textContent = `Â∑≤ÂÆåÊàê: ${completed}/${total} (${percentage}%)`;
            
            // Êõ¥Êñ∞ÂêÑÂàÜÈ°ûÁöÑÈÄ≤Â∫¶ÊåáÁ§∫Âô®
            updateCategoryIndicators();
        }
        
        // Êõ¥Êñ∞ÂêÑÂàÜÈ°ûÁöÑÈÄ≤Â∫¶ÊåáÁ§∫Âô®
        function updateCategoryIndicators() {
            // Áç≤ÂèñÊâÄÊúâÂàÜÈ°û
            const categories = getCategorizedItems();
            
            // Êõ¥Êñ∞ÊØèÂÄãÂàÜÈ°ûÁöÑÈÄ≤Â∫¶ÊåáÁ§∫Âô®
            Object.keys(categories).forEach(category => {
                const items = categories[category];
                const total = items.length;
                const completed = items.filter(item => item.checked).length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                // Êõ¥Êñ∞ÂàÜÈ°ûÊ®ôÈ°å‰∏≠ÁöÑÂÆåÊàêÊï∏Èáè
                const statusElement = document.getElementById('category-status-' + category);
                if (statusElement) {
                    statusElement.textContent = `${completed}/${total}`;
                }
                
                // Êõ¥Êñ∞ÂàÜÈ°ûÊåáÁ§∫Âô®È°èËâ≤
                const indicatorElement = document.getElementById('category-indicator-' + category);
                if (indicatorElement) {
                    let color = '#e74c3c'; // Á¥ÖËâ≤ < 30%
                    if (percentage > 70) {
                        color = '#2ecc71'; // Á∂†Ëâ≤ > 70%
                    } else if (percentage >= 30) {
                        color = '#f39c12'; // ÈªÉËâ≤ 30-70%
                    }
                    indicatorElement.style.backgroundColor = color;
                }
            });
        }
        
        // Áç≤ÂèñÊåâÂàÜÈ°ûÁµÑÁπîÁöÑÁâ©ÂìÅ
        function getCategorizedItems() {
            if (!window.packingItems || window.packingItems.length === 0) {
                return {};
            }
            
            // È†êË®≠ÂàÜÈ°û
            const categories = {
                'clothing': [],      // Ë°£Áâ©
                'toiletries': [],    // Áõ•Ê¥óÁî®ÂìÅ
                'protection': [],    // Èò≤Ë≠∑Áî®ÂìÅ
                'electronics': [],   // ÈõªÂ≠êÁî¢ÂìÅ
                'essentials': []     // ÂÖ∂‰ªñÂøÖÈúÄÂìÅ
            };
            
            // Â∞áÁâ©ÂìÅÂàÜÈ°û
            window.packingItems.forEach(item => {
                // Â¶ÇÊûúÁâ©ÂìÅÊúâÂàÜÈ°ûÂ±¨ÊÄßÔºå‰ΩøÁî®Ë©≤ÂàÜÈ°ûÔºåÂê¶ÂâáÊîæÂÖ•„ÄåÂÖ∂‰ªñÂøÖÈúÄÂìÅ„Äç
                const category = item.category || 'essentials';
                
                // Â¶ÇÊûúÂàÜÈ°û‰∏çÂ≠òÂú®ÔºåÂâµÂª∫Êñ∞ÂàÜÈ°û
                if (!categories[category]) {
                    categories[category] = [];
                }
                
                // Â∞áÁâ©ÂìÅÊ∑ªÂä†Âà∞Â∞çÊáâÂàÜÈ°û
                categories[category].push(item);
            });
            
            return categories;
        }
        
        // Ê∏≤ÊüìÊâìÂåÖÊ∏ÖÂñÆ
        function renderPackingItems() {
            // Ê™¢Êü•ËàäÁâàÊâìÂåÖÊ∏ÖÂñÆÂÆπÂô®ÔºàÂêëÂæåÂÖºÂÆπÔºâ
            const oldContainer = document.getElementById('packingList');
            if (oldContainer) {
                // Á¢∫‰øù packingItems Â≠òÂú®
                if (!window.packingItems || window.packingItems.length === 0) {
                    oldContainer.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 10px;">ÊâìÂåÖÊ∏ÖÂñÆÊòØÁ©∫ÁöÑÔºåË´ãÊñ∞Â¢ûÁâ©ÂìÅ</div>';
                } else {
                    // Ê∏ÖÁ©∫ÂÆπÂô®
                    oldContainer.innerHTML = '<div style="text-align: center; padding: 10px;"><button onclick="showPage(\'packing\')" class="btn btn-primary">Êü•ÁúãÂÆåÊï¥ÊâìÂåÖÊ∏ÖÂñÆ</button></div>';
                }
            }
            
            // Áç≤ÂèñÊñ∞ÁâàÊâìÂåÖÊ∏ÖÂñÆÂÆπÂô®
            const categoriesContainer = document.getElementById('packing-categories');
            if (!categoriesContainer) return;
            
            // Á¢∫‰øù packingItems Â≠òÂú®
            if (!window.packingItems || window.packingItems.length === 0) {
                categoriesContainer.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">ÊâìÂåÖÊ∏ÖÂñÆÊòØÁ©∫ÁöÑÔºåË´ãÊñ∞Â¢ûÁâ©ÂìÅ</div>';
                return;
            }
            
            // Áç≤ÂèñÊåâÂàÜÈ°ûÁµÑÁπîÁöÑÁâ©ÂìÅ
            const categorizedItems = getCategorizedItems();
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            categoriesContainer.innerHTML = '';
            
            // ÂàÜÈ°ûÂêçÁ®±Â∞çÁÖßË°®
            const categoryNames = {
                'clothing': 'Ë°£Áâ©',
                'toiletries': 'Áõ•Ê¥óÁî®ÂìÅ',
                'protection': 'Èò≤Ë≠∑Áî®ÂìÅ',
                'electronics': 'ÈõªÂ≠êÁî¢ÂìÅ',
                'essentials': 'ÂÖ∂‰ªñÂøÖÈúÄÂìÅ'
            };
            
            // Ê∏≤ÊüìÊØèÂÄãÂàÜÈ°û
            Object.keys(categorizedItems).forEach(category => {
                const items = categorizedItems[category];
                if (items.length === 0) return; // Ë∑≥ÈÅéÁ©∫ÂàÜÈ°û
                
                // Ë®àÁÆóÂàÜÈ°ûÂÆåÊàêÈÄ≤Â∫¶
                const total = items.length;
                const completed = items.filter(item => item.checked).length;
                const percentage = Math.round((completed / total) * 100);
                
                // Ê±∫ÂÆöÊåáÁ§∫Âô®È°èËâ≤
                let indicatorColor = '#e74c3c'; // Á¥ÖËâ≤ < 30%
                if (percentage > 70) {
                    indicatorColor = '#2ecc71'; // Á∂†Ëâ≤ > 70%
                } else if (percentage >= 30) {
                    indicatorColor = '#f39c12'; // ÈªÉËâ≤ 30-70%
                }
                
                // ÂâµÂª∫ÂàÜÈ°ûÂÆπÂô®
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';
                
                // ÂâµÂª∫ÂàÜÈ°ûÊ®ôÈ°å
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.onclick = function() { toggleCategory(category); };
                
                // ÂàÜÈ°ûÊ®ôÈ°åÂ∑¶ÂÅ¥ÔºàÂêçÁ®±ÂíåÂúñÊ®ôÔºâ
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                
                const toggleIcon = document.createElement('span');
                toggleIcon.id = 'category-toggle-' + category;
                toggleIcon.textContent = 'üîΩ'; // È†êË®≠Â±ïÈñã
                
                const categoryNameSpan = document.createElement('span');
                categoryNameSpan.textContent = categoryNames[category] || category; // ‰ΩøÁî®Â∞çÁÖßË°®ÊàñÂéüÂßãÂêçÁ®±
                
                categoryTitle.appendChild(toggleIcon);
                categoryTitle.appendChild(categoryNameSpan);
                
                // ÂàÜÈ°ûÊ®ôÈ°åÂè≥ÂÅ¥ÔºàÁãÄÊÖãÂíåÊåáÁ§∫Âô®Ôºâ
                const categoryStatus = document.createElement('div');
                categoryStatus.className = 'category-status';
                
                const statusText = document.createElement('span');
                statusText.id = 'category-status-' + category;
                statusText.textContent = `${completed}/${total}`;
                
                const statusIndicator = document.createElement('span');
                statusIndicator.id = 'category-indicator-' + category;
                statusIndicator.className = 'status-indicator';
                statusIndicator.style.backgroundColor = indicatorColor;
                
                categoryStatus.appendChild(statusText);
                categoryStatus.appendChild(statusIndicator);
                
                // ÁµÑÂêàÂàÜÈ°ûÊ®ôÈ°å
                categoryHeader.appendChild(categoryTitle);
                categoryHeader.appendChild(categoryStatus);
                
                // ÂâµÂª∫ÂàÜÈ°ûÈ†ÖÁõÆÂÆπÂô®
                const categoryItems = document.createElement('div');
                categoryItems.id = 'category-items-' + category;
                categoryItems.className = 'category-items expanded'; // È†êË®≠Â±ïÈñã
                
                // Ê∏≤ÊüìÂàÜÈ°û‰∏≠ÁöÑÊØèÂÄãÁâ©ÂìÅ
                items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'packing-item';
                    
                    // ÂâµÂª∫Ê†∏ÂèñÊñπÂ°ä
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = item.id;
                    checkbox.checked = item.checked;
                    checkbox.addEventListener('change', function() {
                        updatePackingItemStatus(item.id, this.checked);
                        // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
                        updatePackingProgress();
                    });
                    
                    // ÂâµÂª∫Ê®ôÁ±§
                    const label = document.createElement('label');
                    label.htmlFor = item.id;
                    label.textContent = item.name;
                    
                    // ÂâµÂª∫Âà™Èô§ÊåâÈàï
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-item';
                    deleteBtn.innerHTML = '‚ùå';
                    deleteBtn.title = 'Âà™Èô§Áâ©ÂìÅ';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Èò≤Ê≠¢Ëß∏ÁôºÂàÜÈ°ûÂ±ïÈñã/Êî∂Âêà
                        if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${item.name}„ÄçÂóéÔºü`)) {
                            deletePackingItem(item.id);
                            // Âà™Èô§ÂæåÊõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
                            setTimeout(() => {
                                updatePackingProgress();
                            }, 100);
                        }
                    });
                    
                    // ÁµÑÂêàÁâ©ÂìÅÂÖÉÁ¥†
                    itemElement.appendChild(checkbox);
                    itemElement.appendChild(label);
                    itemElement.appendChild(deleteBtn);
                    
                    // Ê∑ªÂä†Âà∞ÂàÜÈ°ûÈ†ÖÁõÆÂÆπÂô®
                    categoryItems.appendChild(itemElement);
                });
                
                // ÁµÑÂêàÂàÜÈ°ûÂÆπÂô®
                categoryContainer.appendChild(categoryHeader);
                categoryContainer.appendChild(categoryItems);
                
                // Ê∑ªÂä†Âà∞‰∏ªÂÆπÂô®
                categoriesContainer.appendChild(categoryContainer);
            });
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
            updatePackingProgress();
        }
        
        // ==================== Â§©Ê∞£È†êÂ†±ÂäüËÉΩ ====================
        
        // Â§©Ê∞£ API ÈÖçÁΩÆ
        const WEATHER_CONFIG = {
            // ‰ΩøÁî® WeatherAPI.com ÂÖçË≤ªÊñπÊ°à
            API_KEY: 'demo', // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ API Key
            BASE_URL: 'https://api.weatherapi.com/v1',
            // Êó•ÊúàÊΩ≠Â∫ßÊ®ô
            LOCATION: '23.8647,120.9150', // Êó•ÊúàÊΩ≠ÁöÑÁ∂ìÁ∑ØÂ∫¶
            LOCATION_NAME: 'Êó•ÊúàÊΩ≠'
        };
        
        // Â§©Ê∞£ÂúñÊ®ôÂ∞çÁÖßË°®
        const WEATHER_ICONS = {
            1000: '‚òÄÔ∏è', // Êô¥Â§©
            1003: '‚õÖ', // ÈÉ®ÂàÜÂ§öÈõ≤
            1006: '‚òÅÔ∏è', // Â§öÈõ≤
            1009: '‚òÅÔ∏è', // Èô∞Â§©
            1030: 'üå´Ô∏è', // Èúß
            1063: 'üå¶Ô∏è', // ÂèØËÉΩÊúâÈõ®
            1066: 'üå®Ô∏è', // ÂèØËÉΩÊúâÈõ™
            1069: 'üå®Ô∏è', // ÂèØËÉΩÊúâÈõ®Â§æÈõ™
            1072: 'üå®Ô∏è', // ÂèØËÉΩÊúâÂáçÈõ®
            1087: '‚õàÔ∏è', // ÂèØËÉΩÊúâÈõ∑Èõ®
            1114: '‚ùÑÔ∏è', // ÂêπÈõ™
            1117: '‚ùÑÔ∏è', // Êö¥Èõ™
            1135: 'üå´Ô∏è', // Èúß
            1147: 'üå´Ô∏è', // ÂáçÈúß
            1150: 'üå¶Ô∏è', // Â∞èÈõ®
            1153: 'üå¶Ô∏è', // Â∞èÈõ®
            1168: 'üå®Ô∏è', // ÂáçÈõ®
            1171: 'üå®Ô∏è', // ÈáçÂáçÈõ®
            1180: 'üå¶Ô∏è', // Â∞èÈõ®
            1183: 'üåßÔ∏è', // Â∞èÈõ®
            1186: 'üåßÔ∏è', // ‰∏≠Èõ®
            1189: 'üåßÔ∏è', // ‰∏≠Èõ®
            1192: 'üåßÔ∏è', // Â§ßÈõ®
            1195: 'üåßÔ∏è', // Â§ßÈõ®
            1198: 'üå®Ô∏è', // Â∞èÂáçÈõ®
            1201: 'üå®Ô∏è', // ‰∏≠ÊàñÂ§ßÂáçÈõ®
            1204: 'üå®Ô∏è', // Â∞èÈõ®Â§æÈõ™
            1207: 'üå®Ô∏è', // ‰∏≠ÊàñÂ§ßÈõ®Â§æÈõ™
            1210: '‚ùÑÔ∏è', // Â∞èÈõ™
            1213: '‚ùÑÔ∏è', // Â∞èÈõ™
            1216: '‚ùÑÔ∏è', // ‰∏≠Èõ™
            1219: '‚ùÑÔ∏è', // ‰∏≠Èõ™
            1222: '‚ùÑÔ∏è', // Â§ßÈõ™
            1225: '‚ùÑÔ∏è', // Â§ßÈõ™
            1237: 'üßä', // ÂÜ∞Èõπ
            1240: 'üå¶Ô∏è', // Â∞èÈô£Èõ®
            1243: 'üåßÔ∏è', // ‰∏≠ÊàñÂ§ßÈô£Èõ®
            1246: 'üåßÔ∏è', // Êö¥Èõ®
            1249: 'üå®Ô∏è', // Â∞èÈõ®Â§æÈõ™
            1252: 'üå®Ô∏è', // ‰∏≠ÊàñÂ§ßÈõ®Â§æÈõ™
            1255: '‚ùÑÔ∏è', // Â∞èÈô£Èõ™
            1258: '‚ùÑÔ∏è', // ‰∏≠ÊàñÂ§ßÈô£Èõ™
            1261: 'üßä', // Â∞èÂÜ∞Èõπ
            1264: 'üßä', // ‰∏≠ÊàñÂ§ßÂÜ∞Èõπ
            1273: '‚õàÔ∏è', // Â∞èÈõ∑Èõ®
            1276: '‚õàÔ∏è', // ‰∏≠ÊàñÂ§ßÈõ∑Èõ®
            1279: '‚õàÔ∏è', // Â∞èÈõ∑Èõ®Â§æÈõ™
            1282: '‚õàÔ∏è'  // ‰∏≠ÊàñÂ§ßÈõ∑Èõ®Â§æÈõ™
        };
        
        // ËºâÂÖ•Â§©Ê∞£Ë≥áÊñô
        async function loadWeatherData() {
            try {
                // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
                showWeatherLoading();
                
                // ÊßãÂª∫ API URL
                const currentWeatherUrl = `${WEATHER_CONFIG.BASE_URL}/current.json?key=${WEATHER_CONFIG.API_KEY}&q=${WEATHER_CONFIG.LOCATION}&lang=zh`;
                const forecastUrl = `${WEATHER_CONFIG.BASE_URL}/forecast.json?key=${WEATHER_CONFIG.API_KEY}&q=${WEATHER_CONFIG.LOCATION}&days=3&lang=zh`;
                
                // ÂêåÊôÇË´ãÊ±ÇÁï∂ÂâçÂ§©Ê∞£ÂíåÈ†êÂ†±
                const [currentResponse, forecastResponse] = await Promise.all([
                    fetch(currentWeatherUrl),
                    fetch(forecastUrl)
                ]);
                
                if (!currentResponse.ok || !forecastResponse.ok) {
                    throw new Error('Â§©Ê∞£ API Ë´ãÊ±ÇÂ§±Êïó');
                }
                
                const currentData = await currentResponse.json();
                const forecastData = await forecastResponse.json();
                
                // Êõ¥Êñ∞Â§©Ê∞£È°ØÁ§∫
                updateWeatherDisplay(currentData, forecastData);
                
                // È°ØÁ§∫ÊàêÂäüÁãÄÊÖã
                showWeatherContent();
                
            } catch (error) {
                console.error('ËºâÂÖ•Â§©Ê∞£Ë≥áÊñôÂ§±Êïó:', error);
                
                // Â¶ÇÊûúÊòØ demo keyÔºå‰ΩøÁî®Ê®°Êì¨Ë≥áÊñô
                if (WEATHER_CONFIG.API_KEY === 'demo') {
                    loadMockWeatherData();
                } else {
                    showWeatherError();
                }
            }
        }
        
        // ËºâÂÖ•Ê®°Êì¨Â§©Ê∞£Ë≥áÊñôÔºàÁî®ÊñºÊºîÁ§∫Ôºâ
        function loadMockWeatherData() {
            const mockCurrentData = {
                location: {
                    name: WEATHER_CONFIG.LOCATION_NAME,
                    localtime: new Date().toLocaleString('zh-TW')
                },
                current: {
                    temp_c: 26,
                    condition: {
                        text: 'ÈÉ®ÂàÜÂ§öÈõ≤',
                        code: 1003
                    },
                    humidity: 75,
                    wind_kph: 8.5,
                    vis_km: 10
                }
            };
            
            const mockForecastData = {
                forecast: {
                    forecastday: [
                        {
                            date: new Date().toISOString().split('T')[0],
                            day: {
                                maxtemp_c: 28,
                                mintemp_c: 22,
                                condition: {
                                    text: 'ÈÉ®ÂàÜÂ§öÈõ≤',
                                    code: 1003
                                }
                            }
                        },
                        {
                            date: new Date(Date.now() + 86400000).toISOString().split('T')[0],
                            day: {
                                maxtemp_c: 30,
                                mintemp_c: 24,
                                condition: {
                                    text: 'Êô¥Â§©',
                                    code: 1000
                                }
                            }
                        },
                        {
                            date: new Date(Date.now() + 172800000).toISOString().split('T')[0],
                            day: {
                                maxtemp_c: 27,
                                mintemp_c: 21,
                                condition: {
                                    text: 'Â∞èÈõ®',
                                    code: 1183
                                }
                            }
                        }
                    ]
                }
            };
            
            updateWeatherDisplay(mockCurrentData, mockForecastData);
            showWeatherContent();
        }
        
        // Â§©Ê∞£Âç°ÁâáÊî∂Êë∫ÁãÄÊÖã
        let isWeatherExpanded = true;
        
        // ÂàáÊèõÂ§©Ê∞£Âç°ÁâáÂ±ïÈñã/Êî∂Êë∫
        function toggleWeatherCard() {
            const detailsContainer = document.getElementById('weatherDetailsContainer');
            const summary = document.getElementById('weatherSummary');
            const toggleIcon = document.getElementById('weatherToggleIcon');
            
            if (isWeatherExpanded) {
                // Êî∂Êë∫
                detailsContainer.style.transition = 'all 0.3s ease';
                detailsContainer.style.opacity = '0';
                detailsContainer.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    detailsContainer.style.display = 'none';
                    summary.style.display = 'block';
                    summary.classList.add('show');
                }, 150);
                
                toggleIcon.textContent = '‚ñ∂';
                toggleIcon.style.transform = 'rotate(-90deg)';
                isWeatherExpanded = false;
            } else {
                // Â±ïÈñã
                summary.classList.remove('show');
                summary.style.display = 'none';
                
                detailsContainer.style.display = 'block';
                detailsContainer.style.opacity = '0';
                detailsContainer.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    detailsContainer.style.opacity = '1';
                    detailsContainer.style.transform = 'translateY(0)';
                }, 50);
                
                toggleIcon.textContent = '‚ñº';
                toggleIcon.style.transform = 'rotate(0deg)';
                isWeatherExpanded = true;
            }
        }
        
        // Êõ¥Êñ∞Â§©Ê∞£È°ØÁ§∫
        function updateWeatherDisplay(currentData, forecastData) {
            // Êõ¥Êñ∞Áï∂ÂâçÂ§©Ê∞£ÔºàË©≥Á¥∞È°ØÁ§∫Ôºâ
            const weatherIcon = document.getElementById('weatherIcon');
            const weatherLocation = document.getElementById('weatherLocation');
            const weatherTemp = document.getElementById('weatherTemp');
            const weatherCondition = document.getElementById('weatherCondition');
            const weatherHumidity = document.getElementById('weatherHumidity');
            const weatherWind = document.getElementById('weatherWind');
            const weatherVisibility = document.getElementById('weatherVisibility');
            const weatherUpdateTime = document.getElementById('weatherUpdateTime');
            
            // Êõ¥Êñ∞Á∞°ÂåñÈ°ØÁ§∫
            const weatherIconSummary = document.getElementById('weatherIconSummary');
            const weatherTempSummary = document.getElementById('weatherTempSummary');
            const weatherConditionSummary = document.getElementById('weatherConditionSummary');
            
            const iconCode = currentData.current.condition.code;
            const icon = WEATHER_ICONS[iconCode] || 'üå§Ô∏è';
            const temp = `Ê∫´Â∫¶Ôºö${Math.round(currentData.current.temp_c)}¬∞C`;
            const condition = currentData.current.condition.text;
            
            // Êõ¥Êñ∞Ë©≥Á¥∞È°ØÁ§∫
            if (weatherIcon) {
                weatherIcon.textContent = icon;
            }
            
            if (weatherLocation) {
                weatherLocation.textContent = currentData.location.name || WEATHER_CONFIG.LOCATION_NAME;
            }
            
            if (weatherTemp) {
                weatherTemp.textContent = temp;
            }
            
            if (weatherCondition) {
                weatherCondition.textContent = condition;
            }
            
            if (weatherHumidity) {
                weatherHumidity.textContent = `${currentData.current.humidity}%`;
            }
            
            if (weatherWind) {
                weatherWind.textContent = `${currentData.current.wind_kph} km/h`;
            }
            
            if (weatherVisibility) {
                weatherVisibility.textContent = `${currentData.current.vis_km} km`;
            }
            
            if (weatherUpdateTime) {
                weatherUpdateTime.textContent = `Êõ¥Êñ∞ÊôÇÈñìÔºö${new Date().toLocaleString('zh-TW')}`;
            }
            
            // Êõ¥Êñ∞Á∞°ÂåñÈ°ØÁ§∫
            if (weatherIconSummary) {
                weatherIconSummary.textContent = icon;
            }
            
            if (weatherTempSummary) {
                weatherTempSummary.textContent = temp;
            }
            
            if (weatherConditionSummary) {
                weatherConditionSummary.textContent = condition;
            }
            
            // Êõ¥Êñ∞È†êÂ†±
            const forecastItems = document.getElementById('forecastItems');
            if (forecastItems && forecastData.forecast) {
                forecastItems.innerHTML = '';
                
                forecastData.forecast.forecastday.forEach((day, index) => {
                    if (index === 0) return; // Ë∑≥ÈÅé‰ªäÂ§©
                    
                    const forecastItem = document.createElement('div');
                    forecastItem.className = 'forecast-item';
                    
                    const date = new Date(day.date);
                    const dateStr = index === 1 ? 'ÊòéÂ§©' : index === 2 ? 'ÂæåÂ§©' : `${date.getMonth() + 1}/${date.getDate()}`;
                    
                    const iconCode = day.day.condition.code;
                    const icon = WEATHER_ICONS[iconCode] || 'üå§Ô∏è';
                    
                    forecastItem.innerHTML = `
                        <span class="forecast-date">${dateStr}</span>
                        <span class="forecast-icon">${icon}</span>
                        <span class="forecast-temp">${Math.round(day.day.mintemp_c)}¬∞-${Math.round(day.day.maxtemp_c)}¬∞C</span>
                    `;
                    
                    forecastItems.appendChild(forecastItem);
                });
            }
        }
        
        // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
        function showWeatherLoading() {
            document.getElementById('weatherLoading').style.display = 'block';
            document.getElementById('weatherContent').style.display = 'none';
            document.getElementById('weatherError').style.display = 'none';
        }
        
        // È°ØÁ§∫Â§©Ê∞£ÂÖßÂÆπ
        function showWeatherContent() {
            document.getElementById('weatherLoading').style.display = 'none';
            document.getElementById('weatherContent').style.display = 'block';
            document.getElementById('weatherError').style.display = 'none';
        }
        
        // È°ØÁ§∫ÈåØË™§ÁãÄÊÖã
        function showWeatherError() {
            document.getElementById('weatherLoading').style.display = 'none';
            document.getElementById('weatherContent').style.display = 'none';
            document.getElementById('weatherError').style.display = 'block';
        }
        
        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñÂ§©Ê∞£
        document.addEventListener('DOMContentLoaded', function() {
            // Âª∂ÈÅ≤ËºâÂÖ•Â§©Ê∞£Ë≥áÊñôÔºåÈÅøÂÖçÈòªÂ°ûÈ†ÅÈù¢Ê∏≤Êüì
            setTimeout(() => {
                loadWeatherData();
            }, 1000);
            
            // ÊØè30ÂàÜÈêòÊõ¥Êñ∞‰∏ÄÊ¨°Â§©Ê∞£Ë≥áÊñô
            setInterval(() => {
                loadWeatherData();
            }, 30 * 60 * 1000);
        });
        
    </script>
</body>
</html>
